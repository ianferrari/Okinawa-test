<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>å¥å¥å…¨å®¶æ²–ç¹©éŠ ğŸ¦• V19.2 Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js" defer></script>

    <style>
        /* ================= 1. åŸºç¤èˆ‡æ•ˆèƒ½å„ªåŒ– ================= */
        body { 
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a; 
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s; 
            overscroll-behavior-y: none; 
            -webkit-overflow-scrolling: touch;
            user-select: none;
        }
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿ç•™åŠŸèƒ½ */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* ================= 2. V19 ç»ç’ƒè³ªæ„Ÿ (Glassmorphism) ================= */
        .glass { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-dark { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.95); box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.6); }

        /* ================= 3. V17 åŠŸèƒ½æ¨£å¼ç§»æ¤ (é—œéµä¿®å¾©) ================= */
        
        /* [è¡Œç¨‹æ™‚é–“è»¸] é€£æ¥ç·šèˆ‡è† å›Š (ä¿®å¾©åœ–382) */
        .event-card-container { padding-bottom: 30px; position: relative; }
        .event-card-container:last-child { padding-bottom: 20px; }
        .timeline-connector {
            position: absolute; left: 2.2rem; bottom: 0; height: 100%; width: 2px;
            border-left: 2px dashed #cbd5e1; z-index: 0; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px;
        }
        .event-card-container:last-child .timeline-connector { display: none; }
        .travel-pill {
            background-color: #f1f5f9; border: 1px solid #cbd5e1; color: #64748b;
            font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 99px;
            white-space: nowrap; z-index: 10; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            margin-bottom: 5px; /* èª¿æ•´ä½ç½® */
        }

        /* [éš¨èº«å°ºè¦] (ä¿®å¾©åŠŸèƒ½ç¼ºå¤±) */
        .ruler-container {
            background: #fff; overflow-x: auto; overflow-y: hidden; white-space: nowrap; position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1); border-radius: 8px; border: 1px solid #e2e8f0;
            height: 100px; display: flex; align-items: flex-end; padding-left: 20px; padding-right: 20px;
        }
        .ruler-tick { width: 1px; background: #334155; display: inline-block; flex-shrink: 0; position: relative; }
        .ruler-tick.major { height: 40px; width: 2px; background: #0f172a; }
        .ruler-tick.medium { height: 30px; opacity: 0.8; }
        .ruler-tick.minor { height: 20px; opacity: 0.6; }
        .ruler-num { position: absolute; top: -25px; left: -10px; width: 20px; text-align: center; font-size: 12px; font-weight: bold; }

        /* [å›æ†¶ç›¸æ©Ÿ] (ä¿®å¾©åœ–388/392) */
        .cam-viewport { position: relative; overflow: hidden; background: #000; border-radius: 1.5rem; aspect-ratio: 3/4; width: 100%; }
        #camera-video { width: 100%; height: 100%; object-fit: cover; }
        .cam-overlay-text { position: absolute; bottom: 20px; right: 20px; text-align: right; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.8); pointer-events: none; }
        .cam-date { font-family: monospace; font-weight: bold; font-size: 1rem; color: #fbbf24; }
        .cam-badge { position: absolute; top: 20px; left: 20px; background: #ef4444; color: white; padding: 2px 8px; font-size: 10px; font-weight: bold; transform: rotate(-5deg); box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

        /* [æ‰­è›‹æ©Ÿèˆ‡å‹•ç•«] (ä¿®å¾©æˆå°±é é¢) */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pop { animation: pop 0.3s ease-in-out; }
        .animate-shake { animation: shake 0.3s ease-in-out 3; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* [ç¡¬å¹£æ¨£å¼] */
        .coin-500 { background: radial-gradient(circle at 30% 30%, #fde047, #eab308); border: 2px solid #ca8a04; color: #713f12; }
        .coin-100 { background: radial-gradient(circle at 30% 30%, #f1f5f9, #cbd5e1); border: 2px solid #94a3b8; color: #475569; }
        .coin-50 { background: radial-gradient(circle at 30% 30%, #f1f5f9, #cbd5e1); border: 2px solid #94a3b8; color: #475569; position: relative; }
        .coin-50::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; height: 25%; border: 1px solid #94a3b8; border-radius: 50%; background: #0f172a; }
        .coin-10 { background: radial-gradient(circle at 30% 30%, #fdba74, #ea580c); border: 2px solid #c2410c; color: #7c2d12; }

        /* [UI ç‹€æ…‹é¡åˆ¥] */
        .tab-active { background: rgba(255, 255, 255, 0.95); color: #2563eb; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .tab-inactive { background: rgba(0, 0, 0, 0.3); color: rgba(255, 255, 255, 0.7); }
        body.rainy-mode #bg-layer { filter: grayscale(80%) brightness(0.6); }
        body.rainy-mode .glass-card { border-left: 4px solid #60a5fa !important; }

        /* [å½ˆçª—æ§åˆ¶] */
        .modal { display: none; z-index: 9999; }
        .modal.open { display: flex !important; }
        .pt-safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        .pb-safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom)); }

        /* Toast æç¤º */
        #toast { visibility: hidden; min-width: 200px; transform: translateX(-50%); background-color: rgba(30, 41, 59, 0.95); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 10000; left: 50%; bottom: 120px; font-size: 14px; backdrop-filter: blur(8px); box-shadow: 0 10px 40px rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        #toast.show { visibility: visible; opacity: 1; bottom: 130px; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden relative">
    <div id="bg-layer" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-700 transform scale-105" 
         style="background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=1000&fit=crop');">
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/10 to-slate-100/90"></div>
    </div>

    <div class="z-10 pt-safe-top px-5 pb-2 flex-shrink-0">
        <div class="flex justify-between items-start pt-6 mb-2 text-white">
            <div class="flex-1 mr-2">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-blue-600 px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider uppercase shadow-lg border border-blue-400/30">2026 TRIP</span>
                    <div id="countdown" class="text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10">è¨ˆç®—ä¸­...</div>
                </div>
                <h1 class="text-3xl font-black tracking-tight drop-shadow-lg leading-tight">å¥å¥å…¨å®¶<br>æ²–ç¹©éŠ ğŸ¦•</h1>
                <p id="date-info" class="text-sm opacity-95 font-medium mt-2 text-blue-100 drop-shadow-md"><i class="fas fa-calendar-alt mr-1"></i>3/28 (å…­) - 4/3 (äº”)</p>
            </div>
            
            <div class="flex flex-col items-end gap-2">
                <div class="flex gap-2">
                    <button onclick="toggleRainMode()" id="rain-btn" class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20">
                        <i id="rain-icon" class="fas fa-sun text-xl mb-1 block text-yellow-400"></i>
                        <span id="rain-text" class="text-[9px] font-bold opacity-90">æ™´å¤©</span>
                    </button>
                    <div class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[70px] active:scale-95 transition-transform cursor-pointer" onclick="initWeather()">
                        <i id="weather-icon" class="fas fa-spinner fa-spin text-xl mb-1 block text-blue-300"></i>
                        <span id="weather-temp" class="text-sm font-bold">...</span>
                        <div id="weather-loc" class="text-[9px] opacity-70 mt-0.5">é‡æ•´</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleVoiceMemo()" class="glass-dark w-10 h-10 rounded-full flex items-center justify-center active:bg-pink-500 transition-colors border border-white/20">
                         <i class="fas fa-microphone text-white text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="sub-nav-container" class="mt-2 min-h-[44px]"></div>
    </div>
    
    <div id="main-scroll" class="flex-1 overflow-y-auto p-4 pb-32 z-10 scroll-smooth rounded-t-[2.5rem] bg-slate-50 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] relative top-2">
    </div>

    <div class="fixed bottom-0 w-full glass flex justify-around items-center pb-safe-bottom h-[85px] z-50 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-itinerary">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-map-location-dot text-xl text-blue-600"></i></div>
            <span class="text-[10px] font-bold text-blue-600">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('checklist')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-checklist">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-clipboard-list text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('missions')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-missions">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-medal text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æˆå°±</span>
        </button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-tools">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-toolbox text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">å·¥å…·</span>
        </button>
    </div>

    <button onclick="openQuickExpense()" class="fixed bottom-[100px] right-4 w-14 h-14 bg-pink-500 rounded-full text-white shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform border-4 border-white/20 backdrop-blur group">
        <i class="fas fa-plus text-2xl group-active:rotate-90 transition-transform"></i>
    </button>

    <div id="driver-hud" class="fixed inset-0 bg-black z-[200] hidden flex-col p-6 text-white font-mono transition-opacity duration-300 modal">
        <div class="flex justify-between items-center mb-4 pt-safe-top">
            <div class="flex flex-col">
                <span class="text-xs text-gray-500 uppercase tracking-widest">TIME</span>
                <span id="hud-clock" class="text-2xl font-bold text-gray-300">--:--</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleRoadType()" id="btn-road-type" class="px-4 py-2 rounded-lg border border-blue-900 bg-blue-900/20 text-blue-400 text-sm font-bold active:bg-blue-800 transition-colors">ä¸€èˆ¬ (50)</button>
                <button onclick="closeDriverMode()" class="w-10 h-10 rounded-full bg-red-900/30 text-red-500 border border-red-900/50 flex items-center justify-center active:scale-95"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
        <div class="flex flex-col items-center text-center relative mb-4">
            <div class="w-full">
                <h1 id="hud-title" class="text-3xl font-black text-white leading-tight drop-shadow-md truncate px-2">è¼‰å…¥ä¸­...</h1>
                <div class="my-4 w-full bg-gray-900 rounded-xl border border-gray-800 p-3 relative group active:bg-gray-800 transition-colors cursor-pointer" onclick="copyHudMapCode()">
                    <div class="text-[9px] text-gray-500 tracking-[0.2em] mb-1">MAPCODE</div>
                    <div id="hud-mapcode" class="text-4xl font-black text-yellow-400 tracking-wider font-mono">--- ---</div>
                </div>
                <div class="flex gap-4 justify-center mt-2">
                     <button onclick="changeHudEvent(-1)" class="w-16 h-16 rounded-2xl border border-gray-800 bg-gray-900/80 text-gray-500 flex items-center justify-center active:bg-gray-800 backdrop-blur"><i class="fas fa-chevron-left text-xl"></i></button>
                     <a id="hud-nav-btn" href="#" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-xl font-black py-4 rounded-xl shadow-[0_0_20px_rgba(37,99,235,0.3)] active:scale-[0.98] transition-all flex items-center justify-center gap-3"><i class="fas fa-location-arrow animate-pulse"></i><span>GO å°èˆª</span></a>
                     <button onclick="changeHudEvent(1)" class="w-16 h-16 rounded-2xl border border-gray-700 bg-gray-800/80 text-white flex items-center justify-center active:bg-gray-700 shadow-lg shadow-white/5 backdrop-blur"><i class="fas fa-chevron-right text-xl"></i></button>
                </div>
            </div>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center relative">
            <div class="text-xs text-gray-600 font-bold uppercase tracking-[0.5em] mb-2">SPEED (GPS)</div>
            <div class="flex items-baseline justify-center gap-2 relative">
                <span id="hud-speed" class="text-[9rem] font-black text-white leading-none tracking-tighter transition-all duration-200 drop-shadow-2xl">0</span>
                <span class="text-xl text-gray-500 font-bold absolute -right-12 bottom-8">km/h</span>
            </div>
            <div id="speed-warning" class="opacity-0 transition-opacity duration-300 text-red-500 font-black text-lg mt-2 tracking-widest bg-red-900/30 px-3 py-1 rounded animate-pulse">âš ï¸ SLOW DOWN</div>
        </div>
    </div>

    <div id="hunt-modal" class="fixed inset-0 bg-yellow-50 flex flex-col hidden animate-slide-up modal">
        <div class="flex justify-between items-center p-4 border-b border-yellow-200 bg-yellow-100 pt-safe-top">
            <h3 class="font-black text-xl text-yellow-800"><i class="fas fa-binoculars mr-2"></i>å°‹å¯¶çµäºº</h3>
            <button onclick="closeHunt()" class="w-8 h-8 rounded-full bg-white text-yellow-600 flex items-center justify-center shadow-sm"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 p-6 overflow-y-auto">
            <p class="text-center text-yellow-700 text-sm mb-6 font-bold">åœ¨çª—å¤–çœ‹åˆ°é€™äº›æ±è¥¿å—ï¼Ÿé»æ“Šæ”¶é›†ï¼</p>
            <div class="grid grid-cols-2 gap-4" id="hunt-grid"></div>
            <button onclick="resetHunt()" class="w-full mt-8 py-3 bg-yellow-200 text-yellow-800 rounded-xl font-bold text-sm">é‡ç½®éŠæˆ²</button>
        </div>
    </div>

    <div id="camera-modal" class="fixed inset-0 z-[200] bg-black flex flex-col hidden modal">
        <div class="flex justify-between items-center p-4 z-20 absolute top-0 w-full pt-safe-top">
            <button onclick="toggleCameraFacing()" class="text-white bg-black/30 w-10 h-10 rounded-full backdrop-blur flex items-center justify-center"><i class="fas fa-sync-alt"></i></button>
            <button onclick="closeCamera()" class="text-white bg-black/30 w-10 h-10 rounded-full backdrop-blur flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 flex items-center justify-center bg-black relative">
            <div class="cam-viewport relative">
                <video id="camera-video" autoplay playsinline muted></video>
                <canvas id="camera-canvas" class="hidden"></canvas>
                <div id="cam-overlay" class="absolute inset-0 pointer-events-none hidden">
                    <div class="cam-badge">DAY <span id="cam-day-val">1</span></div>
                    <div class="cam-overlay-text">
                        <div class="cam-date" id="cam-date-val">2026/03/28</div>
                        <div class="cam-loc"><i class="fas fa-map-marker-alt mr-1 text-red-400"></i><span id="cam-loc-val">Okinawa</span></div>
                        <div class="cam-weather"><i class="fas fa-sun mr-1 text-yellow-400"></i><span id="cam-weather-val">24Â°C</span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="h-32 bg-black flex items-center justify-center pb-safe-bottom gap-8">
            <button onclick="takePhoto()" class="w-16 h-16 rounded-full bg-white border-4 border-gray-300 active:scale-90 transition-transform shadow-[0_0_20px_rgba(255,255,255,0.5)]"></button>
        </div>
    </div>

    <div id="ruler-modal" class="fixed inset-0 z-[150] bg-white flex flex-col hidden animate-slide-up modal">
        <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-slate-50 pt-safe-top">
            <h3 class="font-black text-xl text-gray-800"><i class="fas fa-ruler-combined text-blue-500 mr-2"></i>éš¨èº«é‡é‡çœ‹</h3>
            <button onclick="closeRuler()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 flex items-center justify-center"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center p-4 bg-slate-50 relative overflow-hidden">
            <div class="text-center mb-8">
                <div class="text-6xl font-black text-blue-600 mb-2 font-mono" id="ruler-display-val">0.0</div>
                <div class="text-sm text-gray-400 font-bold">cm</div>
            </div>
            <div id="ruler-scroll-area" class="w-full overflow-x-auto hide-scrollbar touch-pan-x bg-white border-y-2 border-blue-200 h-32 relative flex items-end pt-5 shadow-inner">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-0.5 h-full bg-red-500 z-10 opacity-70"></div>
                <div id="ruler-ticks" class="flex items-end pl-[50vw] pr-[50vw]"></div>
            </div>
            <p class="text-xs text-gray-400 mt-4"><i class="fas fa-hand-pointer mr-1"></i> å·¦å³æ»‘å‹•åˆ»åº¦ä¾†æ¸¬é‡</p>
        </div>
        <div class="p-4 bg-white border-t border-gray-100 pb-safe-bottom">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-bold text-gray-500">æ ¡æ­£ (èª¿æ•´æ¯”ä¾‹)</span>
                <button onclick="resetRulerScale()" class="text-[10px] bg-gray-100 px-2 py-1 rounded text-gray-500">é‡ç½®</button>
            </div>
            <input type="range" id="ruler-scale" min="0.5" max="2.0" step="0.01" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="updateRulerScale(this.value)">
        </div>
    </div>

    <div id="drawing-modal" class="fixed inset-0 z-[200] bg-white flex flex-col hidden modal">
        <div class="flex justify-between items-center p-4 border-b border-gray-100 bg-white z-10 pt-safe-top">
            <h3 class="font-black text-xl text-gray-800"><i class="fas fa-palette text-purple-500 mr-2"></i>å°å°ç•«å®¶</h3>
            <button onclick="closeDrawing()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 relative bg-slate-50 overflow-hidden" id="canvas-container">
            <canvas id="drawing-canvas" class="w-full h-full touch-none"></canvas>
        </div>
        <div class="p-4 bg-white border-t border-gray-100 pb-safe-bottom">
            <div class="flex justify-between items-center gap-2">
                <div class="flex gap-2">
                    <button class="color-btn w-8 h-8 rounded-full bg-black ring-2 ring-offset-2 ring-transparent active" onclick="setColor('black', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-red-500 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#ef4444', this)"></button>
                    <button class="color-btn w-8 h-8 rounded-full bg-blue-500 ring-2 ring-offset-2 ring-transparent" onclick="setColor('#3b82f6', this)"></button>
                </div>
                <div class="flex gap-2">
                    <button onclick="clearCanvas()" class="w-10 h-10 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button>
                    <button onclick="saveDrawing()" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg"><i class="fas fa-save"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div id="expense-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6 hidden modal" onclick="closeQuickExpense()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl relative animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-gray-800"><i class="fas fa-bolt text-yellow-400 mr-2"></i>å¿«é€Ÿè¨˜å¸³</h3>
                <button onclick="closeQuickExpense()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="shopping" class="peer sr-only" checked><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-bag-shopping"></i> è³¼ç‰©</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="food" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-utensils"></i> é¤é£²</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="play" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-ticket"></i> å¨›æ¨‚</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="transport" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-car"></i> äº¤é€š</div></label>
                </div>
                <input id="quickExName" type="text" placeholder="å“é …åç¨± (å¦‚: å†°æ·‡æ·‹)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-pink-500">
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                    <input id="quickExPrice" type="number" placeholder="é‡‘é¡ (æ—¥å¹£)" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-8 pr-4 py-3 text-xl font-black text-gray-800 focus:outline-pink-500">
                </div>
                <button onclick="saveQuickExpense()" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-lg mt-2"><i class="fas fa-check mr-2"></i> å„²å­˜é€™ç­†</button>
            </div>
        </div>
    </div>

    <div id="gift-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden modal" onclick="closeGiftModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-5 shadow-2xl relative h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 class="text-lg font-black text-gray-800"><i class="fas fa-gift text-red-500 mr-2"></i>ä¼´æ‰‹ç¦®æ¸…å–®</h3>
                <button onclick="closeGiftModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="gift-list-container" class="flex-1 overflow-y-auto space-y-2 mb-4 hide-scrollbar"></div>
            <div class="border-t pt-4 space-y-3">
                <input id="gift-who" type="text" placeholder="å°è±¡ (å¦‚: é˜¿å¬¤)" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500 font-bold">
                <input id="gift-what" type="text" placeholder="è¦è²·ä»€éº¼?" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500">
                <div class="flex gap-2">
                    <input id="gift-budget" type="number" placeholder="é ç®—(Â¥)" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500">
                    <button onclick="addGift()" class="bg-red-500 text-white font-bold px-6 py-2 rounded-xl shadow-lg active:scale-95 whitespace-nowrap"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sos-card-modal" class="fixed inset-0 bg-red-600 flex flex-col items-center justify-center p-6 text-white hidden text-center animate-pop modal">
        <button onclick="closeSosCard()" class="absolute top-6 right-6 text-white/70 text-4xl hover:text-white pt-safe-top"><i class="fas fa-times-circle"></i></button>
        <div class="mb-8 animate-pulse"><i class="fas fa-exclamation-triangle text-6xl text-yellow-300"></i></div>
        <div class="text-xl font-bold mb-2 opacity-80">æˆ‘æ˜¯å°ç£äººï¼Œè«‹å¹«åŠ©æˆ‘</div>
        <h2 id="sos-jp-text" class="text-4xl sm:text-5xl font-black leading-tight mb-4 bg-white text-red-600 p-4 rounded-xl shadow-xl w-full select-all">åŠ©ã‘ã¦ãã ã•ã„</h2>
        <p id="sos-sub-text" class="text-lg font-bold opacity-90">Please help me.</p>
        <div class="grid grid-cols-2 gap-4 w-full mt-10">
            <button onclick="setSosMsg('sick')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å°å­©ç”Ÿç—…<br>å­ä¾›ãŒç—…æ°—</button>
            <button onclick="setSosMsg('lost')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">è¿·è·¯äº†<br>è¿·å­ã§ã™</button>
            <button onclick="setSosMsg('police')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å ±è­¦<br>è­¦å¯Ÿã‚’å‘¼ã‚“ã§</button>
            <button onclick="setSosMsg('ambulance')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å«æ•‘è­·è»Š<br>æ•‘æ€¥è»Šï¼</button>
        </div>
    </div>

    <div id="spot-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6 hidden modal" onclick="closeSpotModal()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl shadow-2xl relative h-[80vh] flex flex-col animate-slide-up" onclick="event.stopPropagation()">
            <button onclick="closeSpotModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/30 text-white backdrop-blur flex items-center justify-center"><i class="fas fa-times"></i></button>
            <div id="spot-hero" class="h-[200px] bg-cover bg-center rounded-t-3xl relative">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                <div class="absolute bottom-4 left-4 text-white z-10">
                    <h3 id="spot-title" class="text-2xl font-black drop-shadow-md">æ™¯é»åç¨±</h3>
                    <div id="spot-tags" class="flex gap-2 mt-2"></div>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1 pb-safe-bottom">
                <div id="spot-desc" class="text-gray-600 leading-relaxed mb-6 text-sm"></div>
                <div class="bg-blue-50 rounded-xl p-4 mb-4 border border-blue-100">
                    <div class="text-xs font-bold text-blue-500 uppercase mb-2"><i class="fas fa-lightbulb mr-1"></i> å¥å¥çˆ¸ç­†è¨˜ (Tips)</div>
                    <div id="spot-tips" class="text-sm font-bold text-gray-800"></div>
                </div>
                <a id="spot-nav-btn" href="#" target="_blank" class="block w-full bg-blue-600 text-white text-center font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform"><i class="fas fa-location-arrow mr-2"></i> å°èˆªå»é€™è£¡</a>
            </div>
        </div>
    </div>

    <div id="gasha-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col hidden modal" onclick="closeGashaModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative animate-pop" onclick="event.stopPropagation()">
            <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-yellow-400 w-20 h-20 rounded-full flex items-center justify-center text-4xl shadow-lg border-4 border-white">ğŸ‰</div>
            <div class="mt-8">
                <div class="text-sm font-bold text-gray-400 mb-1 uppercase tracking-widest">Congratulations!</div>
                <div class="text-2xl font-black text-gray-900 mb-4">æ­å–œç²å¾—çå‹µ</div>
                <div class="bg-yellow-50 rounded-2xl p-6 border-2 border-yellow-200 mb-6">
                    <div id="gasha-reward-icon" class="text-6xl mb-3 block"></div>
                    <div id="gasha-reward-text" class="text-xl font-bold text-yellow-700"></div>
                </div>
                <button onclick="closeGashaModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold w-full shadow-lg active:scale-95 transition-transform">å¤ªæ£’äº†ï¼æ”¶ä¸‹</button>
            </div>
        </div>
    </div>

    <div id="voice-modal" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center hidden text-white modal">
        <button onclick="closeVoice()" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-white/10 flex items-center justify-center pt-safe-top"><i class="fas fa-times"></i></button>
        <div class="text-center mb-10">
            <div class="text-6xl mb-4 animate-bounce">ğŸ¦–</div>
            <h3 class="text-2xl font-black text-green-400">DINO VOICE</h3>
            <p class="text-gray-400 text-sm">æŒ‰ä½æŒ‰éˆ•èªªè©±ï¼Œè®Šèº«éœ¸ç‹é¾ï¼</p>
        </div>
        <button id="voice-record-btn" class="w-24 h-24 rounded-full bg-red-500 border-4 border-red-700 shadow-[0_0_30px_rgba(239,68,68,0.5)] flex items-center justify-center active:scale-90 transition-transform relative overflow-hidden group">
            <i class="fas fa-microphone text-4xl z-10"></i>
        </button>
    </div>

    <div id="ar-modal" class="fixed inset-0 bg-black flex flex-col hidden modal">
        <button onclick="closeAR()" class="absolute top-safe-top right-4 z-20 text-white bg-black/50 px-4 py-2 rounded-full text-xs font-bold backdrop-blur">é—œé–‰ AR</button>
        <model-viewer 
            src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Velociraptor/glTF-Binary/Velociraptor.glb" 
            ar ar-modes="webxr scene-viewer quick-look" 
            camera-controls auto-rotate shadow-intensity="1" class="w-full h-full">
        </model-viewer>
    </div>

    <div id="toast"><i class="fas fa-check-circle mr-2 text-green-400"></i><span id="toast-msg">å·²è¤‡è£½</span></div>
	<script>
    // ================= [Part 2] è³‡æ–™åº«æ ¸å¿ƒ (DATA CORE) =================
    
    // 1. åŸºç¤è¨­å®šèˆ‡ç‹€æ…‹è®Šæ•¸
    const TRIP_YEAR = 2026;
    let activeTab = 'itinerary';
    let currentDayIdx = 0;
    let currentChecklistFilter = 'pack';
    let currentToolFilter = 'drive'; 
    let isRainyMode = localStorage.getItem('rainy_mode') === 'true';
    
    // åŒ¯ç‡èˆ‡é ç®— (å„ªå…ˆè®€å–ä½¿ç”¨è€…è¨­å®šï¼Œå¦å‰‡ä½¿ç”¨é è¨­å€¼)
    let savedRate = localStorage.getItem('user_rate');
    let CURRENT_RATE = savedRate ? parseFloat(savedRate) : 0.2150;
    let TOTAL_BUDGET = localStorage.getItem('trip_budget') ? parseInt(localStorage.getItem('trip_budget')) : 100000;
    
    // ä½¿ç”¨è€…å„²å­˜è³‡æ–™ (LocalStorage)
    let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
    let taxBasket = [];
    let giftDB = JSON.parse(localStorage.getItem('trip_gifts')) || [];
    let medicalData = JSON.parse(localStorage.getItem('medical_data')) || { name: "", phone: "", hotel: "", allergies: [] };
    let parkingData = JSON.parse(localStorage.getItem('parking_data')) || null;
    let gashaCoinsUsed = localStorage.getItem('gasha_coins_used') ? parseInt(localStorage.getItem('gasha_coins_used')) : 0;
    let huntProgress = JSON.parse(localStorage.getItem('hunt_progress')) || { h1: false, h2: false, h3: false, h4: false };

    // 2. [V19 æ–°å¢] å°‹å¯¶çµäººè³‡æ–™åº«
    const huntDB = [
        { id: "h1", name: "ç´…è‰²è²©è³£æ©Ÿ", icon: "ğŸ¥¤" },
        { id: "h2", name: "é¢¨ç…çˆº (Shisa)", icon: "ğŸ¦" },
        { id: "h3", name: "é»ƒè‰²è»Šç‰Œ", icon: "ğŸš™" },
        { id: "h4", name: "å…¨å®¶ä¾¿åˆ©å•†åº—", icon: "ğŸª" }
    ];

    // 3. [V19 æ–°å¢] Dr. Dino ç—›ç—›ç¿»è­¯è³‡æ–™åº«
    const symptomDB = [
        { icon: "ğŸ¤•", label: "é ­ç—›/ç™¼ç‡’", jp: "ç†±ãŒã‚ã‚Šã¾ã™", speak: "Netsu ga arimasu" },
        { icon: "ğŸ¤®", label: "æƒ³å/è‚šå­ç—›", jp: "åãæ°—ãŒã—ã¾ã™", speak: "Hakike ga shimasu" },
        { icon: "ğŸ¦µ", label: "è·Œå€’æ“¦å‚·", jp: "æ€ªæˆ‘ã‚’ã—ã¾ã—ãŸ", speak: "Kega o shimashita" },
        { icon: "ğŸ¤§", label: "æµé¼»æ°´/æ„Ÿå†’", jp: "é¢¨é‚ªæ°—å‘³ã§ã™", speak: "Kaze gimi desu" }
    ];

    // 4. [V17 é‚„åŸ] æ™¯é»è©³ç´°è³‡æ–™ (ç”¨æ–¼å½ˆçª—)
    const spotInfoDB = {
        "tpe_airport": { title: "å°ä¸­åœ‹éš›æ©Ÿå ´", tags: ["å‡ºç™¼", "æ©Ÿå ´"], image: "https://images.unsplash.com/photo-1570710891163-6d3b5c47248b?w=800", desc: "æ—…ç¨‹çš„èµ·é»ï¼è¨˜å¾—å†æ¬¡æª¢æŸ¥è­·ç…§æ•ˆæœŸã€‚", tips: "ğŸ’¡ å¸¶å°å­©é€šé—œå¯ä»¥èµ°å„ªå…ˆé€šé“ã€‚", map: "å°ä¸­åœ‹éš›æ©Ÿå ´" },
        "oka_airport": { title: "é‚£éœ¸æ©Ÿå ´", tags: ["æŠµé”", "æ‰­è›‹"], image: "https://images.unsplash.com/photo-1542332213-31f87348057f?w=800", desc: "æ²–ç¹©çš„é–€æˆ¶ï¼ä¸€å‡ºä¾†å°±æœ‰æ»¿æ»¿çš„è˜­èŠ±é¦™ã€‚", tips: "ğŸ’¡ åœ‹éš›ç·šèˆ‡åœ‹å…§ç·šç›¸é€£ï¼Œ2F æœ‰çš®å¡ä¸˜ã€‚", map: "é‚£éœ¸æ©Ÿå ´" },
        "ots_rent": { title: "OTS è‡¨ç©ºè±å´", tags: ["ç§Ÿè»Š", "è³¼ç¥¨"], image: "https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?w=800", desc: "å°ç£äººæœ€æ„›çš„ç§Ÿè»Šå…¬å¸ã€‚é€™è£¡æœ‰è³£å„ªæƒ é–€ç¥¨ï¼", tips: "ğŸ’¡ æœ‰æ¨¡æ“¬é§•é§›è‰™å¯ä»¥ç©ï¼Œæª¢æŸ¥ ETC å¡ã€‚", map: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€" },
        "hotel_nago": { title: "Best Western åè­·", tags: ["ä½å®¿", "æµ·æ™¯"], image: "https://images.unsplash.com/photo-1590523277543-a94d2e4eb00b?w=800", desc: "ä½æ–¼åè­·å–œç€¨æµ·ç˜æ—ï¼Œæ¯é–“éƒ½æœ‰ç„¡æ•µæµ·æ™¯ï¼", tips: "ğŸ’¡ æ—©é¤å¯ä»¥çœ‹åˆ°æµ·ï¼Œè¨˜å¾—æ—©é»å»ã€‚", map: "Best Western Okinawa Kouki Beach" },
        "busena": { title: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", tags: ["çœ‹é­š", "ç»ç’ƒèˆ¹"], image: "https://images.unsplash.com/photo-1682687220742-aba13b6e50ba?w=800", desc: "ä¸ç”¨æ¿•èº«å°±èƒ½çœ‹æµ·åº•ä¸–ç•Œï¼å¾©å¤é¯¨é­šèˆ¹ã€‚", tips: "ğŸ’¡ è‹¥é¢¨æµªå¤§æœƒåœé§›ï¼Œå…ˆçœ‹å®˜ç¶²ã€‚", map: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’" },
        "churaumi": { title: "ç¾éº—æµ·æ°´æ—é¤¨", tags: ["å¿…å»", "é¯¨é¯Š"], image: "https://images.unsplash.com/photo-1582967788606-a171f1080ca8?w=800", desc: "æ²–ç¹©åœ°æ¨™ï¼é»‘æ½®ä¹‹æµ·çœ‹é¯¨é¯Šã€‚", tips: "ğŸ’¡ 15:00 æœ‰é¤µé£Ÿç§€ï¼Œå‹™å¿…ææ—©å¡ä½ï¼", map: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨" },
        "dino": { title: "DINO æé¾ PARK", tags: ["æé¾", "æ¢éšª"], image: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?w=800", desc: "åŸå§‹æ£®æ—è£¡è—äº† 80 éš»æœƒå‹•çš„æé¾ï¼", tips: "ğŸ’¡ å»ºè­°ç”¨æ¹å·¾ï¼Œå‡ºå£æ˜¯å¾¡è“å­å¾¡æ®¿ã€‚", map: "DINOæé¾PARK å±±åŸäºç†±å¸¶ä¹‹æ£®" },
        "parco": { title: "PARCO CITY", tags: ["è³¼ç‰©", "é›¨å¤©"], image: "https://images.unsplash.com/photo-1472851294608-415522f96319?w=800", desc: "æµ¦æ·»è¥¿æµ·å²¸æœ€å¤§å•†å ´ï¼Uniqlo, MUJI éƒ½æœ‰ã€‚", tips: "ğŸ’¡ 3F æœ‰å…’ç«¥å€ã€‚åœè»Šå ´å¾ˆå¤§è¨˜å¾—æ‹ç…§ã€‚", map: "SAN-A æµ¦æ·»è¥¿æµ·å²¸ PARCO CITY" },
        "naminoue": { title: "æ³¢ä¸Šå®®", tags: ["ç¥ç¤¾", "æ™¯é»"], image: "https://images.unsplash.com/photo-1599464402636-6c2438883e1c?w=800", desc: "é‚£éœ¸å”¯ä¸€çš„æ²™ç˜ç¥ç¤¾ï¼Œå»ºåœ¨æ‡¸å´–ä¸Šã€‚", tips: "ğŸ’¡ è²·æ›¸åŒ…å¾¡å®ˆï¼Œå»æ©‹ä¸Šæ‹ç…§ã€‚", map: "æ³¢ä¸Šå®®" }
    };

    // èƒŒæ™¯åœ–é…ç½®
    const bgImages = { 
        D1: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800", 
        D2: "https://images.unsplash.com/photo-1582967788606-a171f1080ca8?w=800", 
        D3: "https://images.unsplash.com/photo-1560275619-4662e36fa65c?w=800",
        D4: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?w=800",
        D5: "https://images.unsplash.com/photo-1534234828569-2f2249520468?w=800",
        D6: "https://images.unsplash.com/photo-1472851294608-415522f96319?w=800", // Shopping
        D7: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=800",
        MISSION: "https://images.unsplash.com/photo-1533227297464-9429738d1964?w=800",
        TOOL: "https://images.unsplash.com/photo-1484417894907-623942c8ee29?w=800"
    };

    // 5. [V17 é‚„åŸ] å®Œæ•´ 7 å¤©è¡Œç¨‹è³‡æ–™ (å« Duration & Travel Pill)
    const itineraryDB = [
        { day: "D1", date: "3/28 (å…­)", title: "å•Ÿç¨‹ & é©æ‡‰", highlights: "æ©Ÿå ´è²·å¥¶ / OTSå–è»Š", bg: bgImages.D1, events: [
            { time: "09:00", title: "å¾å®¶è£¡å‡ºç™¼", icon: "fa-house", note: "æª¢æŸ¥è­·ç…§å¸¶äº†æ²’ï¼Ÿ", duration: "1h", travel: "ğŸš— 40åˆ†" },
            { time: "10:00", title: "æŠµé”æ©Ÿå ´", spotId: "tpe_airport", icon: "fa-plane-departure", note: "è¾¦ç†æ‰˜é‹ã€‚", duration: "3h", travel: "âœˆï¸ ç­‰å¾…" },
            { time: "13:15", title: "æ˜Ÿå®‡ JX302 èµ·é£›", icon: "fa-paper-plane", note: "çµ¦å¥å¥åƒè»Ÿç³–å¹³è¡¡è€³å£“ã€‚", duration: "2.5h", travel: "âœˆï¸ é£›è¡Œ" },
            { time: "15:45", title: "æŠµé”é‚£éœ¸æ©Ÿå ´", spotId: "oka_airport", icon: "fa-plane-arrival", note: "å…¥å¢ƒã€æ‹¿è¡Œæã€‚", duration: "1h", travel: "ğŸš¶ æ­¥è¡Œ" },
            { time: "17:00", title: "OTS å–è»Š", spotId: "ots_rent", icon: "fa-car", note: "MapCode: 232 543 502*09", mapcode: "232 543 502*09", lat: 26.1558, lon: 127.6534, duration: "1h", travel: "ğŸš— 60åˆ†" },
            { time: "19:30", title: "é£¯åº— Check-in", spotId: "hotel_nago", icon: "fa-hotel", note: "Best Western åè­·ã€‚", mapcode: "206 473 354*11", lat: 26.5414, lon: 127.9458 }
        ]},
        { day: "D2", date: "3/29 (æ—¥)", title: "åè­·æ¢éšª", highlights: "ç»ç’ƒèˆ¹ / AEON / ç©æ²™", bg: bgImages.D2, events: [
            { time: "09:00", title: "é£¯åº—æ—©é¤", icon: "fa-mug-hot", note: "äº«å—æµ·æ™¯æ—©é¤ã€‚", duration: "1h", travel: "ğŸš— 20åˆ†" },
            { time: "10:00", title: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", spotId: "busena", icon: "fa-ship", note: "æ­ç»ç’ƒèˆ¹çœ‹å°¼è«ï¼", mapcode: "206 442 077*71", lat: 26.5278, lon: 127.9306, duration: "1.5h", travel: "ğŸš— 20åˆ†" },
            { time: "12:00", title: "åˆé¤ï¼šHAMAå£½å¸", icon: "fa-bowl-rice", note: "åè­·åº—ï¼Œå¹³æ¿é»é¤ã€‚", duration: "1h", travel: "ğŸš— 10åˆ†" },
            { time: "13:30", title: "AEON åè­·åº—", icon: "fa-cart-shopping", note: "å¤§å‰µè²·ç©å…·ã€è¶…å¸‚è£œçµ¦ã€‚", mapcode: "206 626 669*52", duration: "2h", travel: "ğŸš— 15åˆ†" },
            { time: "16:00", title: "é£¯åº—æ²™ç˜ç©æ²™", spotId: "hotel_nago", icon: "fa-umbrella-beach", note: "æ‹¿å‡ºå‰›è²·çš„æŒ–æ²™çµ„ã€‚" }
        ]},
        { day: "D3", date: "3/30 (ä¸€)", title: "æµ·æ´‹èˆ‡å¤§æ©‹", highlights: "ç¾éº—æµ· / å¤å®‡åˆ©å³¶", bg: bgImages.D3, events: [
            { time: "09:30", title: "ç¾éº—æµ·æ°´æ—é¤¨", spotId: "churaumi", icon: "fa-fish", note: "åœ P7 åœè»Šå ´ã€‚çœ‹é¯¨é¯Šé¤µé£Ÿç§€ã€‚", mapcode: "553 075 797*77", lat: 26.6943, lon: 127.8779, duration: "3h", travel: "ğŸš— 40åˆ†" },
            { time: "13:30", title: "å¤å®‡åˆ©å¤§æ©‹", icon: "fa-bridge-water", note: "çµ•ç¾å¤å®‡åˆ©è—ã€‚", travel: "ğŸš— 5åˆ†" },
            { time: "14:30", title: "å¤å®‡åˆ©æµ·æ´‹å¡”", icon: "fa-tower-observation", note: "æ­ç„¡äººé³³æ¢¨è»Šä¸Šå±±ã€‚", duration: "1.5h" },
            { time: "18:00", title: "æ™šé¤ï¼šç‡’è‚‰ä¹ƒæˆ‘é‚£éœ¸", icon: "fa-fire-burner", note: "åè­·æ–°é¤¨ï¼Œåƒé˜¿å¤è±¬ã€‚", duration: "2h" }
        ]},
        { day: "D4", date: "3/31 (äºŒ)", title: "æé¾èˆ‡æ£®æ—", highlights: "DINO Park / ç”œç”œåœˆ", bg: bgImages.D4, events: [
            { time: "10:00", title: "DINO æé¾ PARK", spotId: "dino", icon: "fa-dragon", note: "æ‰¾ 80 éš»æé¾ï¼", mapcode: "206 745 056*82", lat: 26.6267, lon: 127.9620, duration: "1.5h", travel: "ğŸš— 5åˆ†" },
            { time: "11:30", title: "åˆé¤ï¼šå¾¡è“å­å¾¡æ®¿", icon: "fa-utensils", note: "å°±åœ¨æé¾å…¬åœ’æ¨“ä¸Šã€‚", duration: "1h" },
            { time: "13:00", title: "å³¶è±†è…ç”œç”œåœˆ", icon: "fa-cookie-bite", note: "è²·å›è»Šä¸Šåƒï¼Œå¥åº·å¥½åƒã€‚", duration: "30m", travel: "ğŸš— 5åˆ†" },
            { time: "15:00", title: "21ä¸–ç´€ä¹‹æ£®å…¬åœ’", icon: "fa-train", note: "å¤§æºœæ»‘æ¢¯æ”¾é›»ã€‚", mapcode: "206 626 779*74", duration: "1.5h" }
        ]},
        { day: "D5", date: "4/01 (ä¸‰)", title: "å‹•ç‰©èˆ‡æ”¾ç©º", highlights: "Neo Park / é£¯åº—æ³³æ± ", bg: bgImages.D5, events: [
            { time: "10:00", title: "Neo Park å‹•æ¤ç‰©åœ’", icon: "fa-crow", note: "æ­å¾©å¤å°ç«è»Šçœ‹é³¥ã€‚", mapcode: "206 689 725*11", lat: 26.5986, lon: 127.9733, duration: "2.5h" },
            { time: "14:00", title: "å›é£¯åº—åˆç¡", spotId: "hotel_nago", icon: "fa-bed", note: "ä¼‘æ¯ä¸€ä¸‹ã€‚", duration: "2h" },
            { time: "16:00", title: "é£¯åº—æ³³æ± /æ²™ç˜", icon: "fa-water", note: "æœ€å¾Œä¸€å¤©ç©æ°´ã€‚", duration: "2h" },
            { time: "18:00", title: "æ™šé¤ï¼šå¤§å®¶ Ufuya", icon: "fa-house-user", note: "ç™¾å¹´å¤å®…åƒç«é‹ (å·²é ç´„)ã€‚", duration: "2h" }
        ]},
        { day: "D6", date: "4/02 (å››)", title: "è³¼ç‰©èˆ‡ç§»å‹•", highlights: "PARCO CITY / åœ‹éš›é€š", bg: bgImages.D6, events: [
            { time: "10:30", title: "é€€æˆ¿å¾€å—", icon: "fa-suitcase-rolling", note: "è¡Œæå…¨ä¸Šè»Šã€‚", travel: "ğŸš— 60åˆ†" },
            { time: "11:30", title: "PARCO CITY", spotId: "parco", icon: "fa-bag-shopping", note: "åˆé¤ & è³¼ç‰© (Uniqlo/é˜¿å¡å°‡)ã€‚", mapcode: "33 339 062*55", duration: "3h", travel: "ğŸš— 30åˆ†" },
            { time: "16:00", title: "é‚£éœ¸ Check-in", icon: "fa-hotel", note: "Daiwa Roynet åœ‹éš›é€šã€‚", lat: 26.2163, lon: 127.6917, duration: "1h" },
            { time: "18:00", title: "åœ‹éš›é€šé€›è¡—", icon: "fa-street-view", note: "æ™šé¤ & è²·ä¼´æ‰‹ç¦®ã€‚", duration: "2h" }
        ]},
        { day: "D7", date: "4/03 (äº”)", title: "ç¥ˆç¦èˆ‡è¿”å®¶", highlights: "æ³¢ä¸Šå®® / Outlet", bg: bgImages.D7, events: [
            { time: "09:20", title: "æ³¢ä¸Šå®®", spotId: "naminoue", icon: "fa-torii-gate", note: "è²·æ›¸åŒ…å¾¡å®ˆã€‚", lat: 26.2206, lon: 127.6713, duration: "1h", travel: "ğŸš— 40åˆ†" },
            { time: "11:10", title: "ASHIBINAA Outlet", icon: "fa-shirt", note: "æœ€å¾Œè¡åˆº & åˆé¤ã€‚", mapcode: "232 544 452*22", duration: "1.5h", travel: "ğŸš— 20åˆ†" },
            { time: "13:00", title: "OTS é‚„è»Š", icon: "fa-gas-pump", note: "è¨˜å¾—åŠ æ»¿æ²¹ï¼", lat: 26.1558, lon: 127.6534, duration: "1h", travel: "ğŸšŒ æ¥é§" },
            { time: "14:00", title: "æŠµé”é‚£éœ¸æ©Ÿå ´", icon: "fa-plane", note: "é€›å…ç¨…åº—ã€‚", duration: "2h" },
            { time: "16:45", title: "èµ·é£›è¿”å°", icon: "fa-paper-plane", note: "å›å®¶å›‰ï¼" }
        ]}
    ];

    // 6. [V17 é‚„åŸ] ç¾é£ŸæŒ‡æŒ‡é€š
    const foodBoardDB = [
        { name: "æ²–ç¹©éºµ", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Okinawa_soba.jpg/640px-Okinawa_soba.jpg", jp: "æ²–ç¸„ãã°", note: "Okinawa Soba" },
        { name: "å¡”å¯é£¯", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Taco_rice.jpg/640px-Taco_rice.jpg", jp: "ã‚¿ã‚³ãƒ©ã‚¤ã‚¹", note: "Taco Rice" },
        { name: "ç‚¸è±¬æ’", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Tonkatsu.jpg/640px-Tonkatsu.jpg", jp: "ã¨ã‚“ã‹ã¤", note: "Tonkatsu" },
        { name: "ç‚’é£¯", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Fried_rice_with_egg%2C_shrimp%2C_and_scallion.jpg/640px-Fried_rice_with_egg%2C_shrimp%2C_and_scallion.jpg", jp: "ãƒãƒ£ãƒ¼ãƒãƒ³", note: "Cha-han" },
        { name: "å…’ç«¥é¤", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Okosama_lunch_by_kawanet.jpg/640px-Okosama_lunch_by_kawanet.jpg", jp: "ãŠå­æ§˜ã‚»ãƒƒãƒˆ", note: "Kids Meal" },
        { name: "å†°é–‹æ°´", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/Glass_of_water.jpg/480px-Glass_of_water.jpg", jp: "ãŠæ°´", note: "Water" }
    ];

    // 7. [V17 é‚„åŸ] å®Œæ•´æ¸…å–®è³‡æ–™
    const defaultChecklistDB = [
        { id: "pack", title: "ğŸ’ è¡Œå‰æ‰“åŒ…", items: [{text: "è­·ç…§ (3æœ¬)"}, {text: "é§•ç…§+è­¯æœ¬"}, {text: "å……é›»å™¨/ç·š"}, {text: "å°¿å¸ƒ/å¥¶ç²‰"}, {text: "å¸¸å‚™è—¥å“"}, {text: "ç©æ²™å·¥å…·"}] },
        { id: "shop", title: "ğŸ›ï¸ è³¼ç‰©å¿…è²·", items: [{text: "åˆåˆ©ä»–å‘½"}, {text: "è‹¥å…ƒéŒ "}, {text: "å¤§å‰µæ³¡æ¾¡çƒ"}, {text: "è¦é¤…"}, {text: "å¹é¢¨æ©Ÿ"}] },
        { id: "return", title: "ğŸš¨ å›ç¨‹é˜²å‘†", items: [{text: "ETCå¡æ‹”äº†å—?"}, {text: "åŠ æ»¿æ²¹äº†å—?"}, {text: "è­·ç…§åœ¨èº«ä¸Š?"}, {text: "åƒåœ¾æ¸…ç©º?"}] }
    ];
    let checklistDB = JSON.parse(localStorage.getItem('trip_checklist_db')) || defaultChecklistDB;

    // 8. [V17 é‚„åŸ] ä»»å‹™è³‡æ–™ (ä¿®å¾©æˆå°±é é¢ç©ºç™½)
    const missionsDB = [
        { id: "m1", title: "æˆ‘æ˜¯èˆ¹é•·", desc: "åœ¨ç»ç’ƒèˆ¹æ‰¾åˆ°å°¼è«", icon: "fa-fish", lat: 26.5278, lon: 127.9306 },
        { id: "m2", title: "æµ·æ´‹éœ¸ä¸»", desc: "è·Ÿå¤§é¯¨é¯Šæ‹åˆç…§", icon: "fa-camera", lat: 26.6943, lon: 127.8779 },
        { id: "m3", title: "å°å°å‹‡è€…", desc: "æ£®æ—æ¢éšªæ‹¯æ•‘æé¾", icon: "fa-dragon", lat: 26.6267, lon: 127.9620 },
        { id: "m4", title: "é³¥é³¥é»å", desc: "æ­å°ç«è»Šæ•¸å‡º3ç¨®é³¥", icon: "fa-crow", lat: 26.5986, lon: 127.9733 },
        { id: "m5", title: "æµ·åº•å°‹å¯¶", desc: "åœ¨é€æ˜åœ°æ¿æ‰¾åˆ°é­š", icon: "fa-water", lat: 26.5278, lon: 127.9306 },
        { id: "m6", title: "èª å¿ƒç¥ˆç¦", desc: "åœ¨ç¥ç¤¾æŠ•ç¡¬å¹£èªªè¬è¬", icon: "fa-hands-praying", lat: 26.2206, lon: 127.6713 }
    ];

    // 9. [V17 é‚„åŸ + V19] å·¥å…·ç®±å®Œæ•´è³‡æ–™
    const toolsDB = {
        drive: [
            { title: "å³é§•å£è¨£", content: "å·¦è½‰å°å½ã€å³è½‰å¤§å½<br>é›¨åˆ·åœ¨å·¦ã€æ–¹å‘ç‡ˆåœ¨å³", color: "bg-blue-50 text-blue-800" },
            { title: "åŠ æ²¹é‡‘å¥", content: "Regular æ»¿æ²¹ (ç´…æ§)<br>ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æº€ã‚¿ãƒ³", color: "bg-orange-50 text-orange-800" }
        ],
        signs: [
            { icon: "ğŸ”»", title: "æ­¢ã¾ã‚Œ (åœ)", desc: "ä¸€å®šè¦å®Œå…¨ç…åœï¼Œæ•¸3ç§’å†é–‹ã€‚", color: "text-red-600" },
            { icon: "â›”", title: "é€²å…¥ç¦æ­¢", desc: "å–®è¡Œé“å‡ºå£ï¼Œä¸å¯é€²å…¥ã€‚", color: "text-red-600" },
            { icon: "ğŸ…¿ï¸", title: "é§è»Šç¦æ­¢", desc: "é•åœç½°æ¬¾å¾ˆé‡ï¼Œè«‹æ‰¾æ”¶è²»åœè»Šå ´ã€‚", color: "text-blue-600" }
        ],
        coins: [
            { val: 500, color: "coin-500", desc: "æœ€å¤§é‡‘å¹£" }, { val: 100, color: "coin-100", desc: "å¸¸ç”¨/æ‰­è›‹" },
            { val: 50, color: "coin-50", desc: "éŠ€è‰²æœ‰æ´" }, { val: 10, color: "coin-10", desc: "éŠ…è‰²" },
            { val: 5, color: "coin-5", desc: "é‡‘è‰²æœ‰æ´" }, { val: 1, color: "coin-1", desc: "é‹å¹£" }
        ],
        orders: [
            { icon: "âŒğŸ§…", title: "ä¸è¦è”¥", jp: "ãƒã‚®æŠœãã§" }, { icon: "âŒğŸ§Š", title: "å»å†°", jp: "æ°·ãªã—ã§" },
            { icon: "ğŸ’³", title: "ç”¨å¡çµå¸³", jp: "ã‚«ãƒ¼ãƒ‰ã§" }, { icon: "ğŸ¥¡", title: "æˆ‘è¦å¤–å¸¶", jp: "æŒã¡å¸°ã‚Šã§" }
        ],
        sizes: [
            { label: "2-3æ­²", h: "90-95cm", shoe: "14-15" }, { label: "4-5æ­²", h: "100-110cm", shoe: "16-17" },
            { label: "6-7æ­²", h: "120cm", shoe: "18-19" }
        ],
        sos: [
            { name: "æ•‘è­·è»Š/ç«è­¦", tel: "119", style: "bg-red-500 text-white" },
            { name: "å ±è­¦ (è»Šç¦)", tel: "110", style: "bg-blue-600 text-white" },
            { name: "OTS ç§Ÿè»Š", tel: "098-856-8877", style: "bg-green-600 text-white" },
            { name: "å¤–äº¤éƒ¨æ€¥é›£", tel: "080-8056-0122", style: "bg-gray-700 text-white" }
        ],
        jp: [
            { label: "ğŸ½ï¸ é¤å»³", items: [{ t: "è«‹çµ¦æˆ‘æ°´", j: "ãŠæ°´ã‚’ãã ã•ã„" }, { t: "æˆ‘è¦çµå¸³", j: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™" }] },
            { label: "ğŸ›ï¸ è³¼ç‰©", items: [{ t: "å¯ä»¥è©¦ç©¿å—?", j: "è©¦ç€ã§ãã¾ã™ã‹?" }, { t: "æœ‰æ–°çš„å—?", j: "æ–°ã—ã„ã®ã¯ã‚ã‚Šã¾ã™ã‹?" }] }
        ]
    };
    
    const allergyDict = { "egg": { label: "é›è›‹", jp: "åµ (Tamago)" }, "milk": { label: "ç‰›å¥¶", jp: "ç‰›ä¹³ (Gyu-nyu)" }, "shrimp": { label: "è¦", jp: "ã‚¨ãƒ“ (Ebi)" } };
    const sosMessages = { sick: { jp: "å­ä¾›ãŒç—…æ°—ã§ã™", en: "Child is sick" }, lost: { jp: "é“ã«è¿·ã„ã¾ã—ãŸ", en: "I am lost" }, police: { jp: "è­¦å¯Ÿã‚’å‘¼ã‚“ã§", en: "Call police" }, ambulance: { jp: "æ•‘æ€¥è»Šï¼", en: "Call Ambulance" } };
    
    // æ‰­è›‹çå‹µé è¨­å€¼
    const defaultRewards = [{ icon: "ğŸ¬", text: "è»Ÿç³–ä¸€é¡†" }, { icon: "ğŸ“º", text: "çœ‹å¡é€š10åˆ†" }, { icon: "ğŸ§¸", text: "è²·ä¸€å€‹ç©å…·" }, { icon: "ğŸ¦", text: "åƒå†°æ·‡æ·‹" }];
    let rewardsDB = JSON.parse(localStorage.getItem('gasha_rewards')) || [...defaultRewards];
    </script>
	// ================= [Part 3] æ ¸å¿ƒé‚è¼¯èˆ‡äº’å‹• (LOGIC CORE) =================

    // 1. åˆå§‹åŒ–èˆ‡å°èˆª
    function init() {
        if(isRainyMode) updateRainyModeUI();
        switchTab('itinerary'); // é è¨­é–‹å•Ÿè¡Œç¨‹é 
        updateCountdown();
        setInterval(updateCountdown, 60000); // æ¯åˆ†é˜æ›´æ–°å€’æ•¸
        initWeather();
        // æ¢å¾© HUD æ™‚é–“æ›´æ–° (ä½†ä¸é–‹å•Ÿç•«é¢)
        setInterval(() => {
            const now = new Date();
            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            const el = document.getElementById('hud-clock');
            if(el) el.innerText = timeStr;
        }, 1000);
    }

    window.switchTab = (tab) => {
        activeTab = tab;
        // æ›´æ–°åº•éƒ¨å°èˆªæŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.nav-btn').forEach(btn => {
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            if (btn.id === `btn-${tab}`) {
                icon.className = icon.className.replace('text-gray-400', 'text-blue-600');
                span.className = 'text-[10px] font-bold text-blue-600';
            } else {
                icon.className = icon.className.replace('text-blue-600', 'text-gray-400');
                span.className = 'text-[10px] font-bold text-gray-400';
            }
        });
        renderHeaderSubNav(); // æ›´æ–°é ‚éƒ¨æ¬¡é¸å–®
        renderContent();      // é‡ç¹ªä¸»å…§å®¹
    }

    // 2. é ‚éƒ¨æ¬¡é¸å–®æ¸²æŸ“
    function renderHeaderSubNav() {
        const container = document.getElementById('sub-nav-container');
        if (activeTab === 'itinerary') {
            // [V17 æ¨£å¼] æ—¥æœŸåˆ‡æ›æŒ‰éˆ•
            container.innerHTML = `<div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar px-2">${itineraryDB.map((d, i) => `<button onclick="currentDayIdx=${i}; renderContent(); renderHeaderSubNav()" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all duration-300 ${i === currentDayIdx ? 'tab-active' : 'tab-inactive'}"><div>${d.date.split(' ')[0]}</div></button>`).join('')}</div>`;
            // æ›´æ–°èƒŒæ™¯åœ–
            document.getElementById('bg-layer').style.backgroundImage = `url('${itineraryDB[currentDayIdx].bg}')`;
        } else if (activeTab === 'checklist') {
            container.innerHTML = `<div class="flex glass-dark p-1 rounded-2xl mx-1">${checklistDB.map(c => `<button id="btn-chk-${c.id}" onclick="switchChecklist('${c.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentChecklistFilter === c.id ? 'bg-white text-blue-600 shadow-sm' : 'text-white/80'}">${c.title.split(' ')[1]}</button>`).join('')}</div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.SHOP}')`;
        } else if (activeTab === 'tools') {
            // [V17+V19] å·¥å…·åˆ†é¡æŒ‰éˆ•
            container.innerHTML = `<div class="flex glass-dark p-1 rounded-2xl mx-1 gap-1 overflow-x-auto hide-scrollbar"><button onclick="switchTool('drive')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='drive'?'bg-white text-blue-600':'text-white/80'}">ğŸš— é§•é§›</button><button onclick="switchTool('eat')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='eat'?'bg-white text-orange-600':'text-white/80'}">ğŸ± åƒå–</button><button onclick="switchTool('fun')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='fun'?'bg-white text-yellow-600':'text-white/80'}">ğŸ¦– å¨›æ¨‚</button><button onclick="switchTool('safe')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='safe'?'bg-white text-red-600':'text-white/80'}">ğŸ›¡ï¸ å®‰å…¨</button></div>`;
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.TOOL}')`;
        } else {
            container.innerHTML = "";
            document.getElementById('bg-layer').style.backgroundImage = `url('${bgImages.MISSION}')`;
        }
    }

    window.switchChecklist = (id) => { currentChecklistFilter = id; renderContent(); renderHeaderSubNav(); }
    window.switchTool = (id) => { currentToolFilter = id; renderContent(); renderHeaderSubNav(); }

    // 3. [é—œéµ] ä¸»å…§å®¹æ¸²æŸ“é‚è¼¯ (The Heart of the App)
    function renderContent() {
        const main = document.getElementById('main-scroll');
        
        // --- A. è¡Œç¨‹é é¢ (Itinerary) ---
        if (activeTab === 'itinerary') {
            const d = itineraryDB[currentDayIdx];
            main.innerHTML = `
            <div class="animate-slide-up tab-content">
                <div class="glass-card rounded-3xl p-5 mb-6 border-l-4 border-blue-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-1">${d.date} ${d.title}</h2>
                    <div class="text-sm text-gray-500"><i class="fas fa-star text-yellow-500 mr-1"></i> ${d.highlights}</div>
                </div>
                <div class="space-y-4 px-1">
                    ${d.events.map((e, idx) => {
                        // [V17 é‚è¼¯] åˆ¤æ–·æ˜¯å¦ç‚ºæœ€å¾Œä¸€å€‹è¡Œç¨‹ï¼Œæ±ºå®šæ˜¯å¦é¡¯ç¤ºé€£æ¥ç·š
                        const isLast = idx === d.events.length - 1;
                        const travelHtml = (e.travel && !isLast) ? `<div class="timeline-connector"><div class="travel-pill">${e.travel}</div></div>` : '<div class="timeline-connector" style="border:none"></div>';
                        
                        return `
                        <div class="relative group event-card-container">
                            <div class="flex gap-4 relative z-10">
                                <div class="flex flex-col items-center min-w-[3.5rem]">
                                    <div class="w-14 h-14 rounded-2xl bg-white border border-slate-200 text-blue-600 flex items-center justify-center text-xl shadow-sm z-10"><i class="fas ${e.icon}"></i></div>
                                </div>
                                <div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-[0.98] transition-transform" ${e.spotId ? `onclick="openSpotModal('${e.spotId}')"` : ''}>
                                    <div class="flex justify-between items-start mb-1">
                                        <h3 class="font-bold text-gray-800 text-lg">${e.time} ${e.title} ${e.spotId ? '<i class="fas fa-circle-info text-xs text-blue-400 ml-1"></i>' : ''}</h3>
                                        ${e.mapcode ? `<button onclick="event.stopPropagation(); copyMapCode('${e.mapcode}')" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded border border-yellow-200 font-bold">MAPCODE</button>` : ''}
                                    </div>
                                    ${e.note ? `<p class="text-xs text-gray-500 bg-slate-50 p-2 rounded-lg mb-1">${e.note}</p>` : ''}
                                    ${e.duration ? `<span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-0.5 rounded font-bold"><i class="fas fa-clock mr-1"></i>åœç•™ ${e.duration}</span>` : ''}
                                </div>
                            </div>
                            ${travelHtml}
                        </div>`;
                    }).join('')}
                </div>
                <div class="h-24"></div>
            </div>`;
        } 
        
        // --- B. æ¸…å–®é é¢ (Checklist) ---
        else if (activeTab === 'checklist') {
            const list = checklistDB.find(c => c.id === currentChecklistFilter);
            main.innerHTML = `
            <div class="animate-slide-up glass-card rounded-3xl p-6 min-h-[60vh] tab-content">
                <h3 class="font-bold text-xl mb-4 text-gray-800 border-b pb-4">${list.title}</h3>
                <div class="space-y-3">
                    ${list.items.map((item, i) => { 
                        const key = `chk_${currentChecklistFilter}_${item.text}`; 
                        const isChecked = localStorage.getItem(key) === '1'; 
                        return `<label class="flex items-center gap-3 p-3 rounded-2xl bg-white border border-slate-100 shadow-sm transition-all active:bg-slate-50"><input type="checkbox" class="w-6 h-6 rounded-lg text-blue-600" ${isChecked ? 'checked' : ''} onchange="toggleCheck('${key}')"><div class="flex-1"><div class="font-bold ${isChecked ? 'text-gray-400 line-through' : 'text-gray-700'}">${item.text}</div>${item.sub ? `<div class="text-[10px] text-gray-400">${item.sub}</div>` : ''}</div><button onclick="deleteChecklistItem(${i})" class="text-gray-300 w-8 h-8 flex items-center justify-center"><i class="fas fa-trash-alt"></i></button></label>`;
                    }).join('')}
                </div>
                <button onclick="addChecklistItem()" class="w-full mt-4 py-3 border-2 border-dashed border-gray-300 rounded-2xl text-gray-500 font-bold"><i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
                <div class="flex gap-2 mt-4">
                    <button onclick="resetChecklist('${currentChecklistFilter}')" class="flex-1 py-3 bg-gray-100 rounded-2xl text-gray-500 font-bold text-xs">é‡ç½®ç‹€æ…‹</button>
                    <button onclick="openGiftModal()" class="flex-[2] py-3 bg-red-50 text-red-500 rounded-2xl font-bold border border-red-100"><i class="fas fa-gift mr-1"></i> ä¼´æ‰‹ç¦®ç®¡ç†</button>
                </div>
            </div>`;
        }

        // --- C. æˆå°±é é¢ (Missions - [ä¿®å¾©] è£œå›æ‰­è›‹æ©Ÿ) ---
        else if (activeTab === 'missions') {
            const balance = getGashaBalance(); // è¨ˆç®—å‰©é¤˜ä»£å¹£
            main.innerHTML = `
            <div class="animate-slide-up space-y-4 tab-content">
                <div id="gasha-machine" class="glass-card rounded-3xl p-6 text-center border-4 border-pink-400 bg-pink-50 relative overflow-hidden">
                    <div class="absolute -left-10 -top-10 w-32 h-32 bg-pink-200 rounded-full opacity-50 blur-xl"></div>
                    <div class="relative z-10">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-xl font-black text-pink-600">ğŸ‰ å¿«æ¨‚æ‰­è›‹æ©Ÿ</h3>
                            <div class="text-[10px] bg-white border border-pink-200 text-pink-400 px-2 py-1 rounded-full font-bold">V19.2 FIXED</div>
                        </div>
                        <div class="text-4xl font-black text-gray-800 mb-2">${balance} <span class="text-sm text-gray-500 font-medium">æšä»£å¹£</span></div>
                        <p class="text-xs text-gray-500 mb-4">æ¯å®Œæˆ 1 å€‹ä»»å‹™ï¼Œå°±èƒ½è½‰ 1 æ¬¡ï¼</p>
                        <button onclick="spinGasha()" ${balance <= 0 ? 'disabled' : ''} class="w-full py-4 rounded-2xl font-bold text-lg shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2 ${balance > 0 ? 'bg-gradient-to-r from-pink-500 to-purple-500 text-white shadow-pink-300/50' : 'bg-gray-200 text-gray-400 cursor-not-allowed'}">${balance > 0 ? '<i class="fas fa-gift animate-bounce"></i> æŠ•å…¥ä»£å¹£è½‰å‹•' : 'å»å®Œæˆä»»å‹™è³ºä»£å¹£ï¼'}</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    ${missionsDB.map(m => {
                        const isDone = localStorage.getItem(m.id) === '1';
                        return `<div onclick="toggleMission('${m.id}')" class="glass-card rounded-3xl p-4 flex flex-col items-center justify-center text-center gap-2 aspect-square relative overflow-hidden transition-all active:scale-95 cursor-pointer ${isDone ? 'border-2 border-yellow-400 bg-yellow-50/90' : 'grayscale opacity-80'}">
                            ${isDone ? '<div class="absolute top-2 right-2 text-yellow-500 text-xl animate-pop"><i class="fas fa-check-circle"></i></div>' : ''}
                            <div class="w-14 h-14 rounded-full ${isDone ? 'bg-yellow-400 text-white' : 'bg-slate-200 text-slate-400'} flex items-center justify-center text-2xl mb-1 shadow-sm"><i class="fas ${m.icon}"></i></div>
                            <div class="font-bold text-slate-800 leading-tight">${m.title}</div>
                            <div class="text-[10px] text-slate-500 leading-tight">${m.desc}</div>
                        </div>`
                    }).join('')}
                </div>
            </div>`;
        }

        // --- D. å·¥å…·é é¢ (Tools - [ä¿®å¾©] è£œå›ç¼ºå¤±æŒ‰éˆ•) ---
        else if (activeTab === 'tools') {
            if (currentToolFilter === 'drive') {
                // é§•é§›æ¨¡å¼: è£œå› "HUD", "æ‰¾å»æ‰€", "å›é£¯åº—", "åœè»Š"
                const parkingPhotoHtml = (parkingData && parkingData.photo) ? `<div class="mt-2 text-[10px] text-green-600">ğŸ“¸ æœ‰ç…§ç‰‡</div>` : '';
                const parkingStatus = parkingData 
                    ? `<div class="bg-green-100 border border-green-300 p-3 rounded-xl mb-2 flex justify-between items-center"><div class="text-green-800 font-bold"><i class="fas fa-square-parking mr-1"></i> ${parkingData.note}</div><button onclick="clearParking()" class="text-red-500 bg-white rounded-full w-6 h-6 flex items-center justify-center"><i class="fas fa-times"></i></button></div>` 
                    : `<button onclick="saveParking()" class="w-full bg-white border border-dashed border-gray-300 text-gray-400 font-bold py-3 rounded-xl mb-2 hover:bg-gray-50"><i class="fas fa-camera mr-1"></i> è¨˜éŒ„åœè»Šä½ç½®</button>`;

                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <button onclick="openDriverMode()" class="w-full bg-gradient-to-r from-slate-800 to-black text-white p-6 rounded-3xl shadow-xl relative overflow-hidden group mb-2">
                        <div class="absolute right-0 top-0 p-6 opacity-20"><i class="fas fa-gauge-high text-7xl"></i></div>
                        <div class="relative z-10 text-left">
                            <h3 class="text-2xl font-black italic">DRIVER HUD</h3>
                            <p class="text-sm text-gray-300 mt-1">é§•é§›å°ˆç”¨å„€è¡¨æ¿</p>
                        </div>
                    </button>
                    
                    ${parkingStatus}

                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="quickSearch('toilets')" class="bg-white p-4 rounded-2xl shadow-sm font-bold text-blue-600 active:scale-95"><i class="fas fa-restroom mr-1"></i> æ‰¾å»æ‰€</button>
                        <button onclick="quickSearch('Lawson')" class="bg-white p-4 rounded-2xl shadow-sm font-bold text-orange-600 active:scale-95"><i class="fas fa-store mr-1"></i> æ‰¾è¶…å•†</button>
                        <button onclick="goBackHotel()" class="bg-white p-4 rounded-2xl shadow-sm font-bold text-purple-600 active:scale-95"><i class="fas fa-bed mr-1"></i> å›é£¯åº—</button>
                        <button onclick="quickSearch('Gas Station')" class="bg-white p-4 rounded-2xl shadow-sm font-bold text-red-600 active:scale-95"><i class="fas fa-gas-pump mr-1"></i> æ‰¾åŠ æ²¹</button>
                    </div>
                    ${toolsDB.drive.map(d => `<div class="p-5 rounded-3xl glass-card ${d.color}"><div class="font-bold opacity-60 text-xs mb-1">${d.title}</div><div class="text-xl font-black">${d.content}</div></div>`).join('')}
                </div>`;
            }
            else if (currentToolFilter === 'eat') {
                // åƒå–æ¨¡å¼: åŒ¯ç‡ + é»é¤æ¿ + è¨˜å¸³
                let taxTotal = taxBasket.reduce((a,b)=>a+b,0);
                let taxDiff = 5500 - taxTotal;
                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <div class="bg-orange-50 border border-orange-200 rounded-3xl p-5">
                        <h3 class="text-lg font-black text-orange-800 mb-4">æ‰‹æŒ‡é»é¤é€š</h3>
                        <div class="grid grid-cols-2 gap-3">
                            ${foodBoardDB.map(f => `<div class="bg-white rounded-xl overflow-hidden shadow-sm active:scale-95 transition-transform" onclick="speak('${f.jp}')"><img src="${f.img}" class="w-full h-24 object-cover"><div class="p-2 text-center font-bold text-gray-700 text-sm">${f.name}</div></div>`).join('')}
                        </div>
                    </div>
                    <div class="glass-card rounded-3xl p-5 text-center border-2 border-yellow-300">
                        <h3 class="text-xs font-bold text-yellow-600 mb-2 uppercase">åŒ¯ç‡æ›ç®— (1 JPY = ${CURRENT_RATE})</h3>
                        <div class="flex gap-4">
                            <div class="bg-blue-50 p-2 rounded-xl border border-blue-100 w-1/2">
                                <input type="number" id="jpyInput" oninput="convertCurrency()" placeholder="æ—¥å¹£" class="w-full text-2xl text-center bg-transparent font-black text-gray-800 p-0 focus:outline-none">
                            </div>
                            <div class="bg-green-50 p-2 rounded-xl border border-green-100 w-1/2 flex items-center justify-center">
                                <div id="twdOutput" class="text-2xl font-black text-green-700">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-3xl p-5 shadow-md border-2 border-pink-100">
                        <div class="flex justify-between items-center mb-2"><h3 class="font-black text-pink-500">å…ç¨…æ¹Šå–®</h3><button onclick="resetTaxBasket()" class="text-xs text-gray-400">æ¸…ç©º</button></div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="taxItemInput" placeholder="è¼¸å…¥é‡‘é¡" class="flex-1 bg-gray-50 rounded-xl px-4 py-2 text-xl font-bold">
                            <button onclick="addTaxItem()" class="bg-pink-500 text-white w-12 rounded-xl font-bold text-2xl">+</button>
                        </div>
                        <div class="text-xs font-bold text-gray-500 mb-1">ç›®å‰: Â¥${taxTotal} ${taxDiff > 0 ? `<span class="text-red-500 ml-2">å·® Â¥${taxDiff}</span>` : '<span class="text-green-500 ml-2">é”æˆ!</span>'}</div>
                        <div class="flex flex-wrap gap-1">${taxBasket.map(p => `<span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold">Â¥${p}</span>`).join('')}</div>
                    </div>
                    <div class="glass-card rounded-3xl p-4">
                        <div class="flex justify-between text-xs font-bold mb-2"><span>ç¸½èŠ±è²»: Â¥${expenses.reduce((a,b)=>a+b.price,0)}</span></div>
                        <button onclick="openQuickExpense()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">è¨˜ä¸€ç­†</button>
                        <div class="mt-4 space-y-2">
                             ${expenses.slice(0, 5).map(e => `<div class="flex justify-between bg-white p-2 rounded-lg border border-slate-50 shadow-sm"><span class="font-bold text-gray-700">${e.name}</span><span class="text-gray-500">Â¥${e.price}</span></div>`).join('')}
                        </div>
                    </div>
                </div>`;
            }
            else if (currentToolFilter === 'fun') {
                // å¨›æ¨‚æ¨¡å¼: å°‹å¯¶ + è®Šè² + AR + å°ºè¦ + ç¿»è­¯
                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-3xl p-5 cursor-pointer active:scale-95 transition-transform" onclick="openHunt()">
                        <div class="flex justify-between items-center mb-2"><h3 class="text-xl font-black text-yellow-800">å°‹å¯¶çµäºº</h3><span class="bg-yellow-200 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full">GO</span></div>
                        <p class="text-sm text-yellow-700 font-medium">è»Šä¸Šä¸ç„¡èŠï¼æ‰¾æ‰¾çª—å¤–æœ‰ä»€éº¼ï¼Ÿ</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openVoice()" class="bg-green-500 text-white p-5 rounded-3xl shadow-lg font-bold text-lg active:scale-95">æé¾è®Šè²</button>
                        <button onclick="openAR()" class="bg-indigo-600 text-white p-5 rounded-3xl shadow-lg font-bold text-lg active:scale-95">AR å¬å–š</button>
                        <button onclick="openRuler()" class="bg-white border-2 border-blue-100 text-blue-600 p-5 rounded-3xl shadow-sm font-bold text-lg active:scale-95">éš¨èº«å°ºè¦</button>
                        <button onclick="openDrawing()" class="bg-white border-2 border-purple-100 text-purple-600 p-5 rounded-3xl shadow-sm font-bold text-lg active:scale-95">ç•«ç•«æ¿</button>
                    </div>
                    <div class="bg-white rounded-3xl p-5 shadow-sm">
                        <h3 class="font-bold text-gray-800 mb-3">ğŸ—£ï¸ å¸¸ç”¨æ—¥èª</h3>
                        <div class="grid grid-cols-2 gap-3">
                            ${toolsDB.jp[0].items.map(i => `<button onclick="speak('${i.j}')" class="bg-gray-50 p-2 rounded-xl text-xs font-bold text-left hover:bg-gray-100">${i.t}</button>`).join('')}
                        </div>
                    </div>
                </div>`;
            }
            else if (currentToolFilter === 'safe') {
                // å®‰å…¨æ¨¡å¼: SOS + è­·ç…§ + é†«é™¢
                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <button onclick="openDrDino()" class="w-full bg-white border-2 border-red-100 rounded-3xl p-5 flex items-center gap-4 active:scale-95"><div class="text-3xl">ğŸ‘¨â€âš•ï¸</div><div class="text-left font-black text-red-600">Dr. Dino ç—›ç—›ç¿»è­¯</div></button>
                    <button onclick="openSosCard()" class="w-full bg-red-600 text-white rounded-3xl p-6 shadow-xl border-4 border-red-500 flex items-center justify-between active:scale-95"><div class="text-left font-black text-2xl">ç·Šæ€¥æ±‚åŠ©å¡</div><i class="fas fa-exclamation-circle text-4xl"></i></button>
                    <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                        <div class="flex justify-between mb-4"><h3 class="font-bold text-gray-800">å…’ç«¥å®‰å¿ƒè­·ç…§</h3><button onclick="toggleEditMedical()" class="text-xs bg-gray-100 px-3 py-1 rounded-full font-bold">ç·¨è¼¯</button></div>
                        <div id="medical-view">
                            <div class="text-2xl font-black text-gray-800 mb-1">${medicalData.name || "æœªå¡«å¯«"}</div>
                            <div class="text-blue-600 font-bold mb-2">ğŸ“ ${medicalData.phone || "è«‹ç·¨è¼¯"}</div>
                            <div class="text-xs text-gray-500">ä½å®¿: ${medicalData.hotel || ""}</div>
                        </div>
                        <div id="medical-edit" class="hidden space-y-3 mt-4">
                            <input id="in-name" type="text" placeholder="å§“å" value="${medicalData.name}" class="w-full p-2 border rounded">
                            <input id="in-phone" type="tel" placeholder="é›»è©±" value="${medicalData.phone}" class="w-full p-2 border rounded">
                            <input id="in-hotel" type="text" placeholder="é£¯åº—" value="${medicalData.hotel}" class="w-full p-2 border rounded">
                            <button onclick="saveMedical()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">å„²å­˜</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${toolsDB.sos.map(s => `<a href="tel:${s.tel}" class="${s.style} p-4 rounded-2xl block text-center font-bold shadow-md flex justify-between px-6"><span>${s.name}</span><span>${s.tel}</span></a>`).join('')}
                    </div>
                </div>`;
            }
        }
    }

    // ================= 4. åŠŸèƒ½å¯¦ä½œç´°ç¯€ =================

    // [Driver HUD] 
    window.openDriverMode = () => {
        document.getElementById('driver-hud').classList.remove('hidden');
        document.getElementById('driver-hud').classList.add('flex');
        updateDriverHUD();
        // å˜—è©¦ä¿æŒè¢å¹•é–‹å•Ÿ
        try { if(navigator.wakeLock) navigator.wakeLock.request('screen'); } catch(e){}
    }
    window.closeDriverMode = () => {
        document.getElementById('driver-hud').classList.add('hidden');
        document.getElementById('driver-hud').classList.remove('flex');
    }
    window.updateDriverHUD = () => {
        const d = itineraryDB[currentDayIdx];
        if(!d) return;
        // é¡¯ç¤ºç•¶å¤©ç¬¬ä¸€å€‹è¡Œç¨‹æ¨™é¡Œ
        document.getElementById('hud-title').innerText = d.events[0]?.title || "è¡Œç¨‹çµæŸ";
        // æŠ“å–ç¬¬ä¸€å€‹æœ‰ MapCode çš„äº‹ä»¶
        const nextSpot = d.events.find(e => e.mapcode);
        document.getElementById('hud-mapcode').innerText = nextSpot ? nextSpot.mapcode : "--- ---";
        
        // æ¨¡æ“¬æ™‚é€Ÿ (è‹¥æœ‰ GPS å‰‡ç”¨ GPS)
        if(navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(p => {
                 const speed = p.coords.speed ? Math.round(p.coords.speed * 3.6) : 0;
                 document.getElementById('hud-speed').innerText = speed;
             });
        }
    }
    window.toggleRoadType = () => {
        const btn = document.getElementById('btn-road-type');
        btn.innerText = btn.innerText.includes('50') ? "é«˜é€Ÿ (80)" : "ä¸€èˆ¬ (50)";
    }
    window.changeHudEvent = (dir) => { showToast("åˆ‡æ›è¡Œç¨‹é» (æ¨¡æ“¬)"); }

    // [Gasha] æ‰­è›‹æ©Ÿé‚è¼¯
    window.spinGasha = () => { 
        if(getGashaBalance()<=0) return; 
        playSound('coin'); 
        document.getElementById('gasha-machine').classList.add('animate-shake'); 
        gashaCoinsUsed++; 
        localStorage.setItem('gasha_coins_used', gashaCoinsUsed); 
        renderContent(); // æ›´æ–°é¤˜é¡é¡¯ç¤º
        setTimeout(()=>{
            document.getElementById('gasha-machine').classList.remove('animate-shake'); 
            const r = defaultRewards[Math.floor(Math.random()*defaultRewards.length)]; 
            document.getElementById('gasha-reward-icon').innerText = r.icon; 
            document.getElementById('gasha-reward-text').innerText = r.text; 
            document.getElementById('gasha-modal').classList.add('open'); 
            playSound('coin');
        }, 800); 
    }
    window.getGashaBalance = () => { 
        let c=0; missionsDB.forEach(m=>{if(localStorage.getItem(m.id)==='1')c++}); 
        let b=c-gashaCoinsUsed; 
        return b < 0 ? 0 : b; 
    }
    window.toggleMission = (id) => { 
        const isDone = localStorage.getItem(id) === '1'; 
        if(!isDone) { 
            localStorage.setItem(id, '1'); 
            playSound('coin'); 
            showToast("ğŸ‰ ä»»å‹™å®Œæˆï¼ç²å¾—ä»£å¹£ï¼"); 
            renderContent(); 
        } 
    }
    window.closeGashaModal = () => document.getElementById('gasha-modal').classList.remove('open');

    // [Hunt] å°‹å¯¶
    window.openHunt = () => { 
        document.getElementById('hunt-grid').innerHTML = huntDB.map(item => `<div class="hunt-card ${huntProgress[item.id] ? 'found' : ''}" onclick="toggleHuntItem('${item.id}')"><div class="hunt-inner"><div class="hunt-front shadow-sm"><div class="text-5xl mb-2 opacity-80">${item.icon}</div><div class="font-bold text-gray-700">${item.name}</div></div><div class="hunt-back shadow-inner"><div class="text-6xl animate-bounce">â­</div><div class="font-black text-yellow-800 mt-2">FOUND!</div></div></div></div>`).join('');
        document.getElementById('hunt-modal').classList.add('open'); 
    }
    window.closeHunt = () => document.getElementById('hunt-modal').classList.remove('open');
    window.toggleHuntItem = (id) => { 
        if (!huntProgress[id]) { 
            huntProgress[id] = true; 
            localStorage.setItem('hunt_progress', JSON.stringify(huntProgress)); 
            openHunt(); playSound('coin'); 
        } 
    }
    window.resetHunt = () => {
        if(confirm("é‡ç½®å°‹å¯¶é€²åº¦ï¼Ÿ")) {
            huntProgress = { h1: false, h2: false, h3: false, h4: false };
            localStorage.setItem('hunt_progress', JSON.stringify(huntProgress));
            openHunt();
        }
    }

    // [Camera & Ruler & Drawing]
    window.openRuler = () => document.getElementById('ruler-modal').classList.add('open');
    window.closeRuler = () => document.getElementById('ruler-modal').classList.remove('open');
    
    // [Modals]
    window.openGiftModal = () => {
        const c = document.getElementById('gift-list-container');
        c.innerHTML = giftDB.map((g, i) => `<div class="flex justify-between p-3 bg-slate-50 rounded-xl mb-2"><div class="font-bold">${g.who}: ${g.what}</div><button onclick="giftDB.splice(${i},1);localStorage.setItem('trip_gifts',JSON.stringify(giftDB));openGiftModal()" class="text-red-500"><i class="fas fa-trash"></i></button></div>`).join('');
        document.getElementById('gift-modal').classList.add('open');
    }
    window.closeGiftModal = () => document.getElementById('gift-modal').classList.remove('open');
    window.openSosCard = () => document.getElementById('sos-card-modal').classList.add('open');
    window.closeSosCard = () => document.getElementById('sos-card-modal').classList.remove('open');
    window.openDrDino = () => {
        document.getElementById('symptom-grid').innerHTML = symptomDB.map(s => `<button onclick="speak('${s.speak}')" class="bg-red-50 p-4 rounded-2xl flex flex-col items-center gap-2 active:bg-red-100"><div class="text-4xl">${s.icon}</div><div class="font-bold text-gray-700">${s.label}</div><div class="text-xs text-red-400">${s.jp}</div></button>`).join('');
        document.getElementById('dr-dino-modal').classList.add('open');
    }
    window.closeDrDino = () => document.getElementById('dr-dino-modal').classList.remove('open');
    window.closeSpotModal = () => document.getElementById('spot-modal').classList.remove('open');
    window.openSpotModal = (id) => {
        const spot = spotInfoDB[id];
        if(spot) {
            document.getElementById('spot-title').innerText = spot.title;
            document.getElementById('spot-hero').style.backgroundImage = `url('${spot.image}')`;
            document.getElementById('spot-desc').innerText = spot.desc;
            document.getElementById('spot-tips').innerText = spot.tips;
            document.getElementById('spot-nav-btn').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.map)}`;
            document.getElementById('spot-modal').classList.add('open');
        }
    }

    // [Utils]
    window.copyMapCode = (c) => navigator.clipboard.writeText(c).then(() => showToast("MapCode å·²è¤‡è£½"));
    window.quickSearch = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
    window.goBackHotel = () => {
        // ç°¡æ˜“åˆ¤æ–·ï¼šDay 1-5 å›åè­·ï¼ŒDay 6-7 å›é‚£éœ¸
        const hotel = currentDayIdx <= 4 ? "Best Western Okinawa Kouki Beach" : "Daiwa Roynet Hotel Naha Kokusai-dori";
        if(confirm(`å°èˆªå›é£¯åº—ï¼Ÿ\nğŸ¨ ${hotel}`)) window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel)}`, '_blank');
    }
    window.speak = (text) => {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ja-JP';
        window.speechSynthesis.speak(u);
    }
    window.playSound = (type) => {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        if (type === 'coin') {
            osc.frequency.setValueAtTime(1200, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(2000, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start(); osc.stop(ctx.currentTime + 0.3);
        }
    }
    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }
    
    // [Checklist]
    window.toggleCheck = (key) => { const v = localStorage.getItem(key); localStorage.setItem(key, v === '1' ? '0' : '1'); renderContent(); }
    window.addChecklistItem = () => { const t = prompt("è¼¸å…¥é …ç›®åç¨±:"); if(t) { checklistDB.find(c => c.id === currentChecklistFilter).items.push({text: t}); localStorage.setItem('trip_checklist_db', JSON.stringify(checklistDB)); renderContent(); }}
    window.deleteChecklistItem = (i) => { if(confirm("åˆªé™¤?")) { checklistDB.find(c => c.id === currentChecklistFilter).items.splice(i, 1); localStorage.setItem('trip_checklist_db', JSON.stringify(checklistDB)); renderContent(); }}
    window.resetChecklist = (id) => { if(confirm("é‡ç½®å‹¾é¸ç‹€æ…‹?")) { checklistDB.find(c => c.id === id).items.forEach(i => localStorage.removeItem(`chk_${id}_${i.text}`)); renderContent(); showToast("å·²é‡ç½®"); }}

    // [Expense]
    window.convertCurrency = () => { const v = parseFloat(document.getElementById('jpyInput').value); if(!isNaN(v)) document.getElementById('twdOutput').innerText = Math.round(v * CURRENT_RATE); }
    window.addTaxItem = () => { const v = parseInt(document.getElementById('taxItemInput').value); if(v>0) { taxBasket.push(v); renderContent(); setTimeout(()=>document.getElementById('taxItemInput').focus(),100); }}
    window.resetTaxBasket = () => { taxBasket = []; renderContent(); }
    window.openQuickExpense = () => document.getElementById('expense-modal').classList.add('open');
    window.closeQuickExpense = () => document.getElementById('expense-modal').classList.remove('open');
    window.saveQuickExpense = () => { const n=document.getElementById('quickExName').value; const p=document.getElementById('quickExPrice').value; if(n&&p) { expenses.unshift({name:n, price:parseInt(p), cat:'shopping'}); localStorage.setItem('trip_expenses', JSON.stringify(expenses)); closeQuickExpense(); showToast("å·²è¨˜å¸³"); }}

    // [Parking]
    window.saveParking = () => { const n = prompt("ä½ç½®å‚™è¨» (å¦‚ B1):"); if(n) { parkingData = {note: n, time: new Date().toTimeString().slice(0,5), photo: null}; localStorage.setItem('parking_data', JSON.stringify(parkingData)); renderContent(); }}
    window.clearParking = () => { if(confirm("æ¸…é™¤?")) { parkingData = null; localStorage.removeItem('parking_data'); renderContent(); }}

    // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    init();
    </script>
</body>
</html>
