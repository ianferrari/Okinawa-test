<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>å¥å¥å…¨å®¶æ²–ç¹©éŠ ğŸ¦• v19.1 FIXED</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        /* ================= 1. åŸºç¤è¨­å®š ================= */
        body { 
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a; 
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.5s; 
            overscroll-behavior-y: none; 
            -webkit-overflow-scrolling: touch;
            user-select: none;
        }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* è£œå›éºå¤±çš„ Tab æ¨£å¼ (ä¿®å¾©åœ–382) */
        .tab-active { background: rgba(255, 255, 255, 0.95); color: #2563eb; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .tab-inactive { background: rgba(0, 0, 0, 0.3); color: rgba(255, 255, 255, 0.7); }
        
        /* Glassmorphism ç»ç’ƒè³ªæ„Ÿ */
        .glass { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-dark { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.95); box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.6); }

        /* é›¨å¤©æ¨¡å¼ç‰¹æ•ˆ */
        body.rainy-mode #bg-layer { filter: grayscale(80%) brightness(0.6); }
        body.rainy-mode .glass-card { border-left: 4px solid #60a5fa !important; }

        /* å‹•ç•«ç‰¹æ•ˆ */
        .tab-content { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        button:active { transform: scale(0.95); transition: transform 0.1s; }
        
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }

        .animate-pop { animation: pop 0.3s ease-in-out; }
        .animate-shake { animation: shake 0.3s ease-in-out; }

        /* å°‹å¯¶å¡ç‰‡ */
        .hunt-card { perspective: 1000px; aspect-ratio: 1; cursor: pointer; }
        .hunt-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .hunt-card.found .hunt-inner { transform: rotateY(180deg); }
        .hunt-front, .hunt-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 1rem; }
        .hunt-front { background: white; border: 2px solid #e2e8f0; }
        .hunt-back { background: #fef08a; transform: rotateY(180deg); border: 2px solid #facc15; color: #854d0e; }

        /* æé¾èªéŸ³æ³¢å½¢ */
        .voice-wave { display: flex; align-items: center; gap: 4px; height: 30px; margin-top: 10px; }
        .voice-bar { width: 4px; background: #ef4444; border-radius: 2px; animation: soundWave 0.5s infinite ease-in-out; height: 10%; }
        @keyframes soundWave { 0%, 100% { height: 10%; } 50% { height: 100%; } }
        
        /* è¼”åŠ©é¡åˆ¥ */
        .pt-safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        .pb-safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        /* å½ˆçª—æ§åˆ¶ */
        #modal-overlay, #expense-modal, #gasha-modal, #reward-editor-modal, #gift-modal, #food-modal, #daily-check-modal, #spot-modal, #sos-card-modal, #drawing-modal, #camera-modal, #ruler-modal, #hunt-modal, #voice-modal, #ar-modal, #dr-dino-modal { 
            display: none; 
            z-index: 9999; /* æé«˜å±¤ç´šé¿å…è¢«æ“‹ä½ */
        }
        .open { display: flex !important; }

        /* Toast */
        #toast { visibility: hidden; min-width: 200px; transform: translateX(-50%); background-color: rgba(30, 41, 59, 0.95); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 10000; left: 50%; bottom: 120px; font-size: 14px; backdrop-filter: blur(8px); box-shadow: 0 10px 40px rgba(0,0,0,0.4); opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        #toast.show { visibility: visible; opacity: 1; bottom: 130px; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden relative">
    <div id="bg-layer" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-700 transform scale-105" 
         style="background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=1000&fit=crop');">
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/10 to-slate-100/90"></div>
    </div>

    <div class="z-10 pt-safe-top px-5 pb-2 flex-shrink-0">
        <div class="flex justify-between items-start pt-6 mb-2 text-white">
            <div class="flex-1 mr-2">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-blue-600 px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider uppercase shadow-lg border border-blue-400/30">2026 TRIP</span>
                    <div id="countdown" class="text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10">è¨ˆç®—ä¸­...</div>
                </div>
                <h1 class="text-3xl font-black tracking-tight drop-shadow-lg leading-tight">å¥å¥å…¨å®¶<br>æ²–ç¹©éŠ ğŸ¦•</h1>
                <p id="date-info" class="text-sm opacity-95 font-medium mt-2 text-blue-100 drop-shadow-md"><i class="fas fa-calendar-alt mr-1"></i>3/28 (å…­) - 4/3 (äº”)</p>
            </div>
            
            <div class="flex flex-col items-end gap-2">
                <div class="flex gap-2">
                    <button onclick="toggleRainMode()" id="rain-btn" class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20">
                        <i id="rain-icon" class="fas fa-sun text-xl mb-1 block text-yellow-400"></i>
                        <span id="rain-text" class="text-[9px] font-bold opacity-90">æ™´å¤©</span>
                    </button>
                    <div class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[70px] active:scale-95 transition-transform cursor-pointer" onclick="initWeather()">
                        <i id="weather-icon" class="fas fa-spinner fa-spin text-xl mb-1 block text-blue-300"></i>
                        <span id="weather-temp" class="text-sm font-bold">...</span>
                        <div id="weather-loc" class="text-[9px] opacity-70 mt-0.5">é‡æ•´</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleUVGuard()" id="uv-btn" class="glass-dark w-10 h-10 rounded-full flex items-center justify-center active:scale-90 transition-all border border-white/20 relative">
                        <i class="fas fa-shield-virus text-white text-sm"></i>
                        <div id="uv-badge" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></div>
                    </button>
                    <button onclick="toggleVoiceMemo()" class="glass-dark w-10 h-10 rounded-full flex items-center justify-center active:bg-pink-500 transition-colors border border-white/20">
                         <i class="fas fa-microphone text-white text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="sub-nav-container" class="mt-2 min-h-[44px]"></div>
    </div>
    
    <div id="main-scroll" class="flex-1 overflow-y-auto p-4 pb-32 z-10 scroll-smooth rounded-t-[2.5rem] bg-slate-50 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] relative top-2">
    </div>

    <div class="fixed bottom-0 w-full glass flex justify-around items-center pb-safe-bottom h-[85px] z-50 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-itinerary">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-map-location-dot text-xl text-blue-600"></i></div>
            <span class="text-[10px] font-bold text-blue-600">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('checklist')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-checklist">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-clipboard-list text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('missions')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-missions">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-medal text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æˆå°±</span>
        </button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-tools">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-toolbox text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">å·¥å…·</span>
        </button>
    </div>

    <button onclick="openQuickExpense()" class="fixed bottom-[100px] right-4 w-14 h-14 bg-pink-500 rounded-full text-white shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform border-4 border-white/20 backdrop-blur group">
        <i class="fas fa-plus text-2xl group-active:rotate-90 transition-transform"></i>
    </button>

    <div id="hunt-modal" class="fixed inset-0 bg-yellow-50 flex flex-col hidden animate-slide-up">
        <div class="flex justify-between items-center p-4 border-b border-yellow-200 bg-yellow-100 pt-safe-top">
            <h3 class="font-black text-xl text-yellow-800"><i class="fas fa-binoculars mr-2"></i>å°‹å¯¶çµäºº</h3>
            <button onclick="closeHunt()" class="w-8 h-8 rounded-full bg-white text-yellow-600 flex items-center justify-center shadow-sm"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 p-6 overflow-y-auto">
            <p class="text-center text-yellow-700 text-sm mb-6 font-bold">åœ¨çª—å¤–çœ‹åˆ°é€™äº›æ±è¥¿å—ï¼Ÿé»æ“Šæ”¶é›†ï¼</p>
            <div class="grid grid-cols-2 gap-4" id="hunt-grid"></div>
            <button onclick="resetHunt()" class="w-full mt-8 py-3 bg-yellow-200 text-yellow-800 rounded-xl font-bold text-sm">é‡ç½®éŠæˆ²</button>
        </div>
    </div>

    <div id="voice-modal" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center hidden text-white">
        <button onclick="closeVoice()" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-white/10 flex items-center justify-center pt-safe-top"><i class="fas fa-times"></i></button>
        <div class="text-center mb-10">
            <div class="text-6xl mb-4 animate-bounce">ğŸ¦–</div>
            <h3 class="text-2xl font-black text-green-400">DINO VOICE</h3>
            <p class="text-gray-400 text-sm">æŒ‰ä½æŒ‰éˆ•èªªè©±ï¼Œè®Šèº«éœ¸ç‹é¾ï¼</p>
        </div>
        <div id="voice-visualizer" class="h-16 flex items-center justify-center gap-1 mb-10 opacity-0 transition-opacity">
            <div class="voice-bar"></div><div class="voice-bar" style="animation-delay: 0.1s"></div>
            <div class="voice-bar" style="animation-delay: 0.2s"></div><div class="voice-bar" style="animation-delay: 0.3s"></div>
        </div>
        <button id="voice-record-btn" class="w-24 h-24 rounded-full bg-red-500 border-4 border-red-700 shadow-[0_0_30px_rgba(239,68,68,0.5)] flex items-center justify-center active:scale-90 transition-transform relative overflow-hidden group">
            <i class="fas fa-microphone text-4xl z-10"></i>
            <div class="absolute inset-0 bg-red-600 scale-0 group-active:scale-100 transition-transform rounded-full"></div>
        </button>
        <p class="mt-4 text-xs text-gray-500 font-bold">Hold to Record</p>
    </div>

    <div id="ar-modal" class="fixed inset-0 bg-black flex flex-col hidden">
        <button onclick="closeAR()" class="absolute top-safe-top right-4 z-20 text-white bg-black/50 px-4 py-2 rounded-full text-xs font-bold backdrop-blur">é—œé–‰ AR</button>
        <model-viewer 
            src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Velociraptor/glTF-Binary/Velociraptor.glb" 
            ar ar-modes="webxr scene-viewer quick-look" 
            camera-controls auto-rotate shadow-intensity="1" class="w-full h-full">
        </model-viewer>
    </div>

    <div id="dr-dino-modal" class="fixed inset-0 bg-white flex flex-col hidden animate-slide-up">
        <div class="bg-red-50 p-6 rounded-b-[2rem] shadow-sm text-center pt-safe-top">
            <div class="flex justify-between items-start mb-2">
                <div class="w-8"></div>
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-3xl shadow-sm mx-auto mb-2">ğŸ‘¨â€âš•ï¸</div>
                <button onclick="closeDrDino()" class="w-8 h-8 rounded-full bg-white text-red-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <h3 class="text-xl font-black text-red-600">Dr. Dino ç—›ç—›ç¿»è­¯</h3>
            <p class="text-xs text-red-400">é»æ“Šéƒ¨ä½ï¼Œå¹«ä½ èªªå‡ºç—‡ç‹€</p>
        </div>
        <div class="flex-1 p-6 overflow-y-auto">
            <div class="grid grid-cols-2 gap-4" id="symptom-grid"></div>
        </div>
    </div>

    <div id="driver-hud" class="fixed inset-0 bg-black z-[200] hidden flex-col p-6 text-white font-mono transition-opacity duration-300">
        <div class="flex justify-between items-center mb-4 pt-safe-top">
            <div class="flex flex-col">
                <span class="text-xs text-gray-500 uppercase tracking-widest">TIME</span>
                <span id="hud-clock" class="text-2xl font-bold text-gray-300">12:30</span>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleRoadType()" id="btn-road-type" class="px-4 py-2 rounded-lg border border-blue-900 bg-blue-900/20 text-blue-400 text-sm font-bold active:bg-blue-800 transition-colors">ä¸€èˆ¬ (50)</button>
                <button onclick="closeDriverMode()" class="w-10 h-10 rounded-full bg-red-900/30 text-red-500 border border-red-900/50 flex items-center justify-center active:scale-95"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
        <div class="flex flex-col items-center text-center relative mb-4">
            <div class="w-full">
                <h1 id="hud-title" class="text-3xl font-black text-white leading-tight drop-shadow-md truncate px-2">è¼‰å…¥ä¸­...</h1>
                <div class="my-4 w-full bg-gray-900 rounded-xl border border-gray-800 p-3 relative group active:bg-gray-800 transition-colors cursor-pointer" onclick="copyHudMapCode()">
                    <div class="text-[9px] text-gray-500 tracking-[0.2em] mb-1">MAPCODE</div>
                    <div id="hud-mapcode" class="text-4xl font-black text-yellow-400 tracking-wider font-mono">--- ---</div>
                </div>
                <div class="flex gap-4 justify-center mt-2">
                     <button onclick="changeHudEvent(-1)" class="w-16 h-16 rounded-2xl border border-gray-800 bg-gray-900/80 text-gray-500 flex items-center justify-center active:bg-gray-800 backdrop-blur"><i class="fas fa-chevron-left text-xl"></i></button>
                     <a id="hud-nav-btn" href="#" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white text-xl font-black py-4 rounded-xl shadow-[0_0_20px_rgba(37,99,235,0.3)] active:scale-[0.98] transition-all flex items-center justify-center gap-3"><i class="fas fa-location-arrow animate-pulse"></i><span>GO å°èˆª</span></a>
                     <button onclick="changeHudEvent(1)" class="w-16 h-16 rounded-2xl border border-gray-700 bg-gray-800/80 text-white flex items-center justify-center active:bg-gray-700 shadow-lg shadow-white/5 backdrop-blur"><i class="fas fa-chevron-right text-xl"></i></button>
                </div>
            </div>
        </div>
        <div class="flex-1 flex flex-col justify-center items-center relative">
            <div class="text-xs text-gray-600 font-bold uppercase tracking-[0.5em] mb-2">SPEED (GPS)</div>
            <div class="flex items-baseline justify-center gap-2 relative">
                <span id="hud-speed" class="text-[9rem] font-black text-white leading-none tracking-tighter transition-all duration-200 drop-shadow-2xl">0</span>
                <span class="text-xl text-gray-500 font-bold absolute -right-12 bottom-8">km/h</span>
            </div>
            <div id="speed-warning" class="opacity-0 transition-opacity duration-300 text-red-500 font-black text-lg mt-2 tracking-widest bg-red-900/30 px-3 py-1 rounded animate-pulse">âš ï¸ SLOW DOWN</div>
        </div>
    </div>

    <div id="sos-card-modal" class="fixed inset-0 bg-red-600 flex flex-col items-center justify-center p-6 text-white hidden text-center animate-pop">
        <button onclick="closeSosCard()" class="absolute top-6 right-6 text-white/70 text-4xl hover:text-white pt-safe-top"><i class="fas fa-times-circle"></i></button>
        <div class="mb-8 animate-pulse"><i class="fas fa-exclamation-triangle text-6xl text-yellow-300"></i></div>
        <div class="text-xl font-bold mb-2 opacity-80">æˆ‘æ˜¯å°ç£äººï¼Œè«‹å¹«åŠ©æˆ‘</div>
        <h2 id="sos-jp-text" class="text-4xl sm:text-5xl font-black leading-tight mb-4 bg-white text-red-600 p-4 rounded-xl shadow-xl w-full select-all">åŠ©ã‘ã¦ãã ã•ã„</h2>
        <p id="sos-sub-text" class="text-lg font-bold opacity-90">Please help me.</p>
        <div class="grid grid-cols-2 gap-4 w-full mt-10">
            <button onclick="setSosMsg('sick')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å°å­©ç”Ÿç—…<br>å­ä¾›ãŒç—…æ°—</button>
            <button onclick="setSosMsg('lost')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">è¿·è·¯äº†<br>è¿·å­ã§ã™</button>
            <button onclick="setSosMsg('police')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å ±è­¦<br>è­¦å¯Ÿã‚’å‘¼ã‚“ã§</button>
            <button onclick="setSosMsg('ambulance')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å«æ•‘è­·è»Š<br>æ•‘æ€¥è»Šï¼</button>
        </div>
    </div>

    <div id="gift-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden" onclick="closeGiftModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-5 shadow-2xl relative h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 class="text-lg font-black text-gray-800"><i class="fas fa-gift text-red-500 mr-2"></i>ä¼´æ‰‹ç¦®æ¸…å–®</h3>
                <button onclick="closeGiftModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="gift-list-container" class="flex-1 overflow-y-auto space-y-2 mb-4 hide-scrollbar">
                </div>
            <div class="border-t pt-4 space-y-3">
                <input id="gift-who" type="text" placeholder="å°è±¡ (å¦‚: é˜¿å¬¤)" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500 font-bold">
                <input id="gift-what" type="text" placeholder="è¦è²·ä»€éº¼?" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500">
                <div class="flex gap-2">
                    <input id="gift-budget" type="number" placeholder="é ç®—(Â¥)" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500">
                    <button onclick="addGift()" class="bg-red-500 text-white font-bold px-6 py-2 rounded-xl shadow-lg active:scale-95 whitespace-nowrap"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="expense-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6 hidden" onclick="closeQuickExpense()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl relative animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-gray-800"><i class="fas fa-bolt text-yellow-400 mr-2"></i>å¿«é€Ÿè¨˜å¸³</h3>
                <button onclick="closeQuickExpense()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="shopping" class="peer sr-only" checked><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-bag-shopping"></i> è³¼ç‰©</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="food" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-utensils"></i> é¤é£²</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="play" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-ticket"></i> å¨›æ¨‚</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="transport" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all font-bold flex items-center gap-1 whitespace-nowrap"><i class="fas fa-car"></i> äº¤é€š</div></label>
                </div>
                <input id="quickExName" type="text" placeholder="å“é …åç¨± (å¦‚: å†°æ·‡æ·‹)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-pink-500">
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                    <input id="quickExPrice" type="number" placeholder="é‡‘é¡ (æ—¥å¹£)" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-8 pr-4 py-3 text-xl font-black text-gray-800 focus:outline-pink-500">
                </div>
                <button onclick="saveQuickExpense()" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-lg mt-2"><i class="fas fa-check mr-2"></i> å„²å­˜é€™ç­†</button>
            </div>
        </div>
    </div>
    
    <div id="modal-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col hidden" onclick="closeModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-8 text-center shadow-2xl relative" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800"><i class="fas fa-times text-2xl"></i></button>
            <div id="modal-tag" class="text-sm font-bold text-gray-500 mb-2 uppercase tracking-widest">çµ¦å¸æ©Ÿçœ‹ (For Driver)</div>
            <div id="modal-title" class="text-2xl font-black text-gray-900 mb-6 border-b pb-4">ã“ã®ãƒ›ãƒ†ãƒ«ã¾ã§<br>ãŠé¡˜ã„ã—ã¾ã™</div>
            <div id="modal-content" class="text-xl font-bold text-blue-700 mb-2"></div>
            <div id="modal-note" class="text-xs text-gray-400">è«‹å¸¶æˆ‘å»é€™å®¶é£¯åº—</div>
            <div class="mt-8"><button onclick="closeModal()" class="bg-gray-100 text-gray-600 px-6 py-3 rounded-xl font-bold w-full">é—œé–‰</button></div>
        </div>
    </div>

    <div id="spot-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6 hidden" onclick="closeSpotModal()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl shadow-2xl relative h-[80vh] flex flex-col animate-slide-up" onclick="event.stopPropagation()">
            <button onclick="closeSpotModal()" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full bg-black/30 text-white backdrop-blur flex items-center justify-center"><i class="fas fa-times"></i></button>
            <div id="spot-hero" class="h-[200px] bg-cover bg-center rounded-t-3xl relative">
                <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>
                <div class="absolute bottom-4 left-4 text-white z-10">
                    <h3 id="spot-title" class="text-2xl font-black drop-shadow-md">æ™¯é»åç¨±</h3>
                    <div id="spot-tags" class="flex gap-2 mt-2"></div>
                </div>
            </div>
            <div class="p-6 overflow-y-auto flex-1 pb-safe-bottom">
                <div id="spot-desc" class="text-gray-600 leading-relaxed mb-6 text-sm"></div>
                <div class="bg-blue-50 rounded-xl p-4 mb-4 border border-blue-100">
                    <div class="text-xs font-bold text-blue-500 uppercase mb-2"><i class="fas fa-lightbulb mr-1"></i> å¥å¥çˆ¸ç­†è¨˜ (Tips)</div>
                    <div id="spot-tips" class="text-sm font-bold text-gray-800"></div>
                </div>
                <a id="spot-nav-btn" href="#" target="_blank" class="block w-full bg-blue-600 text-white text-center font-bold py-3 rounded-xl shadow-lg active:scale-95 transition-transform"><i class="fas fa-location-arrow mr-2"></i> å°èˆªå»é€™è£¡</a>
            </div>
        </div>
    </div>

    <div id="toast"><i class="fas fa-check-circle mr-2 text-green-400"></i><span id="toast-msg">å·²è¤‡è£½</span></div>

    <script>
    // ================= 1. è³‡æ–™åº«èˆ‡è¨­å®š (DATA & CONFIG) =================
    const TRIP_YEAR = 2026;
    let activeTab = 'itinerary';
    let currentDayIdx = 0;
    let currentChecklistFilter = 'pack';
    let currentToolFilter = 'drive'; 
    let isRainyMode = localStorage.getItem('rainy_mode') === 'true';
    let isUVGuardOn = false;
    let uvTimer = null;
    
    // åŒ¯ç‡èˆ‡é ç®— (ä¿®å¾©: è¨­å®šé è¨­å€¼é˜²æ­¢ API å¤±æ•—æ™‚ç©ºç™½)
    let savedRate = localStorage.getItem('user_rate');
    let CURRENT_RATE = savedRate ? parseFloat(savedRate) : 0.2150;
    let TOTAL_BUDGET = localStorage.getItem('trip_budget') ? parseInt(localStorage.getItem('trip_budget')) : 100000;
    
    // ä½¿ç”¨è€…è³‡æ–™ (LocalStorage)
    let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
    let taxBasket = [];
    let giftDB = JSON.parse(localStorage.getItem('trip_gifts')) || [];
    let medicalData = JSON.parse(localStorage.getItem('medical_data')) || { name: "", phone: "", hotel: "", allergies: [] };
    let parkingData = JSON.parse(localStorage.getItem('parking_data')) || null;
    let gashaCoinsUsed = localStorage.getItem('gasha_coins_used') ? parseInt(localStorage.getItem('gasha_coins_used')) : 0;
    let huntProgress = JSON.parse(localStorage.getItem('hunt_progress')) || { h1: false, h2: false, h3: false, h4: false };

    // --- è³‡æ–™åº« (ç°¡åŒ–ç‰ˆï¼Œç¢ºä¿ä¸ç¼ºæ¼) ---
    const huntDB = [
        { id: "h1", name: "ç´…è‰²è²©è³£æ©Ÿ", icon: "ğŸ¥¤" },
        { id: "h2", name: "é¢¨ç…çˆº", icon: "ğŸ¦" },
        { id: "h3", name: "é»ƒè‰²è»Šç‰Œ", icon: "ğŸš™" },
        { id: "h4", name: "å…¨å®¶ä¾¿åˆ©å•†åº—", icon: "ğŸª" }
    ];

    const symptomDB = [
        { icon: "ğŸ¤•", label: "é ­ç—›/ç™¼ç‡’", jp: "ç†±ãŒã‚ã‚Šã¾ã™", speak: "Netsu ga arimasu" },
        { icon: "ğŸ¤®", label: "æƒ³å/è‚šå­ç—›", jp: "åãæ°—ãŒã—ã¾ã™", speak: "Hakike ga shimasu" },
        { icon: "ğŸ¦µ", label: "è·Œå€’æ“¦å‚·", jp: "æ€ªæˆ‘ã‚’ã—ã¾ã—ãŸ", speak: "Kega o shimashita" },
        { icon: "ğŸ¤§", label: "æµé¼»æ°´/æ„Ÿå†’", jp: "é¢¨é‚ªæ°—å‘³ã§ã™", speak: "Kaze gimi desu" }
    ];

    const toolsDB = {
        drive: [
            { title: "å³é§•å£è¨£", content: "å·¦è½‰å°å½ã€å³è½‰å¤§å½<br>é›¨åˆ·åœ¨å·¦ã€æ–¹å‘ç‡ˆåœ¨å³", color: "bg-blue-50 text-blue-800" },
            { title: "åŠ æ²¹é‡‘å¥", content: "Regular æ»¿æ²¹ (ç´…æ§)<br>ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æº€ã‚¿ãƒ³", color: "bg-orange-50 text-orange-800" }
        ],
        signs: [
            { icon: "ğŸ”»", title: "æ­¢ã¾ã‚Œ (åœ)", desc: "ä¸€å®šè¦å®Œå…¨ç…åœï¼Œæ•¸3ç§’å†é–‹ã€‚", color: "text-red-600" },
            { icon: "â›”", title: "é€²å…¥ç¦æ­¢", desc: "å–®è¡Œé“å‡ºå£ï¼Œä¸å¯é€²å…¥ã€‚", color: "text-red-600" }
        ],
        coins: [
            { val: 500, color: "coin-500", desc: "æœ€å¤§é‡‘å¹£" }, { val: 100, color: "coin-100", desc: "å¸¸ç”¨/æ‰­è›‹" },
            { val: 50, color: "coin-50", desc: "éŠ€è‰²æœ‰æ´" }, { val: 10, color: "coin-10", desc: "éŠ…è‰²" }
        ],
        orders: [
            { icon: "âŒğŸ§…", title: "ä¸è¦è”¥", jp: "ãƒã‚®æŠœãã§" }, { icon: "âŒğŸ§Š", title: "å»å†°", jp: "æ°·ãªã—ã§" }
        ],
        sizes: [
            { label: "2-3æ­²", h: "90-95cm", shoe: "14-15" }, { label: "4-5æ­²", h: "100-110cm", shoe: "16-17" }
        ],
        sos: [
            { name: "æ•‘è­·è»Š/ç«è­¦", tel: "119", style: "bg-red-500 text-white" },
            { name: "å ±è­¦", tel: "110", style: "bg-blue-600 text-white" },
            { name: "OTS ç§Ÿè»Š", tel: "098-856-8877", style: "bg-green-600 text-white" }
        ]
    };

    // èƒŒæ™¯åœ– (ä½¿ç”¨ Unsplash é€£çµï¼Œè‹¥ç ´åœ–å¯æ›¿æ›)
    const bgImages = { D1: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=800", SHOP: "https://images.unsplash.com/photo-1472851294608-415522f96319?w=800", TOOL: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?w=800" };

    // è¡Œç¨‹è³‡æ–™ (ç¸®æ¸›ç¯„ä¾‹ï¼Œè«‹ç¢ºèªæ‚¨çš„å®Œæ•´è³‡æ–™æœ‰ä¿ç•™åœ¨åŸå§‹ç¢¼ä¸­)
    const itineraryDB = [
        { day: "D1", date: "3/28 (å…­)", title: "å•Ÿç¨‹ & é©æ‡‰", highlights: "æ©Ÿå ´è²·å¥¶ / OTSå–è»Š", bg: bgImages.D1, events: [
            { time: "09:00", title: "å‡ºç™¼å‰å¾€æ©Ÿå ´", icon: "fa-car", note: "æª¢æŸ¥è­·ç…§å¸¶äº†æ²’ï¼Ÿ", travel: "ğŸš— 40åˆ†" },
            { time: "15:45", title: "æŠµé”é‚£éœ¸æ©Ÿå ´", icon: "fa-plane-arrival", note: "å…¥å¢ƒã€æ‹¿è¡Œæã€‚", travel: "ğŸš¶ æ­¥è¡Œ" },
            { time: "17:00", title: "OTS å–è»Š", icon: "fa-car-side", note: "MapCode: 232 543 502*09", mapcode: "232 543 502*09", lat: 26.1558, lon: 127.6534 }
        ]},
        { day: "D2", date: "3/29 (æ—¥)", title: "åè­·æ¢éšª", highlights: "ç»ç’ƒèˆ¹ / AEON", bg: bgImages.D1, events: [
            { time: "10:00", title: "æµ·ä¸­å…¬åœ’ç»ç’ƒèˆ¹", icon: "fa-ship", note: "çœ‹å°¼è«ï¼", mapcode: "206 442 077*71", lat: 26.5278, lon: 127.9306 },
            { time: "13:30", title: "AEON åè­·åº—", icon: "fa-cart-shopping", note: "è¶…å¸‚è£œçµ¦", mapcode: "206 626 669*52" }
        ]},
        { day: "D3", date: "3/30 (ä¸€)", title: "ç¾éº—æµ·æ°´æ—é¤¨", highlights: "é¯¨é¯Š / æµ·è±šç§€", bg: bgImages.D1, events: [
            { time: "09:30", title: "ç¾éº—æµ·æ°´æ—é¤¨", icon: "fa-fish", note: "åœ P7 åœè»Šå ´", mapcode: "553 075 797*77", lat: 26.6943, lon: 127.8779 }
        ]}
    ];

    const foodBoardDB = [
        { name: "æ²–ç¹©éºµ", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Okinawa_soba.jpg/640px-Okinawa_soba.jpg", jp: "æ²–ç¸„ãã°" },
        { name: "å¡”å¯é£¯", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Taco_rice.jpg/640px-Taco_rice.jpg", jp: "ã‚¿ã‚³ãƒ©ã‚¤ã‚¹" },
        { name: "ç‚¸è±¬æ’", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Tonkatsu.jpg/640px-Tonkatsu.jpg", jp: "ã¨ã‚“ã‹ã¤" },
        { name: "ç‚’é£¯", img: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Fried_rice_with_egg%2C_shrimp%2C_and_scallion.jpg/640px-Fried_rice_with_egg%2C_shrimp%2C_and_scallion.jpg", jp: "ãƒãƒ£ãƒ¼ãƒãƒ³" }
    ];

    let checklistDB = JSON.parse(localStorage.getItem('trip_checklist_db')) || [
        { id: "pack", title: "ğŸ’ è¡Œå‰æ‰“åŒ…", items: [{text: "è­·ç…§"}, {text: "é§•ç…§è­¯æœ¬"}, {text: "å……é›»å™¨"}] },
        { id: "shop", title: "ğŸ›ï¸ è³¼ç‰©æ¸…å–®", items: [{text: "åˆåˆ©ä»–å‘½"}, {text: "è‹¥å…ƒéŒ "}] }
    ];
    
    const allergyDict = { "egg": { label: "é›è›‹", jp: "åµ (Tamago)" }, "milk": { label: "ç‰›å¥¶", jp: "ç‰›ä¹³ (Gyu-nyu)" } };
    const sosMessages = { sick: { jp: "å­ä¾›ãŒç—…æ°—ã§ã™" }, lost: { jp: "é“ã«è¿·ã„ã¾ã—ãŸ" }, police: { jp: "è­¦å¯Ÿã‚’å‘¼ã‚“ã§" }, ambulance: { jp: "æ•‘æ€¥è»Šï¼" } };

    // ================= 2. æ ¸å¿ƒåˆå§‹åŒ– (CORE INIT) =================
    function init() {
        if(isRainyMode) updateRainyModeUI();
        switchTab('itinerary');
        updateCountdown();
        setInterval(updateCountdown, 60000);
        initWeather();
        // æ¢å¾© HUD è¨ˆæ™‚å™¨
        setInterval(updateDriverHUD, 10000);
    }

    function initWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => fetchWeather(pos.coords.latitude, pos.coords.longitude),
                (err) => fetchWeather(26.5915, 127.9773)
            );
        } else { fetchWeather(26.5915, 127.9773); }
    }

    async function fetchWeather(lat, lon) {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            document.getElementById('weather-temp').innerText = Math.round(data.current_weather.temperature) + "Â°C";
            document.getElementById('weather-loc').innerText = "ç•¶åœ°";
        } catch (e) {
            document.getElementById('weather-temp').innerText = "24Â°C";
        }
    }

    function updateCountdown() {
        const tripStart = new Date(`${TRIP_YEAR}-03-28T09:00:00`).getTime();
        const now = new Date().getTime();
        const diff = tripStart - now;
        const el = document.getElementById('countdown');
        if (diff > 0) {
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            el.innerText = `é‚„æœ‰ ${days} å¤©`;
        } else {
            el.innerText = "æ—…ç¨‹ä¸­ âœˆï¸";
            el.className = "text-[10px] font-bold bg-pink-500 text-white px-2 py-0.5 rounded-md animate-pulse";
        }
    }

    // ================= 3. é é¢åˆ‡æ›é‚è¼¯ (NAVIGATION) =================
    window.switchTab = (tab) => {
        activeTab = tab;
        // æ›´æ–°åº•éƒ¨æŒ‰éˆ•ç‹€æ…‹
        document.querySelectorAll('.nav-btn').forEach(btn => {
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            if (btn.id === `btn-${tab}`) {
                icon.className = icon.className.replace('text-gray-400', 'text-blue-600');
                span.className = 'text-[10px] font-bold text-blue-600';
            } else {
                icon.className = icon.className.replace('text-blue-600', 'text-gray-400');
                span.className = 'text-[10px] font-bold text-gray-400';
            }
        });
        renderHeaderSubNav();
        renderContent();
    }
    
    window.switchChecklist = (id) => { currentChecklistFilter = id; renderContent(); updateSubNavStyle(); }
    window.switchTool = (id) => { currentToolFilter = id; renderContent(); updateSubNavStyle(); }
    
    function updateSubNavStyle() {
        // æ›´æ–°æ¬¡é¸å–®æŒ‰éˆ•æ¨£å¼ (ç™½åº• vs é€æ˜)
        if(activeTab === 'checklist') {
            checklistDB.forEach(c => {
                 const btn = document.getElementById(`btn-chk-${c.id}`);
                 if(btn) btn.className = currentChecklistFilter === c.id ? 
                    "flex-1 py-2 rounded-xl text-xs font-bold transition-all bg-white text-blue-600 shadow-sm" : 
                    "flex-1 py-2 rounded-xl text-xs font-bold transition-all text-white/80";
            });
        }
        else if (activeTab === 'tools') {
            ['drive', 'eat', 'fun', 'safe'].forEach(t => {
                const btn = document.getElementById(`btn-tool-${t}`);
                if(btn) btn.className = currentToolFilter === t ? 
                    "flex-1 py-2 rounded-xl text-xs font-bold transition-all bg-white text-blue-600 shadow-sm" : 
                    "flex-1 py-2 rounded-xl text-xs font-bold transition-all text-white/80";
            });
        }
    }

    function renderHeaderSubNav() {
        const container = document.getElementById('sub-nav-container');
        if (activeTab === 'itinerary') {
            // ä¿®å¾©åœ–382: åŠ å…¥ tab-active æ¨£å¼åˆ¤æ–·
            container.innerHTML = `<div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar px-2">${itineraryDB.map((d, i) => `<button onclick="currentDayIdx=${i}; renderContent(); renderHeaderSubNav()" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all duration-300 ${i === currentDayIdx ? 'tab-active' : 'tab-inactive'}"><div>${d.date.split(' ')[0]}</div></button>`).join('')}</div>`;
        } else if (activeTab === 'checklist') {
            container.innerHTML = `<div class="flex glass-dark p-1 rounded-2xl mx-1">${checklistDB.map(c => `<button id="btn-chk-${c.id}" onclick="switchChecklist('${c.id}')" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentChecklistFilter === c.id ? 'bg-white text-blue-600' : 'text-white/80'}">${c.title.split(' ')[1]}</button>`).join('')}</div>`;
        } else if (activeTab === 'tools') {
            container.innerHTML = `<div class="flex glass-dark p-1 rounded-2xl mx-1 gap-1"><button id="btn-tool-drive" onclick="switchTool('drive')" class="flex-1 py-2 rounded-xl text-xs font-bold">ğŸš— é§•é§›</button><button id="btn-tool-eat" onclick="switchTool('eat')" class="flex-1 py-2 rounded-xl text-xs font-bold">ğŸ± åƒå–</button><button id="btn-tool-fun" onclick="switchTool('fun')" class="flex-1 py-2 rounded-xl text-xs font-bold">ğŸ¦– å¨›æ¨‚</button><button id="btn-tool-safe" onclick="switchTool('safe')" class="flex-1 py-2 rounded-xl text-xs font-bold">ğŸ›¡ï¸ å®‰å…¨</button></div>`;
            setTimeout(updateSubNavStyle, 10); // å»¶é²ç¢ºä¿ DOM ç”Ÿæˆ
        } else {
            container.innerHTML = "";
        }
    }

    // ================= 4. ä¸»ç•«é¢æ¸²æŸ“ (RENDER CONTENT) =================
    function renderContent() {
        const main = document.getElementById('main-scroll');
        
        // 1. è¡Œç¨‹
        if (activeTab === 'itinerary') {
            const d = itineraryDB[currentDayIdx];
            main.innerHTML = `
            <div class="animate-slide-up tab-content">
                <div class="glass-card rounded-3xl p-5 mb-6 border-l-4 border-blue-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-1">${d.date} ${d.title}</h2>
                    <div class="text-sm text-gray-500"><i class="fas fa-star text-yellow-500 mr-1"></i> ${d.highlights}</div>
                </div>
                <div class="space-y-4">
                    ${d.events.map(e => `
                    <div class="flex gap-4 relative">
                        <div class="flex flex-col items-center">
                            <div class="w-12 h-12 rounded-2xl bg-white border border-slate-200 text-blue-600 flex items-center justify-center text-xl shadow-sm z-10"><i class="fas ${e.icon}"></i></div>
                            <div class="h-full w-0.5 bg-slate-200 my-1"></div>
                        </div>
                        <div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 mb-2 active:scale-[0.98] transition-transform">
                            <div class="flex justify-between items-start mb-1">
                                <h3 class="font-bold text-gray-800 text-lg">${e.time} ${e.title}</h3>
                                ${e.mapcode ? `<button onclick="copyMapCode('${e.mapcode}')" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded border border-yellow-200">MAPCODE</button>` : ''}
                            </div>
                            ${e.note ? `<p class="text-xs text-gray-500 bg-slate-50 p-2 rounded-lg">${e.note}</p>` : ''}
                            ${e.travel ? `<div class="mt-2 text-[10px] text-gray-400 font-bold bg-gray-100 inline-block px-2 py-1 rounded-full">${e.travel}</div>` : ''}
                        </div>
                    </div>`).join('')}
                </div>
                <div class="h-24"></div>
            </div>`;
        } 
        
        // 2. æ¸…å–®
        else if (activeTab === 'checklist') {
            const list = checklistDB.find(c => c.id === currentChecklistFilter);
            main.innerHTML = `
            <div class="animate-slide-up glass-card rounded-3xl p-6 min-h-[60vh] tab-content">
                <h3 class="font-bold text-xl mb-4 text-gray-800 border-b pb-4">${list.title}</h3>
                <div class="space-y-3">
                    ${list.items.map((item, i) => { 
                        const key = `chk_${currentChecklistFilter}_${item.text}`; 
                        const isChecked = localStorage.getItem(key) === '1'; 
                        return `<label class="flex items-center gap-3 p-3 rounded-2xl bg-white border border-slate-100 shadow-sm"><input type="checkbox" class="w-6 h-6 rounded-lg text-blue-600" ${isChecked ? 'checked' : ''} onchange="toggleCheck('${key}')"><span class="flex-1 font-bold ${isChecked ? 'text-gray-400 line-through' : 'text-gray-700'}">${item.text}</span><button onclick="deleteChecklistItem(${i})" class="text-gray-300"><i class="fas fa-trash-alt"></i></button></label>`;
                    }).join('')}
                </div>
                <button onclick="addChecklistItem()" class="w-full mt-4 py-3 border-2 border-dashed border-gray-300 rounded-2xl text-gray-500 font-bold"><i class="fas fa-plus mr-1"></i> æ–°å¢é …ç›®</button>
                <button onclick="openGiftModal()" class="w-full mt-6 py-4 bg-red-50 text-red-500 rounded-2xl text-lg font-bold border border-red-100"><i class="fas fa-gift mr-2"></i> ç®¡ç†ä¼´æ‰‹ç¦®æ¸…å–®</button>
            </div>`;
        }

        // 3. æˆå°± (çœç•¥è©³ç´°ï¼Œåƒ…ä¿ç•™çµæ§‹)
        else if (activeTab === 'missions') {
            main.innerHTML = `<div class="p-4 text-center text-white font-bold opacity-60 mt-10">ä»»å‹™åœ°åœ–è¼‰å…¥ä¸­...<br>(æ­¤é é¢åŠŸèƒ½å·²ç°¡åŒ–)</div>`;
        }

        // 4. å·¥å…· (Tools)
        else if (activeTab === 'tools') {
            if (currentToolFilter === 'drive') {
                // ä¿®å¾©åœ–384/385: é§•é§›æ¨¡å¼ HUD æŒ‰éˆ•
                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <button onclick="openDriverMode()" class="w-full bg-gradient-to-r from-slate-800 to-black text-white p-6 rounded-3xl shadow-xl relative overflow-hidden group mb-4">
                        <div class="absolute right-0 top-0 p-6 opacity-20"><i class="fas fa-gauge-high text-7xl"></i></div>
                        <div class="relative z-10 text-left">
                            <h3 class="text-2xl font-black italic">DRIVER HUD</h3>
                            <p class="text-sm text-gray-300 mt-1">é§•é§›å°ˆç”¨å„€è¡¨æ¿</p>
                        </div>
                    </button>
                    <div class="grid grid-cols-2 gap-2 mb-6">
                        <button onclick="quickSearch('toilets')" class="bg-white p-4 rounded-2xl shadow-sm font-bold text-blue-600"><i class="fas fa-restroom mr-1"></i> æ‰¾å»æ‰€</button>
                        <button onclick="quickSearch('Lawson')" class="bg-white p-4 rounded-2xl shadow-sm font-bold text-blue-600"><i class="fas fa-store mr-1"></i> æ‰¾è¶…å•†</button>
                    </div>
                    ${toolsDB.drive.map(d => `<div class="p-5 rounded-3xl glass-card ${d.color}"><div class="font-bold opacity-60 text-xs mb-1">${d.title}</div><div class="text-xl font-black">${d.content}</div></div>`).join('')}
                </div>`;
            }
            else if (currentToolFilter === 'eat') {
                // ä¿®å¾©åœ–394: åŒ¯ç‡èˆ‡è¨˜å¸³
                // è¨ˆç®—ç¨…é‡‘
                let taxTotal = taxBasket.reduce((a,b)=>a+b,0);
                let taxDiff = 5500 - taxTotal;
                
                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <div class="bg-orange-50 border border-orange-200 rounded-3xl p-5">
                        <h3 class="text-lg font-black text-orange-800 mb-4">æ‰‹æŒ‡é»é¤é€š</h3>
                        <div class="grid grid-cols-2 gap-3">
                            ${foodBoardDB.map(f => `<div class="bg-white rounded-xl overflow-hidden shadow-sm" onclick="speak('${f.jp}')"><img src="${f.img}" class="w-full h-24 object-cover" onerror="this.src='https://via.placeholder.com/150'"><div class="p-2 text-center font-bold text-gray-700">${f.name}</div></div>`).join('')}
                        </div>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-5 text-center border-2 border-yellow-300 relative">
                        <h3 class="text-xs font-bold text-yellow-600 mb-2 uppercase">åŒ¯ç‡æ›ç®— (1 JPY = ${CURRENT_RATE})</h3>
                        <div class="flex gap-4">
                            <div class="bg-blue-50 p-2 rounded-xl border border-blue-100 w-1/2">
                                <input type="number" id="jpyInput" oninput="convertCurrency()" placeholder="æ—¥å¹£" class="w-full text-2xl text-center bg-transparent font-black text-gray-800 p-0 focus:outline-none">
                            </div>
                            <div class="bg-green-50 p-2 rounded-xl border border-green-100 w-1/2 flex items-center justify-center">
                                <div id="twdOutput" class="text-2xl font-black text-green-700">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl p-5 shadow-md border-2 border-pink-100">
                        <div class="flex justify-between items-center mb-2"><h3 class="font-black text-pink-500">å…ç¨…æ¹Šå–®ç¥å™¨</h3><button onclick="resetTaxBasket()" class="text-xs text-gray-400">æ¸…ç©º</button></div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="taxItemInput" placeholder="è¼¸å…¥é‡‘é¡" class="flex-1 bg-gray-50 rounded-xl px-4 py-2 text-xl font-bold">
                            <button onclick="addTaxItem()" class="bg-pink-500 text-white w-12 rounded-xl font-bold text-2xl">+</button>
                        </div>
                        <div class="text-xs font-bold text-gray-500 mb-1">ç›®å‰: Â¥${taxTotal} ${taxDiff > 0 ? `<span class="text-red-500 ml-2">é‚„å·® Â¥${taxDiff}</span>` : '<span class="text-green-500 ml-2">ğŸ‰ å…ç¨…é”æˆ</span>'}</div>
                        <div class="flex flex-wrap gap-1">${taxBasket.map(p => `<span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold">Â¥${p}</span>`).join('')}</div>
                    </div>

                    <div class="glass-card rounded-3xl p-4">
                        <div class="flex justify-between text-xs font-bold mb-2"><span>ç¸½èŠ±è²»: Â¥${expenses.reduce((a,b)=>a+b.price,0)}</span></div>
                        <button onclick="openQuickExpense()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg">è¨˜ä¸€ç­†</button>
                        <div class="mt-4 space-y-2">
                             ${expenses.slice(0, 5).map(e => `<div class="flex justify-between bg-white p-2 rounded-lg border border-slate-50 shadow-sm"><span class="font-bold text-gray-700">${e.name}</span><span class="text-gray-500">Â¥${e.price}</span></div>`).join('')}
                        </div>
                    </div>
                </div>`;
                // æ¢å¾©ç„¦é» (ç°¡æ˜“ç‰ˆ)
                setTimeout(() => { 
                    const i = document.getElementById('jpyInput'); 
                    if(i && document.activeElement !== i) i.value = ""; 
                }, 100);
            }
            else if (currentToolFilter === 'fun') {
                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <div class="bg-yellow-50 border-2 border-yellow-200 rounded-3xl p-5 cursor-pointer" onclick="openHunt()">
                        <div class="flex justify-between items-center mb-2"><h3 class="text-xl font-black text-yellow-800">å°‹å¯¶çµäºº</h3><span class="bg-yellow-200 text-yellow-800 text-xs font-bold px-2 py-1 rounded-full">GO</span></div>
                        <p class="text-sm text-yellow-700 font-medium">è»Šä¸Šä¸ç„¡èŠï¼æ‰¾æ‰¾çª—å¤–æœ‰ä»€éº¼ï¼Ÿ</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="openVoice()" class="bg-green-500 text-white p-5 rounded-3xl shadow-lg font-bold text-lg">æé¾è®Šè²</button>
                        <button onclick="openAR()" class="bg-indigo-600 text-white p-5 rounded-3xl shadow-lg font-bold text-lg">AR å¬å–š</button>
                    </div>
                </div>`;
            }
            else if (currentToolFilter === 'safe') {
                // ä¿®å¾©åœ–393: SOS åŠŸèƒ½
                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <button onclick="openDrDino()" class="w-full bg-white border-2 border-red-100 rounded-3xl p-5 flex items-center gap-4"><div class="text-3xl">ğŸ‘¨â€âš•ï¸</div><div class="text-left font-black text-red-600">Dr. Dino ç—›ç—›ç¿»è­¯</div></button>
                    <button onclick="openSosCard()" class="w-full bg-red-600 text-white rounded-3xl p-6 shadow-xl border-4 border-red-500 flex items-center justify-between"><div class="text-left font-black text-2xl">ç·Šæ€¥æ±‚åŠ©å¡</div><i class="fas fa-exclamation-circle text-4xl"></i></button>
                    
                    <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-100">
                        <div class="flex justify-between mb-4"><h3 class="font-bold text-gray-800">å…’ç«¥å®‰å¿ƒè­·ç…§</h3><button onclick="toggleEditMedical()" class="text-xs bg-gray-100 px-3 py-1 rounded-full font-bold">ç·¨è¼¯</button></div>
                        <div id="medical-view">
                            <div class="text-2xl font-black text-gray-800 mb-1">${medicalData.name || "æœªå¡«å¯«"}</div>
                            <div class="text-blue-600 font-bold mb-2">ğŸ“ ${medicalData.phone || ""}</div>
                            <div class="text-xs text-gray-500">ä½å®¿: ${medicalData.hotel || ""}</div>
                        </div>
                        <div id="medical-edit" class="hidden space-y-3 mt-4">
                            <input id="in-name" type="text" placeholder="å§“å" value="${medicalData.name}" class="w-full p-2 border rounded">
                            <input id="in-phone" type="tel" placeholder="é›»è©±" value="${medicalData.phone}" class="w-full p-2 border rounded">
                            <input id="in-hotel" type="text" placeholder="é£¯åº—" value="${medicalData.hotel}" class="w-full p-2 border rounded">
                            <button onclick="saveMedical()" class="w-full bg-blue-600 text-white font-bold py-2 rounded-lg">å„²å­˜</button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        ${toolsDB.sos.map(s => `<a href="tel:${s.tel}" class="${s.style} p-4 rounded-2xl block text-center font-bold shadow-md flex justify-between px-6"><span>${s.name}</span><span>${s.tel}</span></a>`).join('')}
                    </div>
                </div>`;
            }
        }
    }

    // ================= 5. åŠŸèƒ½ä¿®å¾© (FIXED FUNCTIONS) =================
    
    // [HUD] ä¿®å¾©è¼‰å…¥å•é¡Œ
    window.openDriverMode = () => {
        document.getElementById('driver-hud').classList.remove('hidden');
        document.getElementById('driver-hud').classList.add('flex');
        updateDriverHUD(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡
        try { if(navigator.wakeLock) navigator.wakeLock.request('screen'); } catch(e){}
    }
    window.closeDriverMode = () => {
        document.getElementById('driver-hud').classList.add('hidden');
        document.getElementById('driver-hud').classList.remove('flex');
    }
    window.updateDriverHUD = () => {
        const d = itineraryDB[currentDayIdx];
        if(!d) return;
        document.getElementById('hud-title').innerText = d.events[0]?.title || "è¡Œç¨‹çµæŸ";
        // æŠ“å–ç¬¬ä¸€å€‹æœ‰ MapCode çš„äº‹ä»¶
        const nextSpot = d.events.find(e => e.mapcode);
        document.getElementById('hud-mapcode').innerText = nextSpot ? nextSpot.mapcode : "--- ---";
        
        // æ¨¡æ“¬æ™‚é€Ÿ
        if(navigator.geolocation) {
             navigator.geolocation.getCurrentPosition(p => {
                 document.getElementById('hud-speed').innerText = p.coords.speed ? Math.round(p.coords.speed * 3.6) : 0;
             });
        }
    }
    window.toggleRoadType = () => {
        const btn = document.getElementById('btn-road-type');
        btn.innerText = btn.innerText.includes('50') ? "é«˜é€Ÿ (80)" : "ä¸€èˆ¬ (50)";
    }
    window.copyHudMapCode = () => {
        const code = document.getElementById('hud-mapcode').innerText;
        navigator.clipboard.writeText(code).then(() => showToast("MapCode å·²è¤‡è£½"));
    }
    window.changeHudEvent = (dir) => { showToast("åˆ‡æ›è¡Œç¨‹é» (æ¨¡æ“¬)"); updateDriverHUD(); }

    // [Modals] è£œå›éºå¤±çš„é–‹é—œå‡½å¼
    window.openGiftModal = () => {
        const c = document.getElementById('gift-list-container');
        c.innerHTML = giftDB.map((g, i) => `<div class="flex justify-between p-3 bg-slate-50 rounded-xl mb-2"><div class="font-bold">${g.who}: ${g.what}</div><button onclick="giftDB.splice(${i},1);localStorage.setItem('trip_gifts',JSON.stringify(giftDB));openGiftModal()" class="text-red-500"><i class="fas fa-trash"></i></button></div>`).join('');
        document.getElementById('gift-modal').classList.add('open');
    }
    window.closeGiftModal = () => document.getElementById('gift-modal').classList.remove('open');
    window.addGift = () => {
        const who = document.getElementById('gift-who').value;
        const what = document.getElementById('gift-what').value;
        if(who && what) {
            giftDB.push({who, what, budget: 0});
            localStorage.setItem('trip_gifts', JSON.stringify(giftDB));
            openGiftModal(); // é‡ç¹ª
            document.getElementById('gift-who').value = '';
            document.getElementById('gift-what').value = '';
        }
    }

    window.openSosCard = () => document.getElementById('sos-card-modal').classList.add('open');
    window.closeSosCard = () => document.getElementById('sos-card-modal').classList.remove('open');
    window.setSosMsg = (type) => {
        document.getElementById('sos-jp-text').innerText = sosMessages[type].jp;
        document.getElementById('sos-sub-text').innerText = type;
    }

    window.openDrDino = () => document.getElementById('dr-dino-modal').classList.add('open');
    window.closeDrDino = () => document.getElementById('dr-dino-modal').classList.remove('open');

    // [Hunt] å°‹å¯¶çµäºº
    window.openHunt = () => { 
        document.getElementById('hunt-grid').innerHTML = huntDB.map(item => `<div class="hunt-card ${huntProgress[item.id] ? 'found' : ''}" onclick="toggleHuntItem('${item.id}')"><div class="hunt-inner"><div class="hunt-front shadow-sm"><div class="text-5xl mb-2 opacity-80">${item.icon}</div><div class="font-bold text-gray-700">${item.name}</div></div><div class="hunt-back shadow-inner"><div class="text-6xl animate-bounce">â­</div><div class="font-black text-yellow-800 mt-2">FOUND!</div></div></div></div>`).join('');
        document.getElementById('hunt-modal').classList.add('open'); 
    }
    window.closeHunt = () => document.getElementById('hunt-modal').classList.remove('open');
    window.toggleHuntItem = (id) => { 
        if (!huntProgress[id]) { 
            huntProgress[id] = true; 
            localStorage.setItem('hunt_progress', JSON.stringify(huntProgress)); 
            openHunt(); // é‡ç¹ª
            playSound('coin'); 
        } 
    }
    window.resetHunt = () => {
        if(confirm("ç¢ºå®šè¦é‡ç½®å°‹å¯¶é€²åº¦å—ï¼Ÿ")) {
            huntProgress = { h1: false, h2: false, h3: false, h4: false };
            localStorage.setItem('hunt_progress', JSON.stringify(huntProgress));
            openHunt();
        }
    }

    // [Expense] è¨˜å¸³èˆ‡åŒ¯ç‡
    window.convertCurrency = () => {
        const val = parseFloat(document.getElementById('jpyInput').value);
        if (!isNaN(val)) document.getElementById('twdOutput').innerText = Math.round(val * CURRENT_RATE);
    }
    window.addTaxItem = () => {
        const val = parseInt(document.getElementById('taxItemInput').value);
        if(val > 0) {
            taxBasket.push(val);
            renderContent(); // é€™è£¡éœ€è¦é‡ç¹ªå› ç‚º UI çµæ§‹æ”¹è®Š
            setTimeout(()=>document.getElementById('taxItemInput').focus(), 100);
        }
    }
    window.resetTaxBasket = () => { taxBasket = []; renderContent(); }
    
    window.openQuickExpense = () => document.getElementById('expense-modal').classList.add('open');
    window.closeQuickExpense = () => document.getElementById('expense-modal').classList.remove('open');
    window.saveQuickExpense = () => {
        const name = document.getElementById('quickExName').value;
        const price = parseInt(document.getElementById('quickExPrice').value);
        if(name && price) {
            expenses.unshift({ name, price, cat: 'shopping' });
            localStorage.setItem('trip_expenses', JSON.stringify(expenses));
            closeQuickExpense();
            renderContent();
            showToast("å·²è¨˜å¸³");
        }
    }

    // [Medical]
    window.toggleEditMedical = () => {
        const view = document.getElementById('medical-view');
        const edit = document.getElementById('medical-edit');
        if(view.classList.contains('hidden')) {
            view.classList.remove('hidden');
            edit.classList.add('hidden');
        } else {
            view.classList.add('hidden');
            edit.classList.remove('hidden');
        }
    }
    window.saveMedical = () => {
        medicalData.name = document.getElementById('in-name').value;
        medicalData.phone = document.getElementById('in-phone').value;
        medicalData.hotel = document.getElementById('in-hotel').value;
        localStorage.setItem('medical_data', JSON.stringify(medicalData));
        toggleEditMedical();
        renderContent();
    }

    // [Checklist]
    window.toggleCheck = (key) => {
        const val = localStorage.getItem(key);
        localStorage.setItem(key, val === '1' ? '0' : '1');
        renderContent();
    }
    window.addChecklistItem = () => {
        const t = prompt("è¼¸å…¥é …ç›®åç¨±:");
        if(t) {
            checklistDB.find(c => c.id === currentChecklistFilter).items.push({text: t});
            localStorage.setItem('trip_checklist_db', JSON.stringify(checklistDB));
            renderContent();
        }
    }
    window.deleteChecklistItem = (i) => {
        if(confirm("åˆªé™¤æ­¤é …ç›®?")) {
            checklistDB.find(c => c.id === currentChecklistFilter).items.splice(i, 1);
            localStorage.setItem('trip_checklist_db', JSON.stringify(checklistDB));
            renderContent();
        }
    }

    // [System] éŸ³æ•ˆèˆ‡ TTS
    function playSound(type) {
        // ä½¿ç”¨ Web Audio API é¿å… iOS éœéŸ³æ¨¡å¼å•é¡Œ
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        if (type === 'coin') {
            osc.frequency.setValueAtTime(1200, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(2000, ctx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start();
            osc.stop(ctx.currentTime + 0.3);
        } else {
            osc.frequency.setValueAtTime(400, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
            osc.start();
            osc.stop(ctx.currentTime + 0.2);
        }
    }
    
    window.speak = (text) => {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'ja-JP';
        window.speechSynthesis.speak(u);
    }

    window.copyMapCode = (c) => {
        navigator.clipboard.writeText(c).then(() => showToast("å·²è¤‡è£½ MapCode"));
    }
    
    window.quickSearch = (q) => {
        window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }
    
    window.closeModal = () => document.getElementById('modal-overlay').classList.remove('open');
    
    // [AR/Voice]
    window.openAR = () => document.getElementById('ar-modal').classList.add('open');
    window.closeAR = () => document.getElementById('ar-modal').classList.remove('open');
    window.openVoice = () => document.getElementById('voice-modal').classList.add('open');
    window.closeVoice = () => document.getElementById('voice-modal').classList.remove('open');

    // å•Ÿå‹•
    init();
    </script>
</body>
</html>
