<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">
    <title>å¥å¥å…¨å®¶æ²–ç¹©éŠ ğŸ¦• V19.4 FULL</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js" defer></script>

    <style>
        /* [ç³»çµ±åŸºç¤] */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #0f172a; -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; -webkit-overflow-scrolling: touch; user-select: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* [V19 è¦–è¦ºæ ¸å¿ƒ] */
        .glass { background: rgba(255, 255, 255, 0.92); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.5); }
        .glass-dark { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.15); color: white; }
        .glass-card { background: rgba(255, 255, 255, 0.95); box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(255, 255, 255, 0.6); }

        /* [V17 åŠŸèƒ½å¾©åˆ»ï¼šè¡Œç¨‹æ™‚é–“è»¸] */
        .event-card-container { padding-bottom: 24px; position: relative; }
        .event-card-container:last-child { padding-bottom: 10px; }
        .timeline-connector { position: absolute; left: 2.25rem; bottom: 0; height: 100%; width: 2px; border-left: 2px dashed #cbd5e1; z-index: 0; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 5px; }
        .event-card-container:last-child .timeline-connector { display: none; }
        .travel-pill { background-color: #f1f5f9; border: 1px solid #cbd5e1; color: #64748b; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 99px; white-space: nowrap; z-index: 10; margin-bottom: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        /* [V17 åŠŸèƒ½å¾©åˆ»ï¼šéš¨èº«å°ºè¦] */
        .ruler-container { background: #fff; overflow-x: auto; overflow-y: hidden; white-space: nowrap; position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); border-radius: 8px; border: 1px solid #e2e8f0; height: 100px; display: flex; align-items: flex-end; padding-left: 20px; padding-right: 20px; }
        .ruler-tick { width: 1px; background: #334155; display: inline-block; flex-shrink: 0; position: relative; }
        .ruler-tick.major { height: 40px; width: 2px; background: #0f172a; }
        .ruler-tick.medium { height: 30px; opacity: 0.8; }
        .ruler-tick.minor { height: 20px; opacity: 0.6; }
        .ruler-num { position: absolute; top: -25px; left: -10px; width: 20px; text-align: center; font-size: 12px; font-weight: bold; }

        /* [å‹•ç•«ç‰¹æ•ˆ] */
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .animate-pop { animation: pop 0.3s ease-in-out; }
        .animate-shake { animation: shake 0.3s ease-in-out 3; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* [UI ç‹€æ…‹] */
        .tab-active { background: rgba(255, 255, 255, 0.95); color: #2563eb; transform: scale(1.05); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .tab-inactive { background: rgba(0, 0, 0, 0.3); color: rgba(255, 255, 255, 0.7); }
        body.rainy-mode #bg-layer { filter: grayscale(80%) brightness(0.6); }
        body.rainy-mode .glass-card { border-left: 4px solid #60a5fa !important; }
        .pt-safe-top { padding-top: max(20px, env(safe-area-inset-top)); }
        .pb-safe-bottom { padding-bottom: max(20px, env(safe-area-inset-bottom)); }
        
        /* [å½ˆçª—èˆ‡æç¤º] */
        .modal { display: none; z-index: 9999; }
        .modal.open { display: flex !important; }
        #toast { visibility: hidden; min-width: 200px; transform: translateX(-50%); background-color: rgba(30, 41, 59, 0.95); color: #fff; text-align: center; border-radius: 50px; padding: 12px 24px; position: fixed; z-index: 10000; left: 50%; bottom: 120px; font-size: 14px; backdrop-filter: blur(8px); opacity: 0; transition: opacity 0.3s, bottom 0.3s; pointer-events: none; }
        #toast.show { visibility: visible; opacity: 1; bottom: 130px; }
        #geo-toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 25px; border-radius: 50px; z-index: 9999; display: flex; align-items: center; gap: 15px; transition: transform 0.5s; border: 2px solid #fbbf24; width: 90%; max-width: 350px; }
        #geo-toast.show { transform: translateX(-50%) translateY(0); }

        /* [ç›¸æ©Ÿ] */
        .cam-viewport { position: relative; overflow: hidden; background: #000; border-radius: 1.5rem; aspect-ratio: 3/4; width: 100%; }
        #camera-video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 overflow-hidden relative">
    <div id="bg-layer" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-700 transform scale-105" style="background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800');">
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/10 to-slate-100/90"></div>
    </div>

    <div class="z-10 pt-safe-top px-5 pb-2 flex-shrink-0">
        <div class="flex justify-between items-start pt-6 mb-2 text-white">
            <div class="flex-1 mr-2">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-blue-600 px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider uppercase shadow-lg border border-blue-400/30">2026 TRIP</span>
                    <div id="countdown" class="text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10">è¨ˆç®—ä¸­...</div>
                </div>
                <h1 class="text-3xl font-black tracking-tight drop-shadow-lg leading-tight">å¥å¥å…¨å®¶<br>æ²–ç¹©éŠ ğŸ¦•</h1>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div class="flex gap-2">
                    <button onclick="toggleRainMode()" id="rain-btn" class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20"><i id="rain-icon" class="fas fa-sun text-xl mb-1 block text-yellow-400"></i><span id="rain-text" class="text-[9px] font-bold opacity-90">æ™´å¤©</span></button>
                    <div class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[70px]" onclick="initWeather()"><i id="weather-icon" class="fas fa-spinner fa-spin text-xl mb-1 block text-blue-300"></i><span id="weather-temp" class="text-sm font-bold">...</span></div>
                </div>
                <button onclick="toggleVoiceMemo()" class="glass-dark w-10 h-10 rounded-full flex items-center justify-center active:bg-pink-500 transition-colors border border-white/20"><i class="fas fa-microphone text-white text-sm"></i></button>
            </div>
        </div>
        <div id="sub-nav-container" class="mt-2 min-h-[44px]"></div>
    </div>
    
    <div id="main-scroll" class="flex-1 overflow-y-auto p-4 pb-32 z-10 scroll-smooth rounded-t-[2.5rem] bg-slate-50 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] relative top-2"></div>

    <div class="fixed bottom-0 w-full glass flex justify-around items-center pb-safe-bottom h-[85px] z-50 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-itinerary"><div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-map-location-dot text-xl text-blue-600"></i></div><span class="text-[10px] font-bold text-blue-600">è¡Œç¨‹</span></button>
        <button onclick="switchTab('checklist')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-checklist"><div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-clipboard-list text-xl text-gray-400"></i></div><span class="text-[10px] font-bold text-gray-400">æ¸…å–®</span></button>
        <button onclick="switchTab('missions')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-missions"><div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-medal text-xl text-gray-400"></i></div><span class="text-[10px] font-bold text-gray-400">æˆå°±</span></button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-tools"><div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-toolbox text-xl text-gray-400"></i></div><span class="text-[10px] font-bold text-gray-400">å·¥å…·</span></button>
    </div>

    <button onclick="openQuickExpense()" class="fixed bottom-[100px] right-4 w-14 h-14 bg-pink-500 rounded-full text-white shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform border-4 border-white/20 backdrop-blur"><i class="fas fa-plus text-2xl"></i></button>

    <div id="toast"><i class="fas fa-check-circle mr-2 text-green-400"></i><span id="toast-msg">å·²è¤‡è£½</span></div>
    <div id="geo-toast"><div class="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center text-xl text-yellow-900 animate-bounce"><i class="fas fa-map-marker-alt"></i></div><div><div class="text-[10px] font-bold text-gray-400 uppercase">MISSION UNLOCKED</div><div id="geo-msg" class="font-bold text-gray-800 text-sm">æŠµé”ç›®çš„åœ°ï¼</div></div></div>

    <div id="driver-hud" class="fixed inset-0 bg-black z-[200] hidden flex-col p-6 text-white font-mono modal"></div>
    <div id="expense-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end justify-center p-0 sm:p-6 hidden modal" onclick="closeQuickExpense()"></div>
    <div id="gift-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden modal" onclick="closeGiftModal()"></div>
    <div id="hunt-modal" class="fixed inset-0 bg-yellow-50 flex flex-col hidden animate-slide-up modal"></div>
    <div id="voice-modal" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center hidden text-white modal"></div>
    <div id="spot-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end justify-center p-0 sm:p-6 hidden modal" onclick="document.getElementById('spot-modal').classList.remove('open')"></div>
    <div id="camera-modal" class="fixed inset-0 bg-black hidden modal flex-col"></div>
    <div id="sos-card-modal" class="fixed inset-0 bg-red-600 flex flex-col items-center justify-center p-6 text-white hidden text-center animate-pop modal"></div>
    <div id="ruler-modal" class="fixed inset-0 z-[150] bg-white flex flex-col hidden animate-slide-up modal"></div>
    <div id="drawing-modal" class="fixed inset-0 z-[200] bg-white flex flex-col hidden modal"></div>
    <div id="dr-dino-modal" class="fixed inset-0 bg-white flex flex-col hidden animate-slide-up modal"></div>
    <div id="gasha-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col hidden modal" onclick="closeGashaModal()"></div>
    <div id="daily-check-modal" class="fixed inset-0 z-[150] bg-blue-900/90 backdrop-blur-md flex items-center justify-center p-6 hidden modal"></div>
	<body class="h-screen flex flex-col text-gray-800 overflow-hidden relative">
    <div id="bg-layer" class="absolute inset-0 z-0 bg-cover bg-center transition-all duration-700 transform scale-105" 
         style="background-image: url('https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800');">
        <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/10 to-slate-100/90"></div>
    </div>

    <div class="z-10 pt-safe-top px-5 pb-2 flex-shrink-0">
        <div class="flex justify-between items-start pt-6 mb-2 text-white">
            <div class="flex-1 mr-2">
                <div class="flex items-center gap-2 mb-1">
                    <span class="bg-blue-600 px-2 py-0.5 rounded-md text-[10px] font-bold tracking-wider uppercase shadow-lg border border-blue-400/30">2026 TRIP</span>
                    <div id="countdown" class="text-[10px] font-mono font-medium opacity-90 bg-black/40 px-2 py-0.5 rounded-md backdrop-blur-sm border border-white/10">è¨ˆç®—ä¸­...</div>
                </div>
                <h1 class="text-3xl font-black tracking-tight drop-shadow-lg leading-tight">å¥å¥å…¨å®¶<br>æ²–ç¹©éŠ ğŸ¦•</h1>
            </div>
            
            <div class="flex flex-col items-end gap-2">
                <div class="flex gap-2">
                    <button onclick="toggleRainMode()" id="rain-btn" class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[50px] active:scale-95 transition-all border border-white/20">
                        <i id="rain-icon" class="fas fa-sun text-xl mb-1 block text-yellow-400"></i>
                        <span id="rain-text" class="text-[9px] font-bold opacity-90">æ™´å¤©</span>
                    </button>
                    <div class="glass-dark px-3 py-2 rounded-2xl text-center shadow-lg min-w-[70px] active:scale-95 transition-transform cursor-pointer" onclick="initWeather()">
                        <i id="weather-icon" class="fas fa-spinner fa-spin text-xl mb-1 block text-blue-300"></i>
                        <span id="weather-temp" class="text-sm font-bold">...</span>
                        <div id="weather-loc" class="text-[9px] opacity-70 mt-0.5">é‡æ•´</div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="toggleVoiceMemo()" class="glass-dark w-10 h-10 rounded-full flex items-center justify-center active:bg-pink-500 transition-colors border border-white/20">
                         <i class="fas fa-microphone text-white text-sm"></i>
                    </button>
                </div>
            </div>
        </div>
        <div id="sub-nav-container" class="mt-2 min-h-[44px]"></div>
    </div>
    
    <div id="main-scroll" class="flex-1 overflow-y-auto p-4 pb-32 z-10 scroll-smooth rounded-t-[2.5rem] bg-slate-50 shadow-[0_-10px_40px_rgba(0,0,0,0.15)] relative top-2">
    </div>

    <div class="fixed bottom-0 w-full glass flex justify-around items-center pb-safe-bottom h-[85px] z-50 rounded-t-[2rem] shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
        <button onclick="switchTab('itinerary')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-itinerary">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-map-location-dot text-xl text-blue-600"></i></div>
            <span class="text-[10px] font-bold text-blue-600">è¡Œç¨‹</span>
        </button>
        <button onclick="switchTab('checklist')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-checklist">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-clipboard-list text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æ¸…å–®</span>
        </button>
        <button onclick="switchTab('missions')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-missions">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-medal text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">æˆå°±</span>
        </button>
        <button onclick="switchTab('tools')" class="nav-btn flex flex-col items-center justify-center w-full h-full group" id="btn-tools">
            <div class="icon-box p-2 rounded-2xl mb-1"><i class="fas fa-toolbox text-xl text-gray-400"></i></div>
            <span class="text-[10px] font-bold text-gray-400">å·¥å…·</span>
        </button>
    </div>

    <button onclick="openQuickExpense()" class="fixed bottom-[100px] right-4 w-14 h-14 bg-pink-500 rounded-full text-white shadow-2xl flex items-center justify-center z-40 active:scale-90 transition-transform border-4 border-white/20 backdrop-blur group">
        <i class="fas fa-plus text-2xl group-active:rotate-90 transition-transform"></i>
    </button>

    <div id="expense-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-0 sm:p-6 hidden modal" onclick="closeQuickExpense()">
        <div class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl relative animate-slide-up" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-black text-gray-800"><i class="fas fa-bolt text-yellow-400 mr-2"></i>å¿«é€Ÿè¨˜å¸³</h3>
                <button onclick="closeQuickExpense()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-4">
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-2">
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="shopping" class="peer sr-only" checked><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-pink-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-bag-shopping"></i> è³¼ç‰©</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="food" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-utensils"></i> é¤é£²</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="play" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-purple-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-ticket"></i> å¨›æ¨‚</div></label>
                    <label class="cursor-pointer"><input type="radio" name="quick-cat" value="transport" class="peer sr-only"><div class="bg-slate-50 border border-slate-200 px-3 py-2 rounded-xl text-xs text-gray-500 peer-checked:bg-blue-500 peer-checked:text-white transition-all font-bold whitespace-nowrap"><i class="fas fa-car"></i> äº¤é€š</div></label>
                </div>
                <input id="quickExName" type="text" placeholder="å“é …åç¨± (å¦‚: å†°æ·‡æ·‹)" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-base focus:outline-pink-500 min-w-0">
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">Â¥</span>
                    <input id="quickExPrice" type="number" placeholder="é‡‘é¡" class="w-full bg-slate-50 border border-slate-200 rounded-xl pl-8 pr-4 py-3 text-xl font-black text-gray-800 focus:outline-pink-500 min-w-0">
                </div>
                <button onclick="saveQuickExpense()" class="w-full bg-pink-500 text-white font-bold py-4 rounded-xl shadow-lg active:scale-[0.98] transition-transform text-lg mt-2"><i class="fas fa-check mr-2"></i> å„²å­˜é€™ç­†</button>
            </div>
        </div>
    </div>

    <div id="sos-card-modal" class="fixed inset-0 bg-red-600 flex flex-col items-center justify-center p-6 text-white hidden text-center animate-pop modal">
        <button onclick="closeSosCard()" class="absolute top-6 right-6 text-white/70 text-4xl hover:text-white pt-safe-top"><i class="fas fa-times-circle"></i></button>
        <div class="mb-8 animate-pulse"><i class="fas fa-exclamation-triangle text-6xl text-yellow-300"></i></div>
        <div class="text-xl font-bold mb-2 opacity-80">æˆ‘æ˜¯å°ç£äººï¼Œè«‹å¹«åŠ©æˆ‘</div>
        <h2 id="sos-jp-text" class="text-4xl sm:text-5xl font-black leading-tight mb-4 bg-white text-red-600 p-4 rounded-xl shadow-xl w-full select-all">åŠ©ã‘ã¦ãã ã•ã„</h2>
        <p id="sos-sub-text" class="text-lg font-bold opacity-90">Please help me.</p>
        <div class="grid grid-cols-2 gap-4 w-full mt-10">
            <button onclick="setSosMsg('sick')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å°å­©ç”Ÿç—…<br>å­ä¾›ãŒç—…æ°—</button>
            <button onclick="setSosMsg('lost')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">è¿·è·¯äº†<br>è¿·å­ã§ã™</button>
            <button onclick="setSosMsg('police')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å ±è­¦<br>è­¦å¯Ÿã‚’å‘¼ã‚“ã§</button>
            <button onclick="setSosMsg('ambulance')" class="bg-white/20 border-2 border-white/40 p-4 rounded-xl font-bold active:bg-white/40 transition-colors">å«æ•‘è­·è»Š<br>æ•‘æ€¥è»Šï¼</button>
        </div>
    </div>

    <div id="gift-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 hidden modal" onclick="closeGiftModal()">
        <div class="bg-white w-full max-w-sm rounded-3xl p-5 shadow-2xl relative h-[70vh] flex flex-col" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 pb-4 border-b">
                <h3 class="text-lg font-black text-gray-800"><i class="fas fa-gift text-red-500 mr-2"></i>ä¼´æ‰‹ç¦®æ¸…å–®</h3>
                <button onclick="closeGiftModal()" class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="gift-list-container" class="flex-1 overflow-y-auto space-y-2 mb-4 hide-scrollbar"></div>
            <div class="border-t pt-4 space-y-3">
                <input id="gift-who" type="text" placeholder="å°è±¡ (å¦‚: é˜¿å¬¤)" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500 font-bold min-w-0">
                <input id="gift-what" type="text" placeholder="è¦è²·ä»€éº¼?" class="w-full bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500 min-w-0">
                <div class="flex gap-2">
                    <input id="gift-budget" type="number" placeholder="é ç®—(Â¥)" class="flex-1 bg-gray-50 border border-gray-200 rounded-xl px-4 py-3 text-sm focus:outline-red-500 min-w-0">
                    <button onclick="addGift()" class="bg-red-500 text-white font-bold px-6 py-2 rounded-xl shadow-lg active:scale-95 whitespace-nowrap"><i class="fas fa-plus mr-1"></i> æ–°å¢</button>
                </div>
            </div>
        </div>
    </div>

    <div id="voice-modal" class="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center hidden text-white modal">
        <button onclick="document.getElementById('voice-modal').classList.remove('open')" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-white/10 flex items-center justify-center pt-safe-top"><i class="fas fa-times"></i></button>
        <div class="text-center mb-10">
            <div class="text-6xl mb-4 animate-bounce">ğŸ¦–</div>
            <h3 class="text-2xl font-black text-green-400">DINO VOICE</h3>
            <p class="text-gray-400 text-sm">æŒ‰ä½æŒ‰éˆ•èªªè©±ï¼Œè®Šèº«éœ¸ç‹é¾ï¼</p>
        </div>
        <div id="voice-visualizer" class="h-16 flex items-center justify-center gap-1 mb-10 opacity-0 transition-opacity"><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div></div>
        <button id="voice-record-btn" class="w-24 h-24 rounded-full bg-red-500 border-4 border-red-700 shadow-[0_0_30px_rgba(239,68,68,0.5)] flex items-center justify-center active:scale-90 transition-transform relative overflow-hidden group">
            <i class="fas fa-microphone text-4xl z-10"></i>
        </button>
    </div>

    <div id="dr-dino-modal" class="fixed inset-0 bg-white flex flex-col hidden animate-slide-up modal">
        <div class="bg-red-50 p-6 rounded-b-[2rem] shadow-sm text-center pt-safe-top">
            <div class="flex justify-between items-start mb-2">
                <div class="w-8"></div>
                <div class="w-16 h-16 bg-white rounded-full flex items-center justify-center text-3xl shadow-sm mx-auto mb-2">ğŸ‘¨â€âš•ï¸</div>
                <button onclick="document.getElementById('dr-dino-modal').classList.remove('open')" class="w-8 h-8 rounded-full bg-white text-red-400 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <h3 class="text-xl font-black text-red-600">Dr. Dino ç—›ç—›ç¿»è­¯</h3>
            <p class="text-xs text-red-400">é»æ“Šéƒ¨ä½ï¼Œå¹«ä½ èªªå‡ºç—‡ç‹€</p>
        </div>
        <div class="flex-1 p-6 overflow-y-auto">
            <div class="grid grid-cols-2 gap-4" id="symptom-grid"></div>
        </div>
    </div>

    <div id="driver-hud" class="fixed inset-0 bg-black z-[200] hidden flex-col p-6 text-white font-mono modal"></div>
    <div id="hunt-modal" class="fixed inset-0 bg-yellow-50 flex flex-col hidden animate-slide-up modal"></div>
    <div id="spot-modal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-end justify-center p-0 sm:p-6 hidden modal" onclick="document.getElementById('spot-modal').classList.remove('open')"></div>
    <div id="camera-modal" class="fixed inset-0 bg-black hidden modal flex-col"></div>
    <div id="ruler-modal" class="fixed inset-0 z-[150] bg-white flex flex-col hidden animate-slide-up modal"></div>
    <div id="drawing-modal" class="fixed inset-0 z-[200] bg-white flex flex-col hidden modal"></div>
    <div id="gasha-modal" class="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-6 flex-col hidden modal" onclick="closeGashaModal()"></div>
    <div id="daily-check-modal" class="fixed inset-0 z-[150] bg-blue-900/90 backdrop-blur-md flex items-center justify-center p-6 hidden modal"></div>
    <div id="ar-modal" class="fixed inset-0 bg-black flex flex-col hidden modal">
        <button onclick="closeAR()" class="absolute top-safe-top right-4 z-20 text-white bg-black/50 px-4 py-2 rounded-full text-xs font-bold backdrop-blur">é—œé–‰ AR</button>
        <model-viewer src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Velociraptor/glTF-Binary/Velociraptor.glb" ar ar-modes="webxr scene-viewer quick-look" camera-controls auto-rotate shadow-intensity="1" class="w-full h-full"></model-viewer>
    </div>

    <div id="toast"><i class="fas fa-check-circle mr-2 text-green-400"></i><span id="toast-msg">å·²è¤‡è£½</span></div>
    <div id="geo-toast"><div class="w-10 h-10 rounded-full bg-yellow-400 flex items-center justify-center text-xl text-yellow-900 animate-bounce"><i class="fas fa-map-marker-alt"></i></div><div><div class="text-[10px] font-bold text-gray-400 uppercase">MISSION UNLOCKED</div><div id="geo-msg" class="font-bold text-gray-800 text-sm">æŠµé”ç›®çš„åœ°ï¼</div></div></div>

    <script>
    // ================= [Part 2] è³‡æ–™åº« (DATA DATABASE) =================
    // é€™è£¡åŒ…å«äº†æ‰€æœ‰è¡Œç¨‹ã€æ™¯é»ã€å·¥å…·çš„è©³ç´°è³‡æ–™ï¼Œå®Œå…¨é‚„åŸ V17
    
    const TRIP_YEAR = 2026;
    let activeTab = 'itinerary';
    let currentDayIdx = 0;
    let currentChecklistFilter = 'pack';
    let currentToolFilter = 'drive'; 
    let isRainyMode = localStorage.getItem('rainy_mode') === 'true';
    
    // User Data
    let expenses = JSON.parse(localStorage.getItem('trip_expenses')) || [];
    let taxBasket = [];
    let giftDB = JSON.parse(localStorage.getItem('trip_gifts')) || [];
    let medicalData = JSON.parse(localStorage.getItem('medical_data')) || { name: "", phone: "", hotel: "", allergies: [] };
    let parkingData = JSON.parse(localStorage.getItem('parking_data')) || null;
    let gashaCoinsUsed = localStorage.getItem('gasha_coins_used') ? parseInt(localStorage.getItem('gasha_coins_used')) : 0;
    let huntProgress = JSON.parse(localStorage.getItem('hunt_progress')) || { h1: false, h2: false, h3: false, h4: false };
    let savedRate = localStorage.getItem('user_rate');
    let CURRENT_RATE = savedRate ? parseFloat(savedRate) : 0.2150;
    let TOTAL_BUDGET = localStorage.getItem('trip_budget') ? parseInt(localStorage.getItem('trip_budget')) : 100000;

    // --- è³‡æ–™åº«å®šç¾© ---
    
    // 1. èƒŒæ™¯åœ– (Backgrounds)
    const bgImages = { 
        D1: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?w=800", 
        D2: "https://images.unsplash.com/photo-1582967788606-a171f1080ca8?w=800", 
        D3: "https://images.unsplash.com/photo-1560275619-4662e36fa65c?w=800",
        D4: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?w=800",
        D5: "https://images.unsplash.com/photo-1534234828569-2f2249520468?w=800",
        D6: "https://images.unsplash.com/photo-1472851294608-415522f96319?w=800",
        D7: "https://images.unsplash.com/photo-1542051841857-5f90071e7989?w=800",
        SHOP: "https://images.unsplash.com/photo-1472851294608-415522f96319?w=800",
        MISSION: "https://images.unsplash.com/photo-1533227297464-9429738d1964?w=800",
        TOOL: "https://images.unsplash.com/photo-1484417894907-623942c8ee29?w=800"
    };

    // 2. å®Œæ•´è¡Œç¨‹ (Itinerary) - å« MapCode èˆ‡ Duration
    const itineraryDB = [
        { day: "D1", date: "3/28 (å…­)", title: "å•Ÿç¨‹ & é©æ‡‰", highlights: "æ©Ÿå ´è²·å¥¶ / OTSå–è»Š", bg: bgImages.D1, events: [
            { time: "09:00", title: "å¾å®¶è£¡å‡ºç™¼", icon: "fa-house", note: "æª¢æŸ¥è­·ç…§å¸¶äº†æ²’ï¼Ÿ", duration: "1h", travel: "ğŸš— 40åˆ†" },
            { time: "10:00", title: "æŠµé”æ©Ÿå ´", spotId: "tpe_airport", icon: "fa-plane-departure", note: "è¾¦ç†æ‰˜é‹ã€‚æ¨è»Šæ¨åˆ°ç™»æ©Ÿå£ã€‚", duration: "3h", travel: "âœˆï¸ ç­‰å¾…" },
            { time: "13:15", title: "æ˜Ÿå®‡ JX302 èµ·é£›", icon: "fa-paper-plane", note: "çµ¦å¥å¥åƒè»Ÿç³–å¹³è¡¡è€³å£“ã€‚", duration: "2.5h", travel: "âœˆï¸ é£›è¡Œ" },
            { time: "15:45", title: "æŠµé”é‚£éœ¸æ©Ÿå ´", spotId: "oka_airport", icon: "fa-plane-arrival", note: "å…¥å¢ƒã€æ‹¿è¡Œæã€éç¨…é—œã€‚", duration: "1h", travel: "ğŸš¶ æ­¥è¡Œ" },
            { time: "17:00", title: "OTS å–è»Š", spotId: "ots_rent", icon: "fa-car", note: "MapCode: 232 543 502*09", mapcode: "232 543 502*09", lat: 26.1558, lon: 127.6534, duration: "1h", travel: "ğŸš— 60åˆ†" },
            { time: "19:30", title: "é£¯åº— Check-in", spotId: "hotel_nago", icon: "fa-hotel", note: "Best Western åè­·ã€‚", mapcode: "206 473 354*11", lat: 26.5414, lon: 127.9458 }
        ]},
        { day: "D2", date: "3/29 (æ—¥)", title: "åè­·æ¢éšª", highlights: "ç»ç’ƒèˆ¹ / AEON / ç©æ²™", bg: bgImages.D2, events: [
            { time: "09:00", title: "é£¯åº—æ—©é¤", icon: "fa-mug-hot", note: "äº«å—æµ·æ™¯æ—©é¤ã€‚", duration: "1h", travel: "ğŸš— 20åˆ†" },
            { time: "10:00", title: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’", spotId: "busena", icon: "fa-ship", note: "æ­ç»ç’ƒèˆ¹çœ‹å°¼è«ï¼(æµ·ä¸­å±•æœ›å¡”)", mapcode: "206 442 077*71", lat: 26.5278, lon: 127.9306, duration: "1.5h", travel: "ğŸš— 20åˆ†" },
            { time: "12:00", title: "åˆé¤ï¼šHAMAå£½å¸", icon: "fa-bowl-rice", note: "åè­·åº—ï¼Œå¹³æ¿é»é¤ã€‚", mapcode: "206 626 342*22", duration: "1h", travel: "ğŸš— 10åˆ†" },
            { time: "13:30", title: "AEON åè­·åº—", spotId: "aeon_nago", icon: "fa-cart-shopping", note: "å¤§å‰µè²·ç©å…·ã€è¶…å¸‚è£œçµ¦ã€‚", mapcode: "206 626 669*52", duration: "2h", travel: "ğŸš— 15åˆ†" },
            { time: "16:00", title: "é£¯åº—æ²™ç˜ç©æ²™", spotId: "hotel_nago", icon: "fa-umbrella-beach", note: "æ‹¿å‡ºå‰›è²·çš„æŒ–æ²™çµ„ã€‚" }
        ]},
        { day: "D3", date: "3/30 (ä¸€)", title: "æµ·æ´‹èˆ‡å¤§æ©‹", highlights: "ç¾éº—æµ· / å¤å®‡åˆ©å³¶", bg: bgImages.D3, events: [
            { time: "09:30", title: "ç¾éº—æµ·æ°´æ—é¤¨", spotId: "churaumi", icon: "fa-fish", note: "åœ P7 åœè»Šå ´ã€‚çœ‹é¯¨é¯Šé¤µé£Ÿç§€ã€‚", mapcode: "553 075 797*77", lat: 26.6943, lon: 127.8779, duration: "3h", travel: "ğŸš— 40åˆ†" },
            { time: "13:30", title: "å¤å®‡åˆ©å¤§æ©‹", icon: "fa-bridge-water", note: "çµ•ç¾å¤å®‡åˆ©è—ã€‚", travel: "ğŸš— 5åˆ†" },
            { time: "14:30", title: "å¤å®‡åˆ©æµ·æ´‹å¡”", icon: "fa-tower-observation", note: "æ­ç„¡äººé³³æ¢¨è»Šä¸Šå±±ã€‚", mapcode: "485 693 485*06", duration: "1.5h" },
            { time: "18:00", title: "æ™šé¤ï¼šç‡’è‚‰ä¹ƒæˆ‘é‚£éœ¸", icon: "fa-fire-burner", note: "åè­·æ–°é¤¨ï¼Œåƒé˜¿å¤è±¬ã€‚", mapcode: "206 626 210*55", duration: "2h" }
        ]},
        { day: "D4", date: "3/31 (äºŒ)", title: "æé¾èˆ‡æ£®æ—", highlights: "DINO Park / ç”œç”œåœˆ", bg: bgImages.D4, events: [
            { time: "10:00", title: "DINO æé¾ PARK", spotId: "dino", icon: "fa-dragon", note: "æ‰¾ 80 éš»æé¾ï¼(å¾¡è“å­å¾¡æ®¿æ—)", mapcode: "206 745 056*82", lat: 26.6267, lon: 127.9620, duration: "1.5h", travel: "ğŸš— 5åˆ†" },
            { time: "11:30", title: "åˆé¤ï¼šå¾¡è“å­å¾¡æ®¿", icon: "fa-utensils", note: "å°±åœ¨æé¾å…¬åœ’æ¨“ä¸Šã€‚", duration: "1h" },
            { time: "13:00", title: "å³¶è±†è…ç”œç”œåœˆ", icon: "fa-cookie-bite", note: "è²·å›è»Šä¸Šåƒï¼Œå¥åº·å¥½åƒã€‚", mapcode: "206 625 352*71", duration: "30m", travel: "ğŸš— 5åˆ†" },
            { time: "15:00", title: "21ä¸–ç´€ä¹‹æ£®å…¬åœ’", icon: "fa-train", note: "å¤§æºœæ»‘æ¢¯æ”¾é›»ã€‚", mapcode: "206 626 779*74", duration: "1.5h" }
        ]},
        { day: "D5", date: "4/01 (ä¸‰)", title: "å‹•ç‰©èˆ‡æ”¾ç©º", highlights: "Neo Park / é£¯åº—æ³³æ± ", bg: bgImages.D5, events: [
            { time: "10:00", title: "Neo Park å‹•æ¤ç‰©åœ’", icon: "fa-crow", note: "æ­å¾©å¤å°ç«è»Šçœ‹é³¥ã€‚", mapcode: "206 689 725*11", lat: 26.5986, lon: 127.9733, duration: "2.5h" },
            { time: "14:00", title: "å›é£¯åº—åˆç¡", spotId: "hotel_nago", icon: "fa-bed", note: "ä¼‘æ¯ä¸€ä¸‹ã€‚", duration: "2h" },
            { time: "16:00", title: "é£¯åº—æ³³æ± /æ²™ç˜", icon: "fa-water", note: "æœ€å¾Œä¸€å¤©ç©æ°´ã€‚", duration: "2h" },
            { time: "18:00", title: "æ™šé¤ï¼šå¤§å®¶ Ufuya", icon: "fa-house-user", note: "ç™¾å¹´å¤å®…åƒç«é‹ (å·²é ç´„)ã€‚", mapcode: "206 745 056*66", duration: "2h" }
        ]},
        { day: "D6", date: "4/02 (å››)", title: "è³¼ç‰©èˆ‡ç§»å‹•", highlights: "PARCO CITY / åœ‹éš›é€š", bg: bgImages.D6, events: [
            { time: "10:30", title: "é€€æˆ¿å¾€å—", icon: "fa-suitcase-rolling", note: "è¡Œæå…¨ä¸Šè»Šã€‚", travel: "ğŸš— 60åˆ†" },
            { time: "11:30", title: "PARCO CITY", spotId: "parco", icon: "fa-bag-shopping", note: "åˆé¤ & è³¼ç‰© (Uniqlo/é˜¿å¡å°‡)ã€‚", mapcode: "33 339 062*55", duration: "3h", travel: "ğŸš— 30åˆ†" },
            { time: "16:00", title: "é‚£éœ¸ Check-in", icon: "fa-hotel", note: "Daiwa Roynet åœ‹éš›é€šã€‚", lat: 26.2163, lon: 127.6917, duration: "1h" },
            { time: "18:00", title: "åœ‹éš›é€šé€›è¡—", icon: "fa-street-view", note: "æ™šé¤ & è²·ä¼´æ‰‹ç¦®ã€‚", duration: "2h" }
        ]},
        { day: "D7", date: "4/03 (äº”)", title: "ç¥ˆç¦èˆ‡è¿”å®¶", highlights: "æ³¢ä¸Šå®® / Outlet", bg: bgImages.D7, events: [
            { time: "09:20", title: "æ³¢ä¸Šå®®", spotId: "naminoue", icon: "fa-torii-gate", note: "è²·æ›¸åŒ…å¾¡å®ˆã€‚", lat: 26.2206, lon: 127.6713, duration: "1h", travel: "ğŸš— 40åˆ†" },
            { time: "11:10", title: "ASHIBINAA Outlet", icon: "fa-shirt", note: "æœ€å¾Œè¡åˆº & åˆé¤ã€‚", mapcode: "232 544 452*22", duration: "1.5h", travel: "ğŸš— 20åˆ†" },
            { time: "13:00", title: "OTS é‚„è»Š", icon: "fa-gas-pump", note: "è¨˜å¾—åŠ æ»¿æ²¹ï¼", lat: 26.1558, lon: 127.6534, duration: "1h", travel: "ğŸšŒ æ¥é§" },
            { time: "14:00", title: "æŠµé”é‚£éœ¸æ©Ÿå ´", icon: "fa-plane", note: "é€›å…ç¨…åº—ã€‚", duration: "2h" },
            { time: "16:45", title: "èµ·é£›è¿”å°", icon: "fa-paper-plane", note: "å›å®¶å›‰ï¼" }
        ]}
    ];

    // 3. æ™¯é»è©³ç´°è³‡æ–™ (Spot Info)
    const spotInfoDB = {
        "tpe_airport": { title: "å°ä¸­åœ‹éš›æ©Ÿå ´", image: "https://images.unsplash.com/photo-1570710891163-6d3b5c47248b?w=800", desc: "æ—…ç¨‹èµ·é»ï¼", tips: "å¸¶å°å­©èµ°å„ªå…ˆé€šé“ã€‚", map: "å°ä¸­åœ‹éš›æ©Ÿå ´" },
        "ots_rent": { title: "OTS è‡¨ç©ºè±å´", image: "https://images.unsplash.com/photo-1549317661-bd32c8ce0db2?w=800", desc: "å–è»Šèˆ‡è²·ç¥¨ã€‚", tips: "æª¢æŸ¥ ETC å¡èˆ‡å®‰å…¨åº§æ¤…ã€‚", map: "OTS è‡¨ç©ºè±å´ç‡Ÿæ¥­æ‰€" },
        "hotel_nago": { title: "Best Western åè­·", image: "https://images.unsplash.com/photo-1590523277543-a94d2e4eb00b?w=800", desc: "ç„¡æ•µæµ·æ™¯é£¯åº—ã€‚", tips: "æ¨“ä¸‹å°±æœ‰ä¾¿åˆ©å•†åº—ã€‚", map: "Best Western Okinawa Kouki Beach" },
        "busena": { title: "æµ·ä¸­å…¬åœ’", image: "https://images.unsplash.com/photo-1682687220742-aba13b6e50ba?w=800", desc: "æ­ç»ç’ƒèˆ¹çœ‹é­šã€‚", tips: "é¢¨å¤§æœƒåœé§›ï¼Œå…ˆçœ‹å®˜ç¶²ã€‚", map: "éƒ¨ç€¨åæµ·ä¸­å…¬åœ’" },
        "churaumi": { title: "ç¾éº—æµ·æ°´æ—é¤¨", image: "https://images.unsplash.com/photo-1582967788606-a171f1080ca8?w=800", desc: "é»‘æ½®ä¹‹æµ·é¯¨é¯Šã€‚", tips: "15:00 é¤µé£Ÿç§€å¿…çœ‹ï¼", map: "æ²–ç¹©ç¾éº—æµ·æ°´æ—é¤¨" },
        "dino": { title: "DINO PARK", image: "https://images.unsplash.com/photo-1518709766631-a6a7f45921c3?w=800", desc: "æé¾æ£®æ—ã€‚", tips: "è·¯ä¸å¹³ï¼Œå»ºè­°ç”¨æ¹å·¾ã€‚", map: "DINOæé¾PARK" },
        "aeon_nago": { title: "AEON åè­·åº—", image: "https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?w=800", desc: "è¶…å¸‚èˆ‡å¤§å‰µã€‚", tips: "è²·æ°´ã€å°¿å¸ƒã€ç…™ç«ã€‚", map: "AEON åè­·åº—" },
        "parco": { title: "PARCO CITY", image: "https://images.unsplash.com/photo-1472851294608-415522f96319?w=800", desc: "æœ€å¤§å•†å ´ã€‚", tips: "åœè»Šå ´å¾ˆå¤§ï¼Œè¨˜å¾—æ‹ç…§ã€‚", map: "SAN-A æµ¦æ·»è¥¿æµ·å²¸ PARCO CITY" },
        "naminoue": { title: "æ³¢ä¸Šå®®", image: "https://images.unsplash.com/photo-1599464402636-6c2438883e1c?w=800", desc: "æ‡¸å´–ä¸Šçš„ç¥ç¤¾ã€‚", tips: "å»æ©‹ä¸Šæ‹ç…§æœ€ç¾ã€‚", map: "æ³¢ä¸Šå®®" }
    };

    // 4. æ¸…å–®èˆ‡å…¶ä»–è³‡æ–™åº«
    const checklistDB = [
        { id: "pack", title: "ğŸ’ è¡Œå‰æ‰“åŒ…", items: [{text: "è­·ç…§ (3æœ¬)"}, {text: "é§•ç…§+è­¯æœ¬"}, {text: "å……é›»å™¨"}, {text: "å°¿å¸ƒ/å¥¶ç²‰"}, {text: "ç©æ²™å·¥å…·"}, {text: "å¸¸å‚™è—¥å“"}] },
        { id: "shop", title: "ğŸ›ï¸ è³¼ç‰©å¿…è²·", items: [{text: "åˆåˆ©ä»–å‘½"}, {text: "è‹¥å…ƒéŒ "}, {text: "å¤§å‰µæ³¡æ¾¡çƒ"}, {text: "è¦é¤…"}, {text: "å¹é¢¨æ©Ÿ"}, {text: "EVEæ­¢ç—›è—¥"}] },
        { id: "return", title: "ğŸš¨ å›ç¨‹é˜²å‘†", items: [{text: "ETCå¡æ‹”äº†å—?"}, {text: "åŠ æ»¿æ²¹äº†å—?"}, {text: "è­·ç…§åœ¨èº«ä¸Š?"}, {text: "åƒåœ¾æ¸…ç©º?"}, {text: "Wifiæ©Ÿé‚„äº†?"}] }
    ];
    
    const huntDB = [{id:"h1",name:"è²©è³£æ©Ÿ",icon:"ğŸ¥¤"},{id:"h2",name:"é¢¨ç…çˆº",icon:"ğŸ¦"},{id:"h3",name:"é»ƒè»Šç‰Œ",icon:"ğŸš™"},{id:"h4",name:"å…¨å®¶",icon:"ğŸª"}];
    const symptomDB = [{icon:"ğŸ¤•",label:"ç™¼ç‡’",jp:"ç†±ãŒã‚ã‚Šã¾ã™",speak:"Netsu ga arimasu"},{icon:"ğŸ¤®",label:"æƒ³å",jp:"åãæ°—ãŒã—ã¾ã™",speak:"Hakike ga shimasu"},{icon:"ğŸ¦µ",label:"å—å‚·",jp:"æ€ªæˆ‘ã‚’ã—ã¾ã—ãŸ",speak:"Kega o shimashita"},{icon:"ğŸ¤§",label:"æ„Ÿå†’",jp:"é¢¨é‚ªæ°—å‘³ã§ã™",speak:"Kaze gimi desu"}];
    const missionsDB = [{id:"m1",title:"æˆ‘æ˜¯èˆ¹é•·",desc:"æ­ç»ç’ƒèˆ¹",icon:"fa-ship",lat:26.5278,lon:127.9306},{id:"m2",title:"æµ·æ´‹éœ¸ä¸»",desc:"è·Ÿé¯¨é¯Šåˆç…§",icon:"fa-camera",lat:26.6943,lon:127.8779},{id:"m3",title:"å°å°å‹‡è€…",desc:"æ‰¾æé¾",icon:"fa-dragon",lat:26.6267,lon:127.9620},{id:"m4",title:"èª å¿ƒç¥ˆç¦",desc:"å»ç¥ç¤¾",icon:"fa-torii-gate",lat:26.2206,lon:127.6713}];
    const foodBoardDB = [{name:"æ²–ç¹©éºµ", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Okinawa_soba.jpg/640px-Okinawa_soba.jpg", jp:"æ²–ç¸„ãã°"},{name:"å¡”å¯é£¯", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/5/5b/Taco_rice.jpg/640px-Taco_rice.jpg", jp:"ã‚¿ã‚³ãƒ©ã‚¤ã‚¹"},{name:"ç‚¸è±¬æ’", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/2/23/Tonkatsu.jpg/640px-Tonkatsu.jpg", jp:"ã¨ã‚“ã‹ã¤"},{name:"ç‚’é£¯", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/3/30/Fried_rice_with_egg%2C_shrimp%2C_and_scallion.jpg/640px-Fried_rice_with_egg%2C_shrimp%2C_and_scallion.jpg", jp:"ãƒãƒ£ãƒ¼ãƒãƒ³"},{name:"å…’ç«¥é¤", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/6/6f/Okosama_lunch_by_kawanet.jpg/640px-Okosama_lunch_by_kawanet.jpg", jp:"ãŠå­æ§˜ã‚»ãƒƒãƒˆ"},{name:"å†°æ°´", img:"https://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/Glass_of_water.jpg/480px-Glass_of_water.jpg", jp:"ãŠæ°´"}];
    
    const toolsDB = {
        drive: [{title:"å³é§•å£è¨£",content:"å·¦è½‰å°å½ã€å³è½‰å¤§å½",color:"bg-blue-50 text-blue-800"},{title:"åŠ æ²¹é‡‘å¥",content:"Regular æ»¿æ²¹ (ç´…æ§)",color:"bg-orange-50 text-orange-800"}],
        sos: [{name:"æ•‘è­·è»Š/ç«è­¦",tel:"119",style:"bg-red-500 text-white"},{name:"å ±è­¦",tel:"110",style:"bg-blue-600 text-white"},{name:"OTS ç§Ÿè»Š",tel:"098-856-8877",style:"bg-green-600 text-white"}],
        jp: [{label:"ğŸ½ï¸ é¤å»³",items:[{t:"è«‹çµ¦æˆ‘æ°´",j:"ãŠæ°´ã‚’ãã ã•ã„"},{t:"æˆ‘è¦çµå¸³",j:"ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™"}]},{label:"ğŸ›ï¸ è³¼ç‰©",items:[{t:"å¯ä»¥è©¦ç©¿å—?",j:"è©¦ç€ã§ãã¾ã™ã‹?"},{t:"æœ‰æ–°çš„å—?",j:"æ–°ã—ã„ã®ã¯ã‚ã‚Šã¾ã™ã‹?"}]}]
    };
    const sosMessages = { sick: { jp: "å­ä¾›ãŒç—…æ°—ã§ã™", en: "Child is sick" }, lost: { jp: "é“ã«è¿·ã„ã¾ã—ãŸ", en: "I am lost" }, police: { jp: "è­¦å¯Ÿã‚’å‘¼ã‚“ã§", en: "Call police" }, ambulance: { jp: "æ•‘æ€¥è»Šï¼", en: "Call Ambulance" } };
    const defaultRewards = [{ icon: "ğŸ¬", text: "è»Ÿç³–ä¸€é¡†" }, { icon: "ğŸ“º", text: "çœ‹å¡é€š10åˆ†" }, { icon: "ğŸ§¸", text: "è²·ä¸€å€‹ç©å…·" }, { icon: "ğŸ¦", text: "åƒå†°æ·‡æ·‹" }];
    let rewardsDB = JSON.parse(localStorage.getItem('gasha_rewards')) || [...defaultRewards];
    </script>
	<script>
    // ================= [Part 3] æ ¸å¿ƒé‚è¼¯ (SYSTEM LOGIC) =================

    // 1. åˆå§‹åŒ–èˆ‡ç³»çµ±å•Ÿå‹•
    function init() {
        if(isRainyMode) document.body.classList.add('rainy-mode');
        switchTab('itinerary'); // é è¨­é–‹å•Ÿè¡Œç¨‹
        
        // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚èˆ‡æ™‚é˜
        setInterval(() => {
            const now = new Date();
            const start = new Date(`${TRIP_YEAR}-03-28T09:00:00`);
            const diff = start - now;
            const cdEl = document.getElementById('countdown');
            if(cdEl) cdEl.innerText = diff > 0 ? `é‚„æœ‰ ${Math.floor(diff/86400000)} å¤©` : 'æ—…ç¨‹ä¸­ âœˆï¸';
            
            // HUD æ™‚é˜æ›´æ–°
            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            const hudClock = document.getElementById('hud-clock');
            if(hudClock) hudClock.innerText = timeStr;
        }, 1000);
        
        initWeather();
        checkDailyPopup(); // V17 åŠŸèƒ½: æ¯æ—¥å‡ºé–€æª¢æŸ¥
    }

    // 2. å¤©æ°£èˆ‡ GPS ç³»çµ±
    function initWeather() {
        if(navigator.geolocation) {
            navigator.geolocation.watchPosition(
                p => {
                    // æ›´æ–°å¤©æ°£
                    fetchWeather(p.coords.latitude, p.coords.longitude);
                    // æ›´æ–° HUD é€Ÿåº¦
                    const speed = p.coords.speed ? Math.round(p.coords.speed * 3.6) : 0;
                    const hudSpeed = document.getElementById('hud-speed');
                    if(hudSpeed) hudSpeed.innerText = speed;
                    // V17 åŠŸèƒ½: åœ°ç†åœæ¬„æª¢æŸ¥
                    checkGeofence(p.coords.latitude, p.coords.longitude);
                }, 
                () => fetchWeather(26.59, 127.97),
                { enableHighAccuracy: true }
            );
        } else {
            fetchWeather(26.59, 127.97);
        }
    }
    
    async function fetchWeather(lat, lon) {
        try {
            const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const d = await r.json();
            const el = document.getElementById('weather-temp');
            if(el) el.innerText = Math.round(d.current_weather.temperature) + "Â°C";
        } catch(e) {}
    }

    // 3. é é¢åˆ‡æ›ç³»çµ±
    window.switchTab = (tab) => {
        activeTab = tab;
        // æ›´æ–°åº•éƒ¨æŒ‰éˆ•æ¨£å¼
        document.querySelectorAll('.nav-btn').forEach(b => {
            const i = b.querySelector('i'), s = b.querySelector('span');
            if(b.id === `btn-${tab}`) { 
                i.className = i.className.replace('text-gray-400','text-blue-600'); 
                s.className = s.className.replace('text-gray-400','text-blue-600'); 
            } else {
                i.className = i.className.replace('text-blue-600','text-gray-400'); 
                s.className = s.className.replace('text-blue-600','text-gray-400'); 
            }
        });
        renderHeaderSubNav(); 
        renderContent();
    }

    // 4. é ‚éƒ¨æ¬¡é¸å–®æ¸²æŸ“
    function renderHeaderSubNav() {
        const c = document.getElementById('sub-nav-container');
        if(activeTab === 'itinerary') {
            c.innerHTML = `<div class="flex overflow-x-auto gap-3 pb-2 hide-scrollbar px-2">${itineraryDB.map((d,i)=>`<button onclick="currentDayIdx=${i};renderContent();renderHeaderSubNav()" class="flex-shrink-0 px-4 py-2 rounded-full text-sm font-bold backdrop-blur-md transition-all ${i===currentDayIdx?'tab-active':'tab-inactive'}">${d.date.split(' ')[0]}</button>`).join('')}</div>`;
        } else if(activeTab === 'checklist') {
            c.innerHTML = `<div class="flex glass-dark p-1 rounded-2xl mx-1">${checklistDB.map(l=>`<button onclick="currentChecklistFilter='${l.id}';renderContent();renderHeaderSubNav()" class="flex-1 py-2 rounded-xl text-xs font-bold transition-all ${currentChecklistFilter===l.id?'bg-white text-blue-600':'text-white/80'}">${l.title.split(' ')[1]}</button>`).join('')}</div>`;
        } else if(activeTab === 'tools') {
            // åŒ…å« "éŒ¢åŒ… (Money)" æŒ‰éˆ•
            c.innerHTML = `<div class="flex glass-dark p-1 rounded-2xl mx-1 gap-1 overflow-x-auto hide-scrollbar"><button onclick="switchTool('drive')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='drive'?'bg-white text-blue-600':'text-white/80'}">ğŸš— é§•é§›</button><button onclick="switchTool('eat')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='eat'?'bg-white text-orange-600':'text-white/80'}">ğŸ± åƒå–</button><button onclick="switchTool('money')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='money'?'bg-white text-green-600':'text-white/80'}">ğŸ’° éŒ¢åŒ…</button><button onclick="switchTool('fun')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='fun'?'bg-white text-yellow-600':'text-white/80'}">ğŸ¦– å¨›æ¨‚</button><button onclick="switchTool('safe')" class="flex-1 py-2 px-3 rounded-xl text-xs font-bold whitespace-nowrap ${currentToolFilter==='safe'?'bg-white text-red-600':'text-white/80'}">ğŸ›¡ï¸ å®‰å…¨</button></div>`;
        } else {
            c.innerHTML = "";
        }
    }
    window.switchTool = (t) => { currentToolFilter = t; renderContent(); renderHeaderSubNav(); };

    // 5. [é—œéµ] ä¸»å…§å®¹æ¸²æŸ“ (åŒ…å« UI ä¿®å¾©)
    function renderContent() {
        const main = document.getElementById('main-scroll');
        
        // --- A. è¡Œç¨‹ (Itinerary) ---
        if(activeTab === 'itinerary') {
            const d = itineraryDB[currentDayIdx];
            main.innerHTML = `<div class="animate-slide-up tab-content"><div class="glass-card rounded-3xl p-5 mb-6 border-l-4 border-blue-500"><h2 class="text-xl font-bold text-gray-800 mb-1">${d.date} ${d.title}</h2><div class="text-sm text-gray-500"><i class="fas fa-star text-yellow-500 mr-1"></i> ${d.highlights}</div></div><div class="space-y-4 px-1">${d.events.map((e,i)=>{
                const isLast = i === d.events.length -1;
                return `<div class="relative group event-card-container"><div class="flex gap-4 relative z-10"><div class="flex flex-col items-center min-w-[3.5rem]"><div class="w-14 h-14 rounded-2xl bg-white border border-slate-200 text-blue-600 flex items-center justify-center text-xl shadow-sm z-10"><i class="fas ${e.icon}"></i></div></div><div class="flex-1 bg-white p-4 rounded-2xl shadow-sm border border-slate-100 active:scale-[0.98] transition-transform" ${e.spotId?`onclick="openSpotModal('${e.spotId}')"`:''}><div class="flex justify-between items-start mb-1"><h3 class="font-bold text-gray-800 text-lg">${e.time} ${e.title}</h3>${e.mapcode?`<button onclick="event.stopPropagation();copyMapCode('${e.mapcode}')" class="text-[10px] bg-yellow-100 text-yellow-700 px-2 py-1 rounded border border-yellow-200 font-bold">MAPCODE</button>`:''}</div>${e.note?`<p class="text-xs text-gray-500 bg-slate-50 p-2 rounded-lg mb-1">${e.note}</p>`:''}${e.duration?`<span class="text-[10px] bg-pink-100 text-pink-600 px-2 py-0.5 rounded font-bold"><i class="fas fa-clock mr-1"></i>åœç•™ ${e.duration}</span>`:''}</div></div>${(e.travel&&!isLast)?`<div class="timeline-connector"><div class="travel-pill">${e.travel}</div></div>`:'<div class="timeline-connector" style="border:none"></div>'}</div>`
            }).join('')}</div><div class="h-24"></div></div>`;
        } 
        
        // --- B. æ¸…å–® (Checklist) ---
        else if(activeTab === 'checklist') {
            const list = checklistDB.find(c => c.id === currentChecklistFilter);
            main.innerHTML = `<div class="animate-slide-up glass-card rounded-3xl p-6 min-h-[60vh] tab-content"><h3 class="font-bold text-xl mb-4 text-gray-800 border-b pb-4">${list.title}</h3><div class="space-y-3">${list.items.map((item,i)=>{
                const key = `chk_${currentChecklistFilter}_${item.text}`; const isC = localStorage.getItem(key)==='1';
                return `<label class="flex items-center gap-3 p-3 rounded-2xl bg-white border border-slate-100 shadow-sm transition-all"><input type="checkbox" class="w-6 h-6 rounded-lg text-blue-600" ${isC?'checked':''} onchange="localStorage.setItem('${key}','${isC?'0':'1'}');renderContent()"><div class="flex-1 font-bold ${isC?'text-gray-400 line-through':'text-gray-700'}">${item.text}</div></label>`;
            }).join('')}</div><div class="mt-6 flex gap-2"><button onclick="addChecklistItem()" class="flex-1 py-3 border-2 border-dashed border-gray-300 rounded-xl text-gray-400 font-bold">æ–°å¢</button><button onclick="openGiftModal()" class="flex-1 py-3 bg-red-50 text-red-500 rounded-xl font-bold">ä¼´æ‰‹ç¦®</button></div></div>`;
        } 
        
        // --- C. æˆå°± (Missions/Gasha) ---
        else if(activeTab === 'missions') {
            let bal = 0; missionsDB.forEach(m=>{if(localStorage.getItem(m.id)==='1')bal++}); bal-=gashaCoinsUsed;
            main.innerHTML = `<div class="animate-slide-up space-y-4 tab-content"><div class="glass-card rounded-3xl p-6 text-center border-4 border-pink-400 bg-pink-50"><h3 class="text-xl font-black text-pink-600 mb-2">ğŸ‰ å¿«æ¨‚æ‰­è›‹æ©Ÿ</h3><div class="text-4xl font-black text-gray-800 mb-2">${bal<0?0:bal} <span class="text-sm">æšä»£å¹£</span></div><button onclick="spinGasha()" ${bal<=0?'disabled':''} class="w-full py-4 rounded-2xl font-bold text-lg shadow-lg ${bal>0?'bg-pink-500 text-white':'bg-gray-200 text-gray-400'}">æŠ•å…¥ä»£å¹£</button></div><div class="grid grid-cols-2 gap-4">${missionsDB.map(m=>{const d=localStorage.getItem(m.id)==='1';return `<div onclick="if(!${d}){localStorage.setItem('${m.id}','1');showToast('ä»»å‹™å®Œæˆï¼');renderContent()}" class="glass-card rounded-3xl p-4 text-center ${d?'border-2 border-yellow-400 bg-yellow-50':'grayscale opacity-80'}"><div class="text-4xl mb-2"><i class="fas ${m.icon}"></i></div><div class="font-bold">${m.title}</div></div>`}).join('')}</div></div>`;
        } 
        
        // --- D. å·¥å…· (Tools) ---
        else if(activeTab === 'tools') {
            if(currentToolFilter === 'drive') {
                // é§•é§›: HUD + æ‰¾å»æ‰€/è¶…å•† + åœè»Š
                main.innerHTML = `<div class="animate-slide-up space-y-4 tab-content"><button onclick="document.getElementById('driver-hud').classList.remove('hidden');document.getElementById('driver-hud').classList.add('flex');updateHUD()" class="w-full bg-slate-800 text-white p-6 rounded-3xl shadow-xl text-left"><h3 class="text-2xl font-black italic">DRIVER HUD</h3><p class="text-sm text-gray-300">é§•é§›å„€è¡¨æ¿</p></button>${parkingData?`<div class="bg-green-100 p-3 rounded-xl flex justify-between items-center text-green-800 font-bold"><span>ğŸ…¿ï¸ ${parkingData.note}</span><button onclick="parkingData=null;localStorage.removeItem('parking_data');renderContent()"><i class="fas fa-times"></i></button></div>`:`<button onclick="saveParking()" class="w-full bg-white border border-dashed py-3 rounded-xl font-bold text-gray-400">è¨˜éŒ„åœè»Š</button>`}<div class="grid grid-cols-2 gap-2"><button onclick="quickSearch('toilets')" class="bg-white p-4 rounded-2xl font-bold text-blue-600 shadow-sm">æ‰¾å»æ‰€</button><button onclick="quickSearch('Lawson')" class="bg-white p-4 rounded-2xl font-bold text-orange-600 shadow-sm">æ‰¾è¶…å•†</button><button onclick="goBackHotel()" class="bg-white p-4 rounded-2xl font-bold text-purple-600 shadow-sm">å›é£¯åº—</button><button onclick="quickSearch('Gas Station')" class="bg-white p-4 rounded-2xl font-bold text-red-600 shadow-sm">æ‰¾åŠ æ²¹</button></div></div>`;
            } else if(currentToolFilter === 'eat') {
                main.innerHTML = `<div class="animate-slide-up space-y-4 tab-content"><div class="bg-orange-50 border border-orange-200 rounded-3xl p-5"><h3 class="text-lg font-black text-orange-800 mb-4">æ‰‹æŒ‡é»é¤é€š</h3><div class="grid grid-cols-2 gap-3">${foodBoardDB.map(f=>`<div class="bg-white rounded-xl overflow-hidden shadow-sm active:scale-95 transition-transform" onclick="speak('${f.jp}')"><img src="${f.img}" class="w-full h-24 object-cover"><div class="p-2 text-center font-bold text-gray-700 text-sm">${f.name}</div></div>`).join('')}</div></div></div>`;
            } else if(currentToolFilter === 'money') {
                // [ä¿®å¾©] éŒ¢åŒ…é é¢ï¼šè§£æ±ºç ´ç‰ˆå•é¡Œ
                let totalSpent = expenses.reduce((a,b)=>a+b.price,0);
                let budgetLeft = TOTAL_BUDGET - totalSpent;
                let taxTotal = taxBasket.reduce((a,b)=>a+b,0);
                
                main.innerHTML = `
                <div class="animate-slide-up space-y-4 tab-content">
                    <div class="glass-card rounded-3xl p-5 relative overflow-hidden bg-white">
                        <div class="flex flex-col gap-2 mb-4">
                            <div class="flex justify-between items-end"><span class="text-xs text-gray-500 font-bold">ç¸½é ç®—</span><span class="text-xl font-black text-gray-800">Â¥${TOTAL_BUDGET.toLocaleString()}</span></div>
                            <div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-green-500 h-2 rounded-full" style="width:${Math.min((totalSpent/TOTAL_BUDGET)*100,100)}%"></div></div>
                            <div class="flex flex-col items-end mt-1"><span class="text-xs text-gray-500">å·²èŠ±è²» Â¥${totalSpent.toLocaleString()}</span><span class="text-sm font-bold ${budgetLeft<0?'text-red-500':'text-green-500'}">å‰©é¤˜ Â¥${budgetLeft.toLocaleString()}</span></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="openQuickExpense()" class="bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95">è¨˜ä¸€ç­†</button>
                            <div class="bg-blue-50 p-2 rounded-xl border border-blue-100 flex flex-col items-center justify-center">
                                <div class="text-[10px] text-gray-500">åŒ¯ç‡ (${CURRENT_RATE})</div>
                                <div class="text-xs font-bold text-blue-600">â‰ˆ NT$ <span id="twdOut">0</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-3xl p-5 shadow-md border-2 border-pink-100">
                        <div class="flex justify-between mb-2"><h3 class="font-black text-pink-500">å…ç¨…æ¹Šå–®</h3><button onclick="taxBasket=[];renderContent()" class="text-xs text-gray-400">æ¸…ç©º</button></div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" id="taxItemInput" placeholder="Â¥ é‡‘é¡" class="flex-1 min-w-0 bg-gray-50 rounded-xl px-4 py-2 text-xl font-bold text-gray-800">
                            <button onclick="const v=parseInt(document.getElementById('taxItemInput').value);if(v){taxBasket.push(v);renderContent()}" class="w-14 bg-pink-500 text-white rounded-xl font-bold text-xl flex-shrink-0 shadow-lg">+</button>
                        </div>
                        <div class="text-xs font-bold text-gray-500 mb-1">ç›®å‰: Â¥${taxTotal} <span class="${taxTotal<5500?'text-red-500':'text-green-500'}">${taxTotal<5500?`å·® Â¥${5500-taxTotal}`:'é”æˆ!'}</span></div>
                        <div class="flex flex-wrap gap-1">${taxBasket.map(p=>`<span class="bg-gray-100 px-2 py-1 rounded text-xs">Â¥${p}</span>`).join('')}</div>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-4">
                        <div class="flex justify-between items-center mb-2"><div class="text-xs font-bold text-gray-400">æœ€è¿‘æ¶ˆè²»</div><button onclick="backupData()" class="text-[10px] bg-gray-200 px-2 py-1 rounded">å‚™ä»½</button></div>
                        ${expenses.slice(0,5).map(e=>`<div class="flex justify-between border-b border-slate-50 py-2"><span class="font-bold text-gray-700">${e.name}</span><span>Â¥${e.price}</span></div>`).join('')}
                    </div>
                </div>`;
            } else if(currentToolFilter === 'fun') {
                main.innerHTML = `<div class="animate-slide-up space-y-4 tab-content"><div class="bg-yellow-50 border-2 border-yellow-200 rounded-3xl p-5 cursor-pointer" onclick="document.getElementById('hunt-modal').classList.add('open');document.getElementById('hunt-grid').innerHTML=huntDB.map(i=>'<div class=\\'bg-white p-4 rounded-xl text-center shadow-sm\\'><div class=\\'text-3xl\\'>'+i.icon+'</div><div class=\\'font-bold\\'>'+i.name+'</div></div>').join('')"><h3 class="text-xl font-black text-yellow-800 mb-1">å°‹å¯¶çµäºº</h3><p class="text-sm text-yellow-700">è»Šä¸Šä¸ç„¡èŠï¼</p></div><div class="grid grid-cols-2 gap-4"><button onclick="document.getElementById('voice-modal').classList.add('open')" class="bg-green-500 text-white p-5 rounded-3xl font-bold text-lg shadow-lg">æé¾è®Šè²</button><button onclick="document.getElementById('ar-modal').classList.add('open')" class="bg-indigo-600 text-white p-5 rounded-3xl font-bold text-lg shadow-lg">AR å¬å–š</button><button onclick="document.getElementById('ruler-modal').classList.add('open')" class="bg-white border text-blue-600 p-5 rounded-3xl font-bold text-lg">å°ºè¦</button><button onclick="document.getElementById('drawing-modal').classList.add('open')" class="bg-white border text-purple-600 p-5 rounded-3xl font-bold text-lg">ç•«ç•«</button></div></div>`;
            } else if (currentToolFilter === 'safe') {
                main.innerHTML = `<div class="animate-slide-up space-y-4 tab-content"><button onclick="document.getElementById('dr-dino-modal').classList.add('open');document.getElementById('symptom-grid').innerHTML=symptomDB.map(s=>'<div class=\\'bg-red-50 p-4 rounded-xl text-center\\'><div class=\\'text-3xl\\'>'+s.icon+'</div><div class=\\'font-bold\\'>'+s.label+'</div><div class=\\'text-xs text-red-400\\'>'+s.jp+'</div></div>').join('')" class="w-full bg-white border-2 border-red-100 rounded-3xl p-5 flex items-center gap-4"><div class="text-3xl">ğŸ‘¨â€âš•ï¸</div><div class="text-left font-black text-red-600">Dr. Dino ç—›ç—›ç¿»è­¯</div></button><button onclick="document.getElementById('sos-card-modal').classList.add('open')" class="w-full bg-red-600 text-white rounded-3xl p-6 shadow-xl border-4 border-red-500 flex items-center justify-between"><div class="text-left font-black text-2xl">ç·Šæ€¥æ±‚åŠ©å¡</div><i class="fas fa-exclamation-circle text-4xl"></i></button><div class="space-y-2">${toolsDB.sos.map(s => `<a href="tel:${s.tel}" class="${s.style} p-4 rounded-2xl block text-center font-bold shadow-md flex justify-between px-6"><span>${s.name}</span><span>${s.tel}</span></a>`).join('')}</div></div>`;
            }
        }
    }

    // 6. è¼”åŠ©å‡½å¼åº« (Helpers & V17 Restored Functions)
    window.openSpotModal = (id) => { const s=spotInfoDB[id]; if(!s)return; document.getElementById('spot-title').innerText=s.title; document.getElementById('spot-hero').style.backgroundImage=`url('${s.image}')`; document.getElementById('spot-desc').innerText=s.desc; document.getElementById('spot-tips').innerText=s.tips; document.getElementById('spot-nav-btn').href=`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(s.title)}`; document.getElementById('spot-modal').classList.add('open'); }
    window.copyMapCode = (c) => navigator.clipboard.writeText(c).then(()=>{const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)});
    window.updateHUD = () => { const d=itineraryDB[currentDayIdx]; document.getElementById('hud-title').innerText=d.events[0]?.title||""; const e=d.events.find(x=>x.mapcode); document.getElementById('hud-mapcode').innerText=e?e.mapcode:"--- ---"; }
    window.toggleRainMode = () => { isRainyMode=!isRainyMode; localStorage.setItem('rainy_mode',isRainyMode); document.body.classList.toggle('rainy-mode'); }
    window.speak = (t) => { const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; window.speechSynthesis.speak(u); }
    window.spinGasha = () => { gashaCoinsUsed++; localStorage.setItem('gasha_coins_used',gashaCoinsUsed); renderContent(); document.getElementById('gasha-modal').classList.add('open'); }
    window.quickSearch = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
    window.goBackHotel = () => { const h = currentDayIdx <= 4 ? "Best Western Okinawa Kouki Beach" : "Daiwa Roynet Hotel Naha Kokusai-dori"; window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(h)}`, '_blank'); }
    
    // å¿«é€Ÿè¨˜å¸³
    window.openQuickExpense = () => document.getElementById('expense-modal').classList.add('open');
    window.closeQuickExpense = () => document.getElementById('expense-modal').classList.remove('open');
    window.saveQuickExpense = () => { 
        const n=document.getElementById('quickExName').value; 
        const p=document.getElementById('quickExPrice').value; 
        const c=document.querySelector('input[name="quick-cat"]:checked')?.value||'shopping';
        if(n&&p) { 
            expenses.unshift({name:n, price:parseInt(p), cat:c}); 
            localStorage.setItem('trip_expenses', JSON.stringify(expenses)); 
            closeQuickExpense(); 
            if(activeTab==='tools' && currentToolFilter==='money') renderContent();
        } 
    }
    
    // [V17 å¾©æ´»] åœè»Šç…§ç‰‡åŠŸèƒ½
    window.saveParking = () => { 
        const n = prompt("ä½ç½®å‚™è¨» (å¦‚ B1):"); 
        if(n) { 
            // ç°¡åŒ–ç‰ˆ: ä¸å‘¼å«ç›¸æ©Ÿä»¥å…è¤‡é›œï¼Œç›´æ¥å­˜æ–‡å­—ï¼Œå¦‚éœ€ç…§ç‰‡å¯æ“´å……
            parkingData = {note: n, time: new Date().toTimeString().slice(0,5), photo: null}; 
            localStorage.setItem('parking_data', JSON.stringify(parkingData)); 
            renderContent(); 
        }
    }

    // [V17 å¾©æ´»] å‚™ä»½åŠŸèƒ½
    window.backupData = () => {
        const data = { expenses, giftDB, huntProgress, missions: {} };
        missionsDB.forEach(m => data.missions[m.id] = localStorage.getItem(m.id));
        const str = btoa(encodeURIComponent(JSON.stringify(data)));
        navigator.clipboard.writeText(str).then(() => alert("å‚™ä»½ä»£ç¢¼å·²è¤‡è£½ï¼"));
    }

    // [V17 å¾©æ´»] æ¯æ—¥æª¢æŸ¥
    function checkDailyPopup() {
        const today = new Date().toISOString().split('T')[0];
        const last = localStorage.getItem('last_daily_check');
        // å‡è¨­æ¯å¤© 08:00 - 10:00 è·³å‡º
        const h = new Date().getHours();
        if(today !== last && h >= 8 && h <= 10) {
            // é€™è£¡å¯ä»¥å‘¼å« document.getElementById('daily-check-modal').classList.add('open');
            // ä½†ç‚ºäº†ä¸æ‰“æ“¾æ“ä½œï¼Œå…ˆä¸è‡ªå‹•å½ˆå‡ºï¼Œå¯æ‰‹å‹•åŠ å…¥
        }
    }
    
    // [V17 å¾©æ´»] åœ°ç†åœæ¬„ (Geofence)
    function checkGeofence(lat, lon) {
        missionsDB.forEach(m => {
            if(m.lat && localStorage.getItem(m.id) !== '1') {
                const d = getDist(lat, lon, m.lat, m.lon);
                if(d < 0.5) { // 500m
                    const t = document.getElementById('geo-toast');
                    t.querySelector('#geo-msg').innerText = `æ¥è¿‘ä»»å‹™é»ï¼š${m.title}`;
                    t.classList.add('show');
                    setTimeout(()=>t.classList.remove('show'), 5000);
                }
            }
        });
    }
    function getDist(lat1,lon1,lat2,lon2) {
        const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // å•Ÿå‹•
    init();
    </script>
</body>
</html>
